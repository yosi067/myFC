import{N as j,K as H,D as K,C as v}from"./nes-core-CrIEL_gQ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(a){if(a.ep)return;a.ep=!0;const c=s(a);fetch(a.href,c)}})();let d=null,E=null,T=null,w=null,R=null,p=null,k=!1,D=null,S=null,C=null;const N=4096;function X(){if(D=document.getElementById("rom-selector"),S=document.getElementById("gameboy-shell"),C=document.getElementById("power-led"),T=document.getElementById("screen"),!T){console.error("æ‰¾ä¸åˆ°ç•«å¸ƒå…ƒç´ ");return}if(w=T.getContext("2d"),!w){console.error("ç„¡æ³•å–å¾— Canvas 2D ä¸Šä¸‹æ–‡");return}R=w.createImageData(256,240),d=new j,new H(d.controller1,K).bind(),J(d.controller1),te(),Y(),ne(),console.log("H5-NES æ¨¡æ“¬å™¨å·²åˆå§‹åŒ–")}function Y(){Z(),document.getElementById("rom-file-input")?.addEventListener("change",async t=>{const s=t.target.files?.[0];s&&await P(s)})}async function Z(){const e=document.getElementById("rom-list");if(e)try{const s=await fetch("./roms.json");if(!s.ok)throw new Error("ç„¡æ³•è¼‰å…¥ ROM åˆ—è¡¨");const n=await s.json();z(n.roms)}catch(t){console.error("è¼‰å…¥ ROM åˆ—è¡¨å¤±æ•—:",t),e.innerHTML=`
      <div class="rom-error">
        <p>âš ï¸ ç„¡æ³•è¼‰å…¥éŠæˆ²åˆ—è¡¨</p>
        <p>è«‹ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•é¸æ“‡ ROM æª”æ¡ˆ</p>
      </div>
    `}}function z(e){const t=document.getElementById("rom-list");if(!t)return;if(e.length===0){t.innerHTML='<div class="rom-empty">æ²’æœ‰å¯ç”¨çš„éŠæˆ²</div>';return}t.innerHTML=e.map((n,a)=>`
    <button class="rom-item" data-index="${a}" data-file="${encodeURIComponent(n.file)}">
      <span class="rom-icon">ğŸ®</span>
      <span class="rom-name">${n.name}</span>
      <span class="rom-arrow">â–¶</span>
    </button>
  `).join(""),t.querySelectorAll(".rom-item").forEach(n=>{n.addEventListener("click",async()=>{const a=decodeURIComponent(n.dataset.file||"");a&&await G(a)})})}async function G(e){try{const s=await fetch(`./roms/${encodeURIComponent(e)}`);if(!s.ok)throw new Error(`ç„¡æ³•è¼‰å…¥ ROM: ${e}`);const n=await s.arrayBuffer();_(n)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}async function P(e){try{const t=await e.arrayBuffer();_(t)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}function _(e){d&&(d.loadRom(e)?(console.log("ROM è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åŸ·è¡Œ"),V(),p&&(d.setAudioSampleRate(p.sampleRate),M()),C?.classList.add("on"),U()):(console.error("ROM è¼‰å…¥å¤±æ•—"),alert("ç„¡æ³•è¼‰å…¥æ­¤ ROM æª”æ¡ˆ")))}function V(){D&&(D.style.display="none"),S&&(S.style.display="flex")}function O(){$(),C?.classList.remove("on"),D&&(D.style.display="flex"),S&&(S.style.display="none")}const g=new Map;let I={up:!1,down:!1,left:!1,right:!1};function J(e){Q(e),W(e),ee(e),document.getElementById("virtual-controller")?.addEventListener("touchmove",s=>{s.preventDefault()},{passive:!1})}function Q(e){const t=document.getElementById("dpad-touch-area"),s=document.getElementById("dpad");if(!t||!s)return;const n=l=>{const r=s.getBoundingClientRect(),u=r.left+r.width/2,y=r.top+r.height/2,f=l.clientX-u,m=l.clientY-y,L=Math.sqrt(f*f+m*m),B=r.width/2*.15,i={up:!1,down:!1,left:!1,right:!1};if(L>B){const o=Math.atan2(m,f)*180/Math.PI;o>=-22.5&&o<22.5?i.right=!0:o>=22.5&&o<67.5?(i.right=!0,i.down=!0):o>=67.5&&o<112.5?i.down=!0:o>=112.5&&o<157.5?(i.left=!0,i.down=!0):o>=157.5||o<-157.5?i.left=!0:o>=-157.5&&o<-112.5?(i.left=!0,i.up=!0):o>=-112.5&&o<-67.5?i.up=!0:o>=-67.5&&o<-22.5&&(i.right=!0,i.up=!0)}F(e,i)},a=()=>{F(e,{up:!1,down:!1,left:!1,right:!1})};t.addEventListener("touchstart",l=>{l.preventDefault();for(const r of Array.from(l.changedTouches))g.set(r.identifier,{identifier:r.identifier,element:"dpad"}),n(r)},{passive:!1}),t.addEventListener("touchmove",l=>{l.preventDefault();for(const r of Array.from(l.changedTouches))g.get(r.identifier)?.element==="dpad"&&n(r)},{passive:!1}),t.addEventListener("touchend",l=>{l.preventDefault();for(const r of Array.from(l.changedTouches))g.get(r.identifier)?.element==="dpad"&&(g.delete(r.identifier),Array.from(g.values()).filter(y=>y.element==="dpad").length===0&&a())},{passive:!1}),t.addEventListener("touchcancel",l=>{l.preventDefault();for(const r of Array.from(l.changedTouches))g.delete(r.identifier);a()},{passive:!1});let c=!1;t.addEventListener("mousedown",l=>{l.preventDefault(),c=!0;const r=s.getBoundingClientRect(),u=r.left+r.width/2,y=r.top+r.height/2,f=l.clientX-u,m=l.clientY-y,L=Math.sqrt(f*f+m*m),B=r.width/2*.15,i={up:!1,down:!1,left:!1,right:!1};if(L>B){const o=Math.atan2(m,f)*180/Math.PI;o>=-22.5&&o<22.5?i.right=!0:o>=22.5&&o<67.5?(i.right=!0,i.down=!0):o>=67.5&&o<112.5?i.down=!0:o>=112.5&&o<157.5?(i.left=!0,i.down=!0):o>=157.5||o<-157.5?i.left=!0:o>=-157.5&&o<-112.5?(i.left=!0,i.up=!0):o>=-112.5&&o<-67.5?i.up=!0:o>=-67.5&&o<-22.5&&(i.right=!0,i.up=!0)}F(e,i)}),document.addEventListener("mousemove",l=>{if(!c)return;const r=s.getBoundingClientRect(),u=r.left+r.width/2,y=r.top+r.height/2,f=l.clientX-u,m=l.clientY-y,L=Math.sqrt(f*f+m*m),x=r.width/2,B=x*.15,i={up:!1,down:!1,left:!1,right:!1};if(L>B&&L<x*1.5){const o=Math.atan2(m,f)*180/Math.PI;o>=-22.5&&o<22.5?i.right=!0:o>=22.5&&o<67.5?(i.right=!0,i.down=!0):o>=67.5&&o<112.5?i.down=!0:o>=112.5&&o<157.5?(i.left=!0,i.down=!0):o>=157.5||o<-157.5?i.left=!0:o>=-157.5&&o<-112.5?(i.left=!0,i.up=!0):o>=-112.5&&o<-67.5?i.up=!0:o>=-67.5&&o<-22.5&&(i.right=!0,i.up=!0)}F(e,i)}),document.addEventListener("mouseup",()=>{c&&(c=!1,a())})}function F(e,t){t.up!==I.up&&e.setButton(v.Up,t.up),t.down!==I.down&&e.setButton(v.Down,t.down),t.left!==I.left&&e.setButton(v.Left,t.left),t.right!==I.right&&e.setButton(v.Right,t.right),document.getElementById("dpad-up")?.classList.toggle("pressed",t.up),document.getElementById("dpad-down")?.classList.toggle("pressed",t.down),document.getElementById("dpad-left")?.classList.toggle("pressed",t.left),document.getElementById("dpad-right")?.classList.toggle("pressed",t.right),I={...t}}function W(e){const t=document.getElementById("btn-a"),s=document.getElementById("btn-b"),n=(a,c,l)=>{a&&(a.addEventListener("touchstart",r=>{r.preventDefault(),r.stopPropagation();for(const u of Array.from(r.changedTouches))g.set(u.identifier,{identifier:u.identifier,element:l});e.setButton(c,!0),a.classList.add("pressed")},{passive:!1}),a.addEventListener("touchend",r=>{r.preventDefault(),r.stopPropagation();for(const u of Array.from(r.changedTouches))g.delete(u.identifier);e.setButton(c,!1),a.classList.remove("pressed")},{passive:!1}),a.addEventListener("touchcancel",r=>{r.preventDefault();for(const u of Array.from(r.changedTouches))g.delete(u.identifier);e.setButton(c,!1),a.classList.remove("pressed")},{passive:!1}),a.addEventListener("mousedown",r=>{r.preventDefault(),e.setButton(c,!0),a.classList.add("pressed")}),a.addEventListener("mouseup",r=>{r.preventDefault(),e.setButton(c,!1),a.classList.remove("pressed")}),a.addEventListener("mouseleave",()=>{e.setButton(c,!1),a.classList.remove("pressed")}))};n(t,v.A,"a"),n(s,v.B,"b")}function ee(e){document.querySelectorAll('[data-btn="select"], [data-btn="start"]').forEach(s=>{const n=s,c=n.dataset.btn==="start"?v.Start:v.Select;n.addEventListener("touchstart",l=>{l.preventDefault(),e.setButton(c,!0),n.classList.add("pressed")},{passive:!1}),n.addEventListener("touchend",l=>{l.preventDefault(),e.setButton(c,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("touchcancel",l=>{l.preventDefault(),e.setButton(c,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("mousedown",l=>{l.preventDefault(),e.setButton(c,!0),n.classList.add("pressed")}),n.addEventListener("mouseup",l=>{l.preventDefault(),e.setButton(c,!1),n.classList.remove("pressed")}),n.addEventListener("mouseleave",()=>{e.setButton(c,!1),n.classList.remove("pressed")})})}function te(){document.getElementById("btn-pause")?.addEventListener("click",$),document.getElementById("btn-resume")?.addEventListener("click",U),document.getElementById("btn-reset")?.addEventListener("click",()=>d?.reset()),document.getElementById("btn-select-game")?.addEventListener("click",O),document.getElementById("btn-save-state")?.addEventListener("click",()=>{A(0)?h("âœ… å­˜æª”æˆåŠŸ"):h("âŒ å­˜æª”å¤±æ•—")}),document.getElementById("btn-load-state")?.addEventListener("click",()=>{b(0)?h("âœ… è®€å–æˆåŠŸ"):h("âŒ æ²’æœ‰å­˜æª”")}),document.getElementById("mobile-save-state")?.addEventListener("click",()=>{A(0)?h("âœ… å­˜æª”æˆåŠŸ"):h("âŒ å­˜æª”å¤±æ•—")}),document.getElementById("mobile-load-state")?.addEventListener("click",()=>{b(0)?h("âœ… è®€å–æˆåŠŸ"):h("âŒ æ²’æœ‰å­˜æª”")})}function ne(){document.getElementById("rom-input")?.addEventListener("change",async t=>{const n=t.target.files?.[0];n&&await P(n)})}function U(){E!==null&&cancelAnimationFrame(E),k=!0;const e=1e3/60.0988;let t=performance.now(),s=0;const n=a=>{if(!d||!w||!R||!k)return;const c=a-t;for(t=a,s+=c,s>e*3&&(s=e);s>=e;)d.frame(),s-=e;se(),E=requestAnimationFrame(n)};E=requestAnimationFrame(n)}function $(){k=!1,E!==null&&(cancelAnimationFrame(E),E=null)}function se(){if(!d||!w||!R)return;const e=d.getFrameBuffer(),t=R.data;for(let s=0;s<256*240;s++){const n=e[s],a=s*4;t[a+0]=n>>16&255,t[a+1]=n>>8&255,t[a+2]=n&255,t[a+3]=255}w.putImageData(R,0,0)}async function oe(){try{p=new AudioContext({sampleRate:44100}),d&&d.setAudioSampleRate(p.sampleRate);const e=p.createScriptProcessor(N,0,1);e.onaudioprocess=t=>{const s=t.outputBuffer.getChannelData(0);d&&k?d.readAudioSamples(s)===0&&s.fill(0):s.fill(0)},e.connect(p.destination),console.log("éŸ³é »ç³»çµ±å·²åˆå§‹åŒ–ï¼Œå–æ¨£ç‡:",p.sampleRate)}catch(e){console.error("éŸ³é »åˆå§‹åŒ–å¤±æ•—:",e)}}function M(){p&&p.state==="suspended"&&p.resume()}const q="nes_savestate_";function h(e){const t=document.querySelector(".toast-message");t&&t.remove();const s=document.createElement("div");if(s.className="toast-message",s.textContent=e,s.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    animation: toastFade 1.5s ease-out forwards;
  `,!document.querySelector("#toast-style")){const n=document.createElement("style");n.id="toast-style",n.textContent=`
      @keyframes toastFade {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      }
    `,document.head.appendChild(n)}document.body.appendChild(s),setTimeout(()=>s.remove(),1500)}function A(e=0){if(!d)return!1;try{const t=d.exportSaveState(),s=`${q}${e}`;return localStorage.setItem(s,t),console.log(`å­˜æª”æˆåŠŸ (Slot ${e})`),!0}catch(t){return console.error("å­˜æª”å¤±æ•—:",t),!1}}function b(e=0){if(!d)return!1;try{const t=`${q}${e}`,s=localStorage.getItem(t);if(!s)return console.log(`Slot ${e} æ²’æœ‰å­˜æª”`),!1;const n=d.importSaveState(s);return n&&console.log(`è®€å–å­˜æª”æˆåŠŸ (Slot ${e})`),n}catch(t){return console.error("è®€å–å­˜æª”å¤±æ•—:",t),!1}}function ae(){if(!d)return;const e=d.exportSaveState(),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=`nes_savestate_${Date.now()}.json`,n.click(),URL.revokeObjectURL(s)}function re(){document.addEventListener("keydown",e=>{if(e.key==="F5"&&(e.preventDefault(),A(0)),e.key==="F7"&&(e.preventDefault(),b(0)),e.key>="F1"&&e.key<="F4"&&e.shiftKey){e.preventDefault();const t=parseInt(e.key[1]);A(t)}if(e.key>="1"&&e.key<="4"&&e.ctrlKey){e.preventDefault();const t=parseInt(e.key);b(t)}e.key==="Escape"&&O()})}window.nes=null;window.startEmulation=U;window.stopEmulation=$;window.saveState=A;window.loadState=b;window.exportSaveToFile=ae;window.showRomSelector=O;document.addEventListener("DOMContentLoaded",async()=>{X(),await oe(),re(),window.nes=d,document.addEventListener("click",M,{once:!0}),document.addEventListener("keydown",M,{once:!0}),document.addEventListener("touchstart",M,{once:!0})});
//# sourceMappingURL=index-B9UEh5mJ.js.map
