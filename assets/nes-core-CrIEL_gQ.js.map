{"version":3,"file":"nes-core-CrIEL_gQ.js","sources":["../../src/core/cpu/cpu.ts","../../src/core/ppu/ppu.ts","../../src/core/apu/tables.ts","../../src/core/apu/channels/envelope.ts","../../src/core/apu/channels/length-counter.ts","../../src/core/apu/channels/sweep.ts","../../src/core/apu/channels/pulse.ts","../../src/core/apu/channels/triangle.ts","../../src/core/apu/channels/noise.ts","../../src/core/apu/channels/dmc.ts","../../src/core/apu/frame-counter.ts","../../src/core/apu/apu.ts","../../src/core/bus.ts","../../src/mappers/index.ts","../../src/core/cartridge.ts","../../src/core/controller.ts","../../src/core/nes.ts"],"sourcesContent":["/**\n * NES 6502 CPU 模擬器\n * \n * 6502 是一個 8 位元處理器，具有：\n * - 8 位元資料匯流排\n * - 16 位元位址匯流排 (可定址 64KB)\n * - 3 個通用暫存器: A (累加器), X, Y\n * - 堆疊指標 SP (指向 $0100-$01FF)\n * - 程式計數器 PC (16 位元)\n * - 狀態暫存器 P (8 個旗標位元)\n */\n\nimport type { Bus } from '../bus';\n\n/**\n * CPU 狀態旗標\n * 使用位元遮罩表示各旗標在狀態暫存器中的位置\n */\nexport enum CpuFlags {\n  /** 進位旗標 (Carry) - bit 0 */\n  C = 1 << 0,\n  /** 零旗標 (Zero) - bit 1 */\n  Z = 1 << 1,\n  /** 中斷禁用 (Interrupt Disable) - bit 2 */\n  I = 1 << 2,\n  /** 十進位模式 (Decimal) - bit 3，NES 不使用 */\n  D = 1 << 3,\n  /** Break 指令 (Break) - bit 4 */\n  B = 1 << 4,\n  /** 未使用 - bit 5，永遠為 1 */\n  U = 1 << 5,\n  /** 溢位旗標 (Overflow) - bit 6 */\n  V = 1 << 6,\n  /** 負數旗標 (Negative) - bit 7 */\n  N = 1 << 7,\n}\n\n/**\n * 定址模式枚舉\n * 6502 支援多種定址模式來存取記憶體\n */\nexport enum AddressingMode {\n  /** 隱含定址 - 操作數隱含在指令中 */\n  Implicit,\n  /** 累加器定址 - 操作數是 A 暫存器 */\n  Accumulator,\n  /** 立即定址 - 操作數直接跟在指令後 */\n  Immediate,\n  /** 零頁定址 - 8 位元位址，存取 $0000-$00FF */\n  ZeroPage,\n  /** 零頁 X 索引 - 零頁位址加上 X 暫存器 */\n  ZeroPageX,\n  /** 零頁 Y 索引 - 零頁位址加上 Y 暫存器 */\n  ZeroPageY,\n  /** 相對定址 - 用於分支指令，8 位元有號偏移 */\n  Relative,\n  /** 絕對定址 - 完整 16 位元位址 */\n  Absolute,\n  /** 絕對 X 索引 - 絕對位址加上 X */\n  AbsoluteX,\n  /** 絕對 Y 索引 - 絕對位址加上 Y */\n  AbsoluteY,\n  /** 間接定址 - 用於 JMP，從位址讀取目標位址 */\n  Indirect,\n  /** 索引間接 (X) - (零頁位址 + X) 指向的位址 */\n  IndexedIndirectX,\n  /** 間接索引 (Y) - 零頁位址指向的位址 + Y */\n  IndirectIndexedY,\n}\n\n/**\n * 指令資訊結構\n */\ninterface Instruction {\n  /** 指令助記符 */\n  name: string;\n  /** 執行函數 */\n  execute: () => void;\n  /** 定址模式 */\n  mode: AddressingMode;\n  /** 基本週期數 */\n  cycles: number;\n}\n\n/**\n * 6502 CPU 類別\n */\nexport class Cpu {\n  // ===== 暫存器 =====\n  /** 累加器 (Accumulator) */\n  public a: number = 0x00;\n  /** X 索引暫存器 */\n  public x: number = 0x00;\n  /** Y 索引暫存器 */\n  public y: number = 0x00;\n  /** 堆疊指標 (Stack Pointer)，指向 $0100-$01FF */\n  public sp: number = 0xFD;\n  /** 程式計數器 (Program Counter) */\n  public pc: number = 0x0000;\n  /** 狀態暫存器 (Status Register) */\n  public status: number = 0x24; // U 旗標預設為 1\n\n  // ===== 內部狀態 =====\n  /** 剩餘週期數 */\n  private cycles: number = 0;\n  /** 當前操作數的位址 */\n  private absoluteAddress: number = 0x0000;\n  /** 相對定址偏移量 */\n  private relativeAddress: number = 0x0000;\n  /** 當前操作碼 */\n  private opcode: number = 0x00;\n  /** 取得的資料 */\n  private fetchedData: number = 0x00;\n\n  /** 記憶體匯流排參考 */\n  private bus: Bus;\n\n  /** 指令查找表 */\n  private instructions: Instruction[];\n\n  /** 總執行週期數 (用於除錯) */\n  public totalCycles: number = 0;\n\n  constructor(bus: Bus) {\n    this.bus = bus;\n    this.instructions = this.buildInstructionTable();\n  }\n\n  // ===== 旗標操作方法 =====\n\n  /** 取得指定旗標的值 */\n  public getFlag(flag: CpuFlags): boolean {\n    return (this.status & flag) !== 0;\n  }\n\n  /** 設定指定旗標 */\n  public setFlag(flag: CpuFlags, value: boolean): void {\n    if (value) {\n      this.status |= flag;\n    } else {\n      this.status &= ~flag;\n    }\n  }\n\n  // ===== 記憶體存取 =====\n\n  /** 從記憶體讀取一個位元組 */\n  private read(address: number): number {\n    return this.bus.cpuRead(address & 0xFFFF);\n  }\n\n  /** 寫入一個位元組到記憶體 */\n  private write(address: number, data: number): void {\n    this.bus.cpuWrite(address & 0xFFFF, data & 0xFF);\n  }\n\n  // ===== 堆疊操作 =====\n\n  /** 推送一個位元組到堆疊 */\n  private pushStack(data: number): void {\n    this.write(0x0100 + this.sp, data);\n    this.sp = (this.sp - 1) & 0xFF;\n  }\n\n  /** 從堆疊彈出一個位元組 */\n  private popStack(): number {\n    this.sp = (this.sp + 1) & 0xFF;\n    return this.read(0x0100 + this.sp);\n  }\n\n  /** 推送 16 位元值到堆疊 (高位元組先) */\n  private pushStack16(data: number): void {\n    this.pushStack((data >> 8) & 0xFF);\n    this.pushStack(data & 0xFF);\n  }\n\n  /** 從堆疊彈出 16 位元值 */\n  private popStack16(): number {\n    const lo = this.popStack();\n    const hi = this.popStack();\n    return (hi << 8) | lo;\n  }\n\n  // ===== CPU 控制方法 =====\n\n  /**\n   * 重置 CPU\n   * 讀取 $FFFC-$FFFD 的重置向量作為新的 PC\n   */\n  public reset(): void {\n    // 讀取重置向量\n    const lo = this.read(0xFFFC);\n    const hi = this.read(0xFFFD);\n    this.pc = (hi << 8) | lo;\n\n    // 重置暫存器\n    this.a = 0;\n    this.x = 0;\n    this.y = 0;\n    this.sp = 0xFD;\n    this.status = 0x24; // U 旗標設為 1\n\n    // 重置需要 8 個週期\n    this.cycles = 8;\n    this.totalCycles = 0;\n  }\n\n  /**\n   * 中斷請求 (IRQ)\n   * 僅在 I 旗標未設定時觸發\n   */\n  public irq(): void {\n    if (!this.getFlag(CpuFlags.I)) {\n      // 儲存 PC 和狀態\n      this.pushStack16(this.pc);\n      this.setFlag(CpuFlags.B, false);\n      this.setFlag(CpuFlags.U, true);\n      this.pushStack(this.status);\n      this.setFlag(CpuFlags.I, true);\n\n      // 讀取 IRQ 向量\n      const lo = this.read(0xFFFE);\n      const hi = this.read(0xFFFF);\n      this.pc = (hi << 8) | lo;\n\n      this.cycles = 7;\n    }\n  }\n\n  /**\n   * 非遮蔽中斷 (NMI)\n   * 無法被禁用，PPU VBlank 時觸發\n   */\n  public nmi(): void {\n    // 儲存 PC 和狀態\n    this.pushStack16(this.pc);\n    this.setFlag(CpuFlags.B, false);\n    this.setFlag(CpuFlags.U, true);\n    this.pushStack(this.status);\n    this.setFlag(CpuFlags.I, true);\n\n    // 讀取 NMI 向量\n    const lo = this.read(0xFFFA);\n    const hi = this.read(0xFFFB);\n    this.pc = (hi << 8) | lo;\n\n    this.cycles = 8;\n  }\n\n  /**\n   * 執行一個時鐘週期\n   * @returns 是否完成一條指令\n   */\n  public clock(): boolean {\n    if (this.cycles === 0) {\n      // 讀取下一個操作碼\n      this.opcode = this.read(this.pc);\n      this.pc = (this.pc + 1) & 0xFFFF;\n\n      // 確保 U 旗標永遠為 1\n      this.setFlag(CpuFlags.U, true);\n\n      // 取得指令資訊\n      const instruction = this.instructions[this.opcode];\n      this.cycles = instruction.cycles;\n\n      // 執行定址模式\n      this.executeAddressingMode(instruction.mode);\n      \n      // 執行指令\n      instruction.execute.call(this);\n\n      // 確保 U 旗標永遠為 1\n      this.setFlag(CpuFlags.U, true);\n\n      this.totalCycles += this.cycles;\n      return true;\n    }\n\n    this.cycles--;\n    return false;\n  }\n\n  /**\n   * 執行一條完整指令\n   */\n  public step(): number {\n    const startCycles = this.totalCycles;\n    do {\n      this.clock();\n    } while (this.cycles > 0);\n    return this.totalCycles - startCycles;\n  }\n\n  // ===== 定址模式實作 =====\n\n  private executeAddressingMode(mode: AddressingMode): number {\n    switch (mode) {\n      case AddressingMode.Implicit:\n        return this.addrImplicit();\n      case AddressingMode.Accumulator:\n        return this.addrAccumulator();\n      case AddressingMode.Immediate:\n        return this.addrImmediate();\n      case AddressingMode.ZeroPage:\n        return this.addrZeroPage();\n      case AddressingMode.ZeroPageX:\n        return this.addrZeroPageX();\n      case AddressingMode.ZeroPageY:\n        return this.addrZeroPageY();\n      case AddressingMode.Relative:\n        return this.addrRelative();\n      case AddressingMode.Absolute:\n        return this.addrAbsolute();\n      case AddressingMode.AbsoluteX:\n        return this.addrAbsoluteX();\n      case AddressingMode.AbsoluteY:\n        return this.addrAbsoluteY();\n      case AddressingMode.Indirect:\n        return this.addrIndirect();\n      case AddressingMode.IndexedIndirectX:\n        return this.addrIndexedIndirectX();\n      case AddressingMode.IndirectIndexedY:\n        return this.addrIndirectIndexedY();\n      default:\n        return 0;\n    }\n  }\n\n  // 隱含定址 - 無需額外位址\n  private addrImplicit(): number {\n    this.fetchedData = this.a;\n    return 0;\n  }\n\n  // 累加器定址 - 操作 A 暫存器\n  private addrAccumulator(): number {\n    this.fetchedData = this.a;\n    return 0;\n  }\n\n  // 立即定址 - 操作數在指令後\n  private addrImmediate(): number {\n    this.absoluteAddress = this.pc;\n    this.pc = (this.pc + 1) & 0xFFFF;\n    return 0;\n  }\n\n  // 零頁定址\n  private addrZeroPage(): number {\n    this.absoluteAddress = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    this.absoluteAddress &= 0x00FF;\n    return 0;\n  }\n\n  // 零頁 X 索引\n  private addrZeroPageX(): number {\n    this.absoluteAddress = (this.read(this.pc) + this.x) & 0xFF;\n    this.pc = (this.pc + 1) & 0xFFFF;\n    return 0;\n  }\n\n  // 零頁 Y 索引\n  private addrZeroPageY(): number {\n    this.absoluteAddress = (this.read(this.pc) + this.y) & 0xFF;\n    this.pc = (this.pc + 1) & 0xFFFF;\n    return 0;\n  }\n\n  // 相對定址 (用於分支)\n  private addrRelative(): number {\n    this.relativeAddress = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    // 轉換為有號數\n    if (this.relativeAddress & 0x80) {\n      this.relativeAddress |= 0xFF00;\n    }\n    return 0;\n  }\n\n  // 絕對定址\n  private addrAbsolute(): number {\n    const lo = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const hi = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    this.absoluteAddress = (hi << 8) | lo;\n    return 0;\n  }\n\n  // 絕對 X 索引\n  private addrAbsoluteX(): number {\n    const lo = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const hi = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    this.absoluteAddress = ((hi << 8) | lo) + this.x;\n    this.absoluteAddress &= 0xFFFF;\n\n    // 跨頁時需要額外週期\n    if ((this.absoluteAddress & 0xFF00) !== (hi << 8)) {\n      return 1;\n    }\n    return 0;\n  }\n\n  // 絕對 Y 索引\n  private addrAbsoluteY(): number {\n    const lo = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const hi = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    this.absoluteAddress = ((hi << 8) | lo) + this.y;\n    this.absoluteAddress &= 0xFFFF;\n\n    // 跨頁時需要額外週期\n    if ((this.absoluteAddress & 0xFF00) !== (hi << 8)) {\n      return 1;\n    }\n    return 0;\n  }\n\n  // 間接定址 (僅用於 JMP)\n  private addrIndirect(): number {\n    const ptrLo = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const ptrHi = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const ptr = (ptrHi << 8) | ptrLo;\n\n    // 6502 的 bug：如果指標在頁面邊界，高位元組會從同頁面的開始讀取\n    if (ptrLo === 0xFF) {\n      this.absoluteAddress = (this.read(ptr & 0xFF00) << 8) | this.read(ptr);\n    } else {\n      this.absoluteAddress = (this.read(ptr + 1) << 8) | this.read(ptr);\n    }\n    return 0;\n  }\n\n  // 索引間接 (Indexed Indirect) - (zp,X)\n  private addrIndexedIndirectX(): number {\n    const zp = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const lo = this.read((zp + this.x) & 0xFF);\n    const hi = this.read((zp + this.x + 1) & 0xFF);\n    this.absoluteAddress = (hi << 8) | lo;\n    return 0;\n  }\n\n  // 間接索引 (Indirect Indexed) - (zp),Y\n  private addrIndirectIndexedY(): number {\n    const zp = this.read(this.pc);\n    this.pc = (this.pc + 1) & 0xFFFF;\n    const lo = this.read(zp);\n    const hi = this.read((zp + 1) & 0xFF);\n    this.absoluteAddress = ((hi << 8) | lo) + this.y;\n    this.absoluteAddress &= 0xFFFF;\n\n    // 跨頁時需要額外週期\n    if ((this.absoluteAddress & 0xFF00) !== (hi << 8)) {\n      return 1;\n    }\n    return 0;\n  }\n\n  // ===== 輔助方法 =====\n\n  /** 從目標位址取得資料 */\n  private fetch(): number {\n    const instruction = this.instructions[this.opcode];\n    if (instruction.mode !== AddressingMode.Implicit &&\n        instruction.mode !== AddressingMode.Accumulator) {\n      this.fetchedData = this.read(this.absoluteAddress);\n    }\n    return this.fetchedData;\n  }\n\n  /** 分支輔助函數 */\n  private branch(): void {\n    this.cycles++;\n    this.absoluteAddress = (this.pc + this.relativeAddress) & 0xFFFF;\n\n    // 跨頁需要額外週期\n    if ((this.absoluteAddress & 0xFF00) !== (this.pc & 0xFF00)) {\n      this.cycles++;\n    }\n\n    this.pc = this.absoluteAddress;\n  }\n\n  // ===== 指令實作 =====\n\n  // 載入/儲存指令\n  private LDA(): void {\n    this.a = this.fetch();\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private LDX(): void {\n    this.x = this.fetch();\n    this.setFlag(CpuFlags.Z, this.x === 0);\n    this.setFlag(CpuFlags.N, (this.x & 0x80) !== 0);\n  }\n\n  private LDY(): void {\n    this.y = this.fetch();\n    this.setFlag(CpuFlags.Z, this.y === 0);\n    this.setFlag(CpuFlags.N, (this.y & 0x80) !== 0);\n  }\n\n  private STA(): void {\n    this.write(this.absoluteAddress, this.a);\n  }\n\n  private STX(): void {\n    this.write(this.absoluteAddress, this.x);\n  }\n\n  private STY(): void {\n    this.write(this.absoluteAddress, this.y);\n  }\n\n  // 傳送指令\n  private TAX(): void {\n    this.x = this.a;\n    this.setFlag(CpuFlags.Z, this.x === 0);\n    this.setFlag(CpuFlags.N, (this.x & 0x80) !== 0);\n  }\n\n  private TAY(): void {\n    this.y = this.a;\n    this.setFlag(CpuFlags.Z, this.y === 0);\n    this.setFlag(CpuFlags.N, (this.y & 0x80) !== 0);\n  }\n\n  private TXA(): void {\n    this.a = this.x;\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private TYA(): void {\n    this.a = this.y;\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private TSX(): void {\n    this.x = this.sp;\n    this.setFlag(CpuFlags.Z, this.x === 0);\n    this.setFlag(CpuFlags.N, (this.x & 0x80) !== 0);\n  }\n\n  private TXS(): void {\n    this.sp = this.x;\n  }\n\n  // 堆疊操作\n  private PHA(): void {\n    this.pushStack(this.a);\n  }\n\n  private PHP(): void {\n    this.pushStack(this.status | CpuFlags.B | CpuFlags.U);\n  }\n\n  private PLA(): void {\n    this.a = this.popStack();\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private PLP(): void {\n    this.status = this.popStack();\n    this.setFlag(CpuFlags.U, true);\n    this.setFlag(CpuFlags.B, false);\n  }\n\n  // 算術運算\n  private ADC(): void {\n    const data = this.fetch();\n    const result = this.a + data + (this.getFlag(CpuFlags.C) ? 1 : 0);\n    \n    this.setFlag(CpuFlags.C, result > 0xFF);\n    this.setFlag(CpuFlags.Z, (result & 0xFF) === 0);\n    this.setFlag(CpuFlags.V, ((~(this.a ^ data) & (this.a ^ result)) & 0x80) !== 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n    \n    this.a = result & 0xFF;\n  }\n\n  private SBC(): void {\n    const data = this.fetch() ^ 0xFF; // 取反\n    const result = this.a + data + (this.getFlag(CpuFlags.C) ? 1 : 0);\n    \n    this.setFlag(CpuFlags.C, result > 0xFF);\n    this.setFlag(CpuFlags.Z, (result & 0xFF) === 0);\n    this.setFlag(CpuFlags.V, ((~(this.a ^ data) & (this.a ^ result)) & 0x80) !== 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n    \n    this.a = result & 0xFF;\n  }\n\n  private CMP(): void {\n    const data = this.fetch();\n    const result = this.a - data;\n    this.setFlag(CpuFlags.C, this.a >= data);\n    this.setFlag(CpuFlags.Z, (result & 0xFF) === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n  }\n\n  private CPX(): void {\n    const data = this.fetch();\n    const result = this.x - data;\n    this.setFlag(CpuFlags.C, this.x >= data);\n    this.setFlag(CpuFlags.Z, (result & 0xFF) === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n  }\n\n  private CPY(): void {\n    const data = this.fetch();\n    const result = this.y - data;\n    this.setFlag(CpuFlags.C, this.y >= data);\n    this.setFlag(CpuFlags.Z, (result & 0xFF) === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n  }\n\n  // 遞增/遞減\n  private INC(): void {\n    const data = (this.fetch() + 1) & 0xFF;\n    this.write(this.absoluteAddress, data);\n    this.setFlag(CpuFlags.Z, data === 0);\n    this.setFlag(CpuFlags.N, (data & 0x80) !== 0);\n  }\n\n  private INX(): void {\n    this.x = (this.x + 1) & 0xFF;\n    this.setFlag(CpuFlags.Z, this.x === 0);\n    this.setFlag(CpuFlags.N, (this.x & 0x80) !== 0);\n  }\n\n  private INY(): void {\n    this.y = (this.y + 1) & 0xFF;\n    this.setFlag(CpuFlags.Z, this.y === 0);\n    this.setFlag(CpuFlags.N, (this.y & 0x80) !== 0);\n  }\n\n  private DEC(): void {\n    const data = (this.fetch() - 1) & 0xFF;\n    this.write(this.absoluteAddress, data);\n    this.setFlag(CpuFlags.Z, data === 0);\n    this.setFlag(CpuFlags.N, (data & 0x80) !== 0);\n  }\n\n  private DEX(): void {\n    this.x = (this.x - 1) & 0xFF;\n    this.setFlag(CpuFlags.Z, this.x === 0);\n    this.setFlag(CpuFlags.N, (this.x & 0x80) !== 0);\n  }\n\n  private DEY(): void {\n    this.y = (this.y - 1) & 0xFF;\n    this.setFlag(CpuFlags.Z, this.y === 0);\n    this.setFlag(CpuFlags.N, (this.y & 0x80) !== 0);\n  }\n\n  // 邏輯運算\n  private AND(): void {\n    this.a &= this.fetch();\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private ORA(): void {\n    this.a |= this.fetch();\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private EOR(): void {\n    this.a ^= this.fetch();\n    this.setFlag(CpuFlags.Z, this.a === 0);\n    this.setFlag(CpuFlags.N, (this.a & 0x80) !== 0);\n  }\n\n  private BIT(): void {\n    const data = this.fetch();\n    this.setFlag(CpuFlags.Z, (this.a & data) === 0);\n    this.setFlag(CpuFlags.N, (data & 0x80) !== 0);\n    this.setFlag(CpuFlags.V, (data & 0x40) !== 0);\n  }\n\n  // 移位運算\n  private ASL(): void {\n    const data = this.fetch();\n    const result = (data << 1) & 0xFF;\n    this.setFlag(CpuFlags.C, (data & 0x80) !== 0);\n    this.setFlag(CpuFlags.Z, result === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n    \n    if (this.instructions[this.opcode].mode === AddressingMode.Accumulator) {\n      this.a = result;\n    } else {\n      this.write(this.absoluteAddress, result);\n    }\n  }\n\n  private LSR(): void {\n    const data = this.fetch();\n    const result = data >> 1;\n    this.setFlag(CpuFlags.C, (data & 0x01) !== 0);\n    this.setFlag(CpuFlags.Z, result === 0);\n    this.setFlag(CpuFlags.N, false);\n    \n    if (this.instructions[this.opcode].mode === AddressingMode.Accumulator) {\n      this.a = result;\n    } else {\n      this.write(this.absoluteAddress, result);\n    }\n  }\n\n  private ROL(): void {\n    const data = this.fetch();\n    const result = ((data << 1) | (this.getFlag(CpuFlags.C) ? 1 : 0)) & 0xFF;\n    this.setFlag(CpuFlags.C, (data & 0x80) !== 0);\n    this.setFlag(CpuFlags.Z, result === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n    \n    if (this.instructions[this.opcode].mode === AddressingMode.Accumulator) {\n      this.a = result;\n    } else {\n      this.write(this.absoluteAddress, result);\n    }\n  }\n\n  private ROR(): void {\n    const data = this.fetch();\n    const result = (data >> 1) | (this.getFlag(CpuFlags.C) ? 0x80 : 0);\n    this.setFlag(CpuFlags.C, (data & 0x01) !== 0);\n    this.setFlag(CpuFlags.Z, result === 0);\n    this.setFlag(CpuFlags.N, (result & 0x80) !== 0);\n    \n    if (this.instructions[this.opcode].mode === AddressingMode.Accumulator) {\n      this.a = result;\n    } else {\n      this.write(this.absoluteAddress, result);\n    }\n  }\n\n  // 跳躍和呼叫\n  private JMP(): void {\n    this.pc = this.absoluteAddress;\n  }\n\n  private JSR(): void {\n    this.pushStack16((this.pc - 1) & 0xFFFF);\n    this.pc = this.absoluteAddress;\n  }\n\n  private RTS(): void {\n    this.pc = (this.popStack16() + 1) & 0xFFFF;\n  }\n\n  // 分支指令\n  private BCC(): void {\n    if (!this.getFlag(CpuFlags.C)) this.branch();\n  }\n\n  private BCS(): void {\n    if (this.getFlag(CpuFlags.C)) this.branch();\n  }\n\n  private BEQ(): void {\n    if (this.getFlag(CpuFlags.Z)) this.branch();\n  }\n\n  private BMI(): void {\n    if (this.getFlag(CpuFlags.N)) this.branch();\n  }\n\n  private BNE(): void {\n    if (!this.getFlag(CpuFlags.Z)) this.branch();\n  }\n\n  private BPL(): void {\n    if (!this.getFlag(CpuFlags.N)) this.branch();\n  }\n\n  private BVC(): void {\n    if (!this.getFlag(CpuFlags.V)) this.branch();\n  }\n\n  private BVS(): void {\n    if (this.getFlag(CpuFlags.V)) this.branch();\n  }\n\n  // 旗標操作\n  private CLC(): void {\n    this.setFlag(CpuFlags.C, false);\n  }\n\n  private CLD(): void {\n    this.setFlag(CpuFlags.D, false);\n  }\n\n  private CLI(): void {\n    this.setFlag(CpuFlags.I, false);\n  }\n\n  private CLV(): void {\n    this.setFlag(CpuFlags.V, false);\n  }\n\n  private SEC(): void {\n    this.setFlag(CpuFlags.C, true);\n  }\n\n  private SED(): void {\n    this.setFlag(CpuFlags.D, true);\n  }\n\n  private SEI(): void {\n    this.setFlag(CpuFlags.I, true);\n  }\n\n  // 系統指令\n  private BRK(): void {\n    this.pc = (this.pc + 1) & 0xFFFF;\n    this.pushStack16(this.pc);\n    this.setFlag(CpuFlags.B, true);\n    this.pushStack(this.status | CpuFlags.B | CpuFlags.U);\n    this.setFlag(CpuFlags.I, true);\n    const lo = this.read(0xFFFE);\n    const hi = this.read(0xFFFF);\n    this.pc = (hi << 8) | lo;\n  }\n\n  private NOP(): void {\n    // 什麼都不做\n  }\n\n  private RTI(): void {\n    this.status = this.popStack();\n    this.setFlag(CpuFlags.B, false);\n    this.setFlag(CpuFlags.U, true);\n    this.pc = this.popStack16();\n  }\n\n  // 非法指令 (用於未實作的操作碼)\n  private XXX(): void {\n    // 非法指令，當作 NOP 處理\n  }\n\n  // ===== 指令表建立 =====\n\n  private buildInstructionTable(): Instruction[] {\n    const table: Instruction[] = new Array(256);\n\n    // 預設所有指令為非法指令\n    for (let i = 0; i < 256; i++) {\n      table[i] = {\n        name: 'XXX',\n        execute: this.XXX,\n        mode: AddressingMode.Implicit,\n        cycles: 2,\n      };\n    }\n\n    // 定義合法指令\n    // 格式: [操作碼, 名稱, 執行函數, 定址模式, 週期數]\n    const instructions: [number, string, () => void, AddressingMode, number][] = [\n      // 載入指令\n      [0xA9, 'LDA', this.LDA, AddressingMode.Immediate, 2],\n      [0xA5, 'LDA', this.LDA, AddressingMode.ZeroPage, 3],\n      [0xB5, 'LDA', this.LDA, AddressingMode.ZeroPageX, 4],\n      [0xAD, 'LDA', this.LDA, AddressingMode.Absolute, 4],\n      [0xBD, 'LDA', this.LDA, AddressingMode.AbsoluteX, 4],\n      [0xB9, 'LDA', this.LDA, AddressingMode.AbsoluteY, 4],\n      [0xA1, 'LDA', this.LDA, AddressingMode.IndexedIndirectX, 6],\n      [0xB1, 'LDA', this.LDA, AddressingMode.IndirectIndexedY, 5],\n\n      [0xA2, 'LDX', this.LDX, AddressingMode.Immediate, 2],\n      [0xA6, 'LDX', this.LDX, AddressingMode.ZeroPage, 3],\n      [0xB6, 'LDX', this.LDX, AddressingMode.ZeroPageY, 4],\n      [0xAE, 'LDX', this.LDX, AddressingMode.Absolute, 4],\n      [0xBE, 'LDX', this.LDX, AddressingMode.AbsoluteY, 4],\n\n      [0xA0, 'LDY', this.LDY, AddressingMode.Immediate, 2],\n      [0xA4, 'LDY', this.LDY, AddressingMode.ZeroPage, 3],\n      [0xB4, 'LDY', this.LDY, AddressingMode.ZeroPageX, 4],\n      [0xAC, 'LDY', this.LDY, AddressingMode.Absolute, 4],\n      [0xBC, 'LDY', this.LDY, AddressingMode.AbsoluteX, 4],\n\n      // 儲存指令\n      [0x85, 'STA', this.STA, AddressingMode.ZeroPage, 3],\n      [0x95, 'STA', this.STA, AddressingMode.ZeroPageX, 4],\n      [0x8D, 'STA', this.STA, AddressingMode.Absolute, 4],\n      [0x9D, 'STA', this.STA, AddressingMode.AbsoluteX, 5],\n      [0x99, 'STA', this.STA, AddressingMode.AbsoluteY, 5],\n      [0x81, 'STA', this.STA, AddressingMode.IndexedIndirectX, 6],\n      [0x91, 'STA', this.STA, AddressingMode.IndirectIndexedY, 6],\n\n      [0x86, 'STX', this.STX, AddressingMode.ZeroPage, 3],\n      [0x96, 'STX', this.STX, AddressingMode.ZeroPageY, 4],\n      [0x8E, 'STX', this.STX, AddressingMode.Absolute, 4],\n\n      [0x84, 'STY', this.STY, AddressingMode.ZeroPage, 3],\n      [0x94, 'STY', this.STY, AddressingMode.ZeroPageX, 4],\n      [0x8C, 'STY', this.STY, AddressingMode.Absolute, 4],\n\n      // 傳送指令\n      [0xAA, 'TAX', this.TAX, AddressingMode.Implicit, 2],\n      [0xA8, 'TAY', this.TAY, AddressingMode.Implicit, 2],\n      [0x8A, 'TXA', this.TXA, AddressingMode.Implicit, 2],\n      [0x98, 'TYA', this.TYA, AddressingMode.Implicit, 2],\n      [0xBA, 'TSX', this.TSX, AddressingMode.Implicit, 2],\n      [0x9A, 'TXS', this.TXS, AddressingMode.Implicit, 2],\n\n      // 堆疊操作\n      [0x48, 'PHA', this.PHA, AddressingMode.Implicit, 3],\n      [0x08, 'PHP', this.PHP, AddressingMode.Implicit, 3],\n      [0x68, 'PLA', this.PLA, AddressingMode.Implicit, 4],\n      [0x28, 'PLP', this.PLP, AddressingMode.Implicit, 4],\n\n      // 算術運算\n      [0x69, 'ADC', this.ADC, AddressingMode.Immediate, 2],\n      [0x65, 'ADC', this.ADC, AddressingMode.ZeroPage, 3],\n      [0x75, 'ADC', this.ADC, AddressingMode.ZeroPageX, 4],\n      [0x6D, 'ADC', this.ADC, AddressingMode.Absolute, 4],\n      [0x7D, 'ADC', this.ADC, AddressingMode.AbsoluteX, 4],\n      [0x79, 'ADC', this.ADC, AddressingMode.AbsoluteY, 4],\n      [0x61, 'ADC', this.ADC, AddressingMode.IndexedIndirectX, 6],\n      [0x71, 'ADC', this.ADC, AddressingMode.IndirectIndexedY, 5],\n\n      [0xE9, 'SBC', this.SBC, AddressingMode.Immediate, 2],\n      [0xE5, 'SBC', this.SBC, AddressingMode.ZeroPage, 3],\n      [0xF5, 'SBC', this.SBC, AddressingMode.ZeroPageX, 4],\n      [0xED, 'SBC', this.SBC, AddressingMode.Absolute, 4],\n      [0xFD, 'SBC', this.SBC, AddressingMode.AbsoluteX, 4],\n      [0xF9, 'SBC', this.SBC, AddressingMode.AbsoluteY, 4],\n      [0xE1, 'SBC', this.SBC, AddressingMode.IndexedIndirectX, 6],\n      [0xF1, 'SBC', this.SBC, AddressingMode.IndirectIndexedY, 5],\n\n      // 比較指令\n      [0xC9, 'CMP', this.CMP, AddressingMode.Immediate, 2],\n      [0xC5, 'CMP', this.CMP, AddressingMode.ZeroPage, 3],\n      [0xD5, 'CMP', this.CMP, AddressingMode.ZeroPageX, 4],\n      [0xCD, 'CMP', this.CMP, AddressingMode.Absolute, 4],\n      [0xDD, 'CMP', this.CMP, AddressingMode.AbsoluteX, 4],\n      [0xD9, 'CMP', this.CMP, AddressingMode.AbsoluteY, 4],\n      [0xC1, 'CMP', this.CMP, AddressingMode.IndexedIndirectX, 6],\n      [0xD1, 'CMP', this.CMP, AddressingMode.IndirectIndexedY, 5],\n\n      [0xE0, 'CPX', this.CPX, AddressingMode.Immediate, 2],\n      [0xE4, 'CPX', this.CPX, AddressingMode.ZeroPage, 3],\n      [0xEC, 'CPX', this.CPX, AddressingMode.Absolute, 4],\n\n      [0xC0, 'CPY', this.CPY, AddressingMode.Immediate, 2],\n      [0xC4, 'CPY', this.CPY, AddressingMode.ZeroPage, 3],\n      [0xCC, 'CPY', this.CPY, AddressingMode.Absolute, 4],\n\n      // 遞增/遞減\n      [0xE6, 'INC', this.INC, AddressingMode.ZeroPage, 5],\n      [0xF6, 'INC', this.INC, AddressingMode.ZeroPageX, 6],\n      [0xEE, 'INC', this.INC, AddressingMode.Absolute, 6],\n      [0xFE, 'INC', this.INC, AddressingMode.AbsoluteX, 7],\n      [0xE8, 'INX', this.INX, AddressingMode.Implicit, 2],\n      [0xC8, 'INY', this.INY, AddressingMode.Implicit, 2],\n\n      [0xC6, 'DEC', this.DEC, AddressingMode.ZeroPage, 5],\n      [0xD6, 'DEC', this.DEC, AddressingMode.ZeroPageX, 6],\n      [0xCE, 'DEC', this.DEC, AddressingMode.Absolute, 6],\n      [0xDE, 'DEC', this.DEC, AddressingMode.AbsoluteX, 7],\n      [0xCA, 'DEX', this.DEX, AddressingMode.Implicit, 2],\n      [0x88, 'DEY', this.DEY, AddressingMode.Implicit, 2],\n\n      // 邏輯運算\n      [0x29, 'AND', this.AND, AddressingMode.Immediate, 2],\n      [0x25, 'AND', this.AND, AddressingMode.ZeroPage, 3],\n      [0x35, 'AND', this.AND, AddressingMode.ZeroPageX, 4],\n      [0x2D, 'AND', this.AND, AddressingMode.Absolute, 4],\n      [0x3D, 'AND', this.AND, AddressingMode.AbsoluteX, 4],\n      [0x39, 'AND', this.AND, AddressingMode.AbsoluteY, 4],\n      [0x21, 'AND', this.AND, AddressingMode.IndexedIndirectX, 6],\n      [0x31, 'AND', this.AND, AddressingMode.IndirectIndexedY, 5],\n\n      [0x09, 'ORA', this.ORA, AddressingMode.Immediate, 2],\n      [0x05, 'ORA', this.ORA, AddressingMode.ZeroPage, 3],\n      [0x15, 'ORA', this.ORA, AddressingMode.ZeroPageX, 4],\n      [0x0D, 'ORA', this.ORA, AddressingMode.Absolute, 4],\n      [0x1D, 'ORA', this.ORA, AddressingMode.AbsoluteX, 4],\n      [0x19, 'ORA', this.ORA, AddressingMode.AbsoluteY, 4],\n      [0x01, 'ORA', this.ORA, AddressingMode.IndexedIndirectX, 6],\n      [0x11, 'ORA', this.ORA, AddressingMode.IndirectIndexedY, 5],\n\n      [0x49, 'EOR', this.EOR, AddressingMode.Immediate, 2],\n      [0x45, 'EOR', this.EOR, AddressingMode.ZeroPage, 3],\n      [0x55, 'EOR', this.EOR, AddressingMode.ZeroPageX, 4],\n      [0x4D, 'EOR', this.EOR, AddressingMode.Absolute, 4],\n      [0x5D, 'EOR', this.EOR, AddressingMode.AbsoluteX, 4],\n      [0x59, 'EOR', this.EOR, AddressingMode.AbsoluteY, 4],\n      [0x41, 'EOR', this.EOR, AddressingMode.IndexedIndirectX, 6],\n      [0x51, 'EOR', this.EOR, AddressingMode.IndirectIndexedY, 5],\n\n      [0x24, 'BIT', this.BIT, AddressingMode.ZeroPage, 3],\n      [0x2C, 'BIT', this.BIT, AddressingMode.Absolute, 4],\n\n      // 移位運算\n      [0x0A, 'ASL', this.ASL, AddressingMode.Accumulator, 2],\n      [0x06, 'ASL', this.ASL, AddressingMode.ZeroPage, 5],\n      [0x16, 'ASL', this.ASL, AddressingMode.ZeroPageX, 6],\n      [0x0E, 'ASL', this.ASL, AddressingMode.Absolute, 6],\n      [0x1E, 'ASL', this.ASL, AddressingMode.AbsoluteX, 7],\n\n      [0x4A, 'LSR', this.LSR, AddressingMode.Accumulator, 2],\n      [0x46, 'LSR', this.LSR, AddressingMode.ZeroPage, 5],\n      [0x56, 'LSR', this.LSR, AddressingMode.ZeroPageX, 6],\n      [0x4E, 'LSR', this.LSR, AddressingMode.Absolute, 6],\n      [0x5E, 'LSR', this.LSR, AddressingMode.AbsoluteX, 7],\n\n      [0x2A, 'ROL', this.ROL, AddressingMode.Accumulator, 2],\n      [0x26, 'ROL', this.ROL, AddressingMode.ZeroPage, 5],\n      [0x36, 'ROL', this.ROL, AddressingMode.ZeroPageX, 6],\n      [0x2E, 'ROL', this.ROL, AddressingMode.Absolute, 6],\n      [0x3E, 'ROL', this.ROL, AddressingMode.AbsoluteX, 7],\n\n      [0x6A, 'ROR', this.ROR, AddressingMode.Accumulator, 2],\n      [0x66, 'ROR', this.ROR, AddressingMode.ZeroPage, 5],\n      [0x76, 'ROR', this.ROR, AddressingMode.ZeroPageX, 6],\n      [0x6E, 'ROR', this.ROR, AddressingMode.Absolute, 6],\n      [0x7E, 'ROR', this.ROR, AddressingMode.AbsoluteX, 7],\n\n      // 跳躍和呼叫\n      [0x4C, 'JMP', this.JMP, AddressingMode.Absolute, 3],\n      [0x6C, 'JMP', this.JMP, AddressingMode.Indirect, 5],\n      [0x20, 'JSR', this.JSR, AddressingMode.Absolute, 6],\n      [0x60, 'RTS', this.RTS, AddressingMode.Implicit, 6],\n\n      // 分支指令\n      [0x90, 'BCC', this.BCC, AddressingMode.Relative, 2],\n      [0xB0, 'BCS', this.BCS, AddressingMode.Relative, 2],\n      [0xF0, 'BEQ', this.BEQ, AddressingMode.Relative, 2],\n      [0x30, 'BMI', this.BMI, AddressingMode.Relative, 2],\n      [0xD0, 'BNE', this.BNE, AddressingMode.Relative, 2],\n      [0x10, 'BPL', this.BPL, AddressingMode.Relative, 2],\n      [0x50, 'BVC', this.BVC, AddressingMode.Relative, 2],\n      [0x70, 'BVS', this.BVS, AddressingMode.Relative, 2],\n\n      // 旗標操作\n      [0x18, 'CLC', this.CLC, AddressingMode.Implicit, 2],\n      [0xD8, 'CLD', this.CLD, AddressingMode.Implicit, 2],\n      [0x58, 'CLI', this.CLI, AddressingMode.Implicit, 2],\n      [0xB8, 'CLV', this.CLV, AddressingMode.Implicit, 2],\n      [0x38, 'SEC', this.SEC, AddressingMode.Implicit, 2],\n      [0xF8, 'SED', this.SED, AddressingMode.Implicit, 2],\n      [0x78, 'SEI', this.SEI, AddressingMode.Implicit, 2],\n\n      // 系統指令\n      [0x00, 'BRK', this.BRK, AddressingMode.Implicit, 7],\n      [0xEA, 'NOP', this.NOP, AddressingMode.Implicit, 2],\n      [0x40, 'RTI', this.RTI, AddressingMode.Implicit, 6],\n    ];\n\n    // 填入指令表\n    for (const [opcode, name, execute, mode, cycles] of instructions) {\n      table[opcode] = { name, execute, mode, cycles };\n    }\n\n    return table;\n  }\n\n  // ===== 除錯方法 =====\n\n  /** 取得當前 CPU 狀態的字串表示 */\n  public getState(): string {\n    const flags = [\n      this.getFlag(CpuFlags.N) ? 'N' : '-',\n      this.getFlag(CpuFlags.V) ? 'V' : '-',\n      '-',\n      this.getFlag(CpuFlags.B) ? 'B' : '-',\n      this.getFlag(CpuFlags.D) ? 'D' : '-',\n      this.getFlag(CpuFlags.I) ? 'I' : '-',\n      this.getFlag(CpuFlags.Z) ? 'Z' : '-',\n      this.getFlag(CpuFlags.C) ? 'C' : '-',\n    ].join('');\n\n    return `PC:${this.pc.toString(16).padStart(4, '0').toUpperCase()} ` +\n           `A:${this.a.toString(16).padStart(2, '0').toUpperCase()} ` +\n           `X:${this.x.toString(16).padStart(2, '0').toUpperCase()} ` +\n           `Y:${this.y.toString(16).padStart(2, '0').toUpperCase()} ` +\n           `SP:${this.sp.toString(16).padStart(2, '0').toUpperCase()} ` +\n           `[${flags}]`;\n  }\n\n  /** 反組譯指定位址的指令 */\n  public disassemble(address: number): { instruction: string; bytes: number } {\n    const opcode = this.read(address);\n    const instruction = this.instructions[opcode];\n    let bytes = 1;\n    let operand = '';\n\n    switch (instruction.mode) {\n      case AddressingMode.Immediate:\n        operand = `#$${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()}`;\n        bytes = 2;\n        break;\n      case AddressingMode.ZeroPage:\n        operand = `$${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()}`;\n        bytes = 2;\n        break;\n      case AddressingMode.ZeroPageX:\n        operand = `$${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()},X`;\n        bytes = 2;\n        break;\n      case AddressingMode.ZeroPageY:\n        operand = `$${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()},Y`;\n        bytes = 2;\n        break;\n      case AddressingMode.Absolute:\n        const absAddr = this.read(address + 1) | (this.read(address + 2) << 8);\n        operand = `$${absAddr.toString(16).padStart(4, '0').toUpperCase()}`;\n        bytes = 3;\n        break;\n      case AddressingMode.AbsoluteX:\n        const absXAddr = this.read(address + 1) | (this.read(address + 2) << 8);\n        operand = `$${absXAddr.toString(16).padStart(4, '0').toUpperCase()},X`;\n        bytes = 3;\n        break;\n      case AddressingMode.AbsoluteY:\n        const absYAddr = this.read(address + 1) | (this.read(address + 2) << 8);\n        operand = `$${absYAddr.toString(16).padStart(4, '0').toUpperCase()},Y`;\n        bytes = 3;\n        break;\n      case AddressingMode.Indirect:\n        const indAddr = this.read(address + 1) | (this.read(address + 2) << 8);\n        operand = `($${indAddr.toString(16).padStart(4, '0').toUpperCase()})`;\n        bytes = 3;\n        break;\n      case AddressingMode.IndexedIndirectX:\n        operand = `($${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()},X)`;\n        bytes = 2;\n        break;\n      case AddressingMode.IndirectIndexedY:\n        operand = `($${this.read(address + 1).toString(16).padStart(2, '0').toUpperCase()}),Y`;\n        bytes = 2;\n        break;\n      case AddressingMode.Relative:\n        let offset = this.read(address + 1);\n        if (offset & 0x80) offset = offset - 256;\n        const target = address + 2 + offset;\n        operand = `$${target.toString(16).padStart(4, '0').toUpperCase()}`;\n        bytes = 2;\n        break;\n      case AddressingMode.Accumulator:\n        operand = 'A';\n        break;\n    }\n\n    return {\n      instruction: `${instruction.name} ${operand}`.trim(),\n      bytes,\n    };\n  }\n\n  // ===== 序列化 (存檔) =====\n\n  /** 儲存狀態 */\n  public saveState(): object {\n    return {\n      a: this.a,\n      x: this.x,\n      y: this.y,\n      sp: this.sp,\n      pc: this.pc,\n      status: this.status,\n      cycles: this.cycles,\n      absoluteAddress: this.absoluteAddress,\n      relativeAddress: this.relativeAddress,\n      opcode: this.opcode,\n      fetchedData: this.fetchedData,\n      totalCycles: this.totalCycles,\n    };\n  }\n\n  /** 載入狀態 */\n  public loadState(state: any): void {\n    this.a = state.a;\n    this.x = state.x;\n    this.y = state.y;\n    this.sp = state.sp;\n    this.pc = state.pc;\n    this.status = state.status;\n    this.cycles = state.cycles;\n    this.absoluteAddress = state.absoluteAddress;\n    this.relativeAddress = state.relativeAddress;\n    this.opcode = state.opcode;\n    this.fetchedData = state.fetchedData;\n    this.totalCycles = state.totalCycles;\n  }\n}\n","/**\n * NES PPU (Picture Processing Unit) 模擬器\n * \n * PPU 規格：\n * - 解析度：256 x 240 像素\n * - 調色盤：64 種顏色中選擇 25 種 (背景 13 + 精靈 12)\n * - 背景：由 8x8 的圖塊組成，使用 2 個圖案表\n * - 精靈：最多 64 個，每條掃描線最多 8 個\n * \n * PPU 記憶體映射：\n * $0000-$0FFF: 圖案表 0 (CHR)\n * $1000-$1FFF: 圖案表 1 (CHR)\n * $2000-$23FF: 命名表 0\n * $2400-$27FF: 命名表 1\n * $2800-$2BFF: 命名表 2\n * $2C00-$2FFF: 命名表 3\n * $3000-$3EFF: 命名表鏡像\n * $3F00-$3F1F: 調色盤\n * $3F20-$3FFF: 調色盤鏡像\n */\n\nimport type { Cartridge } from '../cartridge';\n\n/**\n * NES 系統調色盤 (RGB 值)\n * 來源：Nestopia 調色盤\n */\nconst SYSTEM_PALETTE: number[] = [\n  0x666666, 0x002A88, 0x1412A7, 0x3B00A4, 0x5C007E, 0x6E0040, 0x6C0600, 0x561D00,\n  0x333500, 0x0B4800, 0x005200, 0x004F08, 0x00404D, 0x000000, 0x000000, 0x000000,\n  0xADADAD, 0x155FD9, 0x4240FF, 0x7527FE, 0xA01ACC, 0xB71E7B, 0xB53120, 0x994E00,\n  0x6B6D00, 0x388700, 0x0C9300, 0x008F32, 0x007C8D, 0x000000, 0x000000, 0x000000,\n  0xFFFEFF, 0x64B0FF, 0x9290FF, 0xC676FF, 0xF36AFF, 0xFE6ECC, 0xFE8170, 0xEA9E22,\n  0xBCBE00, 0x88D800, 0x5CE430, 0x45E082, 0x48CDDE, 0x4F4F4F, 0x000000, 0x000000,\n  0xFFFEFF, 0xC0DFFF, 0xD3D2FF, 0xE8C8FF, 0xFBC2FF, 0xFEC4EA, 0xFECCC5, 0xF7D8A5,\n  0xE4E594, 0xCFEF96, 0xBDF4AB, 0xB3F3CC, 0xB5EBF2, 0xB8B8B8, 0x000000, 0x000000,\n];\n\n/**\n * PPU 控制暫存器 ($2000 PPUCTRL)\n */\nenum PpuCtrl {\n  /** 命名表選擇 bit 0 */\n  NAMETABLE_X = 1 << 0,\n  /** 命名表選擇 bit 1 */\n  NAMETABLE_Y = 1 << 1,\n  /** VRAM 位址增量 (0: +1, 1: +32) */\n  INCREMENT_MODE = 1 << 2,\n  /** 精靈圖案表選擇 (8x8 模式) */\n  SPRITE_PATTERN = 1 << 3,\n  /** 背景圖案表選擇 */\n  BACKGROUND_PATTERN = 1 << 4,\n  /** 精靈尺寸 (0: 8x8, 1: 8x16) */\n  SPRITE_SIZE = 1 << 5,\n  /** PPU 主/從選擇 (NES 不使用) */\n  MASTER_SLAVE = 1 << 6,\n  /** VBlank 時產生 NMI */\n  NMI_ENABLE = 1 << 7,\n}\n\n/**\n * PPU 遮罩暫存器 ($2001 PPUMASK)\n */\nenum PpuMask {\n  /** 灰階模式 */\n  GRAYSCALE = 1 << 0,\n  /** 顯示最左側 8 像素的背景 */\n  SHOW_BACKGROUND_LEFT = 1 << 1,\n  /** 顯示最左側 8 像素的精靈 */\n  SHOW_SPRITES_LEFT = 1 << 2,\n  /** 顯示背景 */\n  SHOW_BACKGROUND = 1 << 3,\n  /** 顯示精靈 */\n  SHOW_SPRITES = 1 << 4,\n  /** 加強紅色 */\n  EMPHASIZE_RED = 1 << 5,\n  /** 加強綠色 */\n  EMPHASIZE_GREEN = 1 << 6,\n  /** 加強藍色 */\n  EMPHASIZE_BLUE = 1 << 7,\n}\n\n/**\n * PPU 狀態暫存器 ($2002 PPUSTATUS)\n */\nenum PpuStatus {\n  /** 精靈溢出 */\n  SPRITE_OVERFLOW = 1 << 5,\n  /** 精靈 0 碰撞 */\n  SPRITE_ZERO_HIT = 1 << 6,\n  /** 垂直空白期間 */\n  VBLANK = 1 << 7,\n}\n\n/**\n * PPU 類別\n */\nexport class Ppu {\n  /** 卡帶參考 */\n  private cartridge: Cartridge | null = null;\n\n  // ===== PPU 暫存器 =====\n  /** 控制暫存器 $2000 */\n  private ctrl: number = 0;\n  /** 遮罩暫存器 $2001 */\n  private mask: number = 0;\n  /** 狀態暫存器 $2002 */\n  private status: number = 0;\n\n  /** OAM 位址 $2003 */\n  private oamAddress: number = 0;\n\n  // ===== 內部暫存器 =====\n  /** 當前 VRAM 位址 (15 位元) */\n  private vramAddr: number = 0;\n  /** 暫存 VRAM 位址 */\n  private tempAddr: number = 0;\n  /** 精細 X 捲動 (3 位元) */\n  private fineX: number = 0;\n  /** 位址閂鎖 (寫入切換) */\n  private addressLatch: boolean = false;\n  /** 資料緩衝區 */\n  private dataBuffer: number = 0;\n\n  // ===== 記憶體 =====\n  /** 命名表 RAM (2KB) */\n  private nametableRam: Uint8Array = new Uint8Array(2048);\n  /** 調色盤 RAM (32 位元組) */\n  private paletteRam: Uint8Array = new Uint8Array(32);\n  /** OAM (Object Attribute Memory) - 精靈資料 */\n  private oam: Uint8Array = new Uint8Array(256);\n  /** 次要 OAM (當前掃描線的精靈) */\n  private secondaryOam: Uint8Array = new Uint8Array(32);\n\n  // ===== 渲染狀態 =====\n  /** 當前掃描線 */\n  private scanline: number = 0;\n  /** 當前週期 */\n  private cycle: number = 0;\n  /** 是否為偶數幀 */\n  private oddFrame: boolean = false;\n\n  /** NMI 觸發旗標 */\n  private nmiTriggered: boolean = false;\n\n  // ===== 背景渲染暫存器 =====\n  private bgNextTileId: number = 0;\n  private bgNextTileAttr: number = 0;\n  private bgNextTileLo: number = 0;\n  private bgNextTileHi: number = 0;\n  private bgShifterPatternLo: number = 0;\n  private bgShifterPatternHi: number = 0;\n  private bgShifterAttrLo: number = 0;\n  private bgShifterAttrHi: number = 0;\n\n  // ===== 精靈渲染 =====\n  private spriteCount: number = 0;\n  private spriteShifterPatternLo: Uint8Array = new Uint8Array(8);\n  private spriteShifterPatternHi: Uint8Array = new Uint8Array(8);\n  private spriteZeroHitPossible: boolean = false;\n  private spriteZeroRendering: boolean = false;\n\n  // ===== 掃描線 IRQ (用於 MMC3) =====\n  private scanlineIrqFlag: boolean = false;\n\n  // ===== 輸出 =====\n  /** 幀緩衝區 (256 x 240 像素，RGBA) */\n  public frameBuffer: Uint32Array = new Uint32Array(256 * 240);\n\n  /** 幀完成旗標 */\n  public frameComplete: boolean = false;\n\n  constructor() {\n    this.reset();\n  }\n\n  /** 重置 PPU */\n  public reset(): void {\n    this.ctrl = 0;\n    this.mask = 0;\n    this.status = 0;\n    this.oamAddress = 0;\n    this.vramAddr = 0;\n    this.tempAddr = 0;\n    this.fineX = 0;\n    this.addressLatch = false;\n    this.dataBuffer = 0;\n    this.scanline = 0;\n    this.cycle = 0;\n    this.oddFrame = false;\n    this.nmiTriggered = false;\n    this.frameComplete = false;\n\n    this.nametableRam.fill(0);\n    this.paletteRam.fill(0);\n    this.oam.fill(0);\n    this.frameBuffer.fill(0);\n  }\n\n  /** 連接卡帶 */\n  public connectCartridge(cartridge: Cartridge): void {\n    this.cartridge = cartridge;\n  }\n\n  // ===== CPU 介面 =====\n\n  /** CPU 讀取 PPU 暫存器 */\n  public cpuRead(address: number): number {\n    let data = 0;\n\n    switch (address & 0x2007) {\n      case 0x2000: // PPUCTRL - 唯寫\n        break;\n\n      case 0x2001: // PPUMASK - 唯寫\n        break;\n\n      case 0x2002: // PPUSTATUS\n        data = (this.status & 0xE0) | (this.dataBuffer & 0x1F);\n        this.status &= ~PpuStatus.VBLANK; // 清除 VBlank\n        this.addressLatch = false;\n        break;\n\n      case 0x2003: // OAMADDR - 唯寫\n        break;\n\n      case 0x2004: // OAMDATA\n        data = this.oam[this.oamAddress];\n        break;\n\n      case 0x2005: // PPUSCROLL - 唯寫\n        break;\n\n      case 0x2006: // PPUADDR - 唯寫\n        break;\n\n      case 0x2007: // PPUDATA\n        // 從緩衝區讀取 (調色盤除外)\n        data = this.dataBuffer;\n        this.dataBuffer = this.ppuRead(this.vramAddr);\n\n        // 調色盤讀取不經過緩衝區\n        if (this.vramAddr >= 0x3F00) {\n          data = this.dataBuffer;\n        }\n\n        // 增加 VRAM 位址\n        this.vramAddr += (this.ctrl & PpuCtrl.INCREMENT_MODE) ? 32 : 1;\n        this.vramAddr &= 0x3FFF;\n        break;\n    }\n\n    return data;\n  }\n\n  /** CPU 寫入 PPU 暫存器 */\n  public cpuWrite(address: number, data: number): void {\n    switch (address & 0x2007) {\n      case 0x2000: // PPUCTRL\n        this.ctrl = data;\n        // 更新暫存位址的命名表選擇\n        this.tempAddr = (this.tempAddr & 0xF3FF) | ((data & 0x03) << 10);\n        break;\n\n      case 0x2001: // PPUMASK\n        this.mask = data;\n        break;\n\n      case 0x2002: // PPUSTATUS - 唯讀\n        break;\n\n      case 0x2003: // OAMADDR\n        this.oamAddress = data;\n        break;\n\n      case 0x2004: // OAMDATA\n        this.oam[this.oamAddress] = data;\n        this.oamAddress = (this.oamAddress + 1) & 0xFF;\n        break;\n\n      case 0x2005: // PPUSCROLL\n        if (!this.addressLatch) {\n          // 第一次寫入：X 捲動\n          this.fineX = data & 0x07;\n          this.tempAddr = (this.tempAddr & 0xFFE0) | (data >> 3);\n        } else {\n          // 第二次寫入：Y 捲動\n          this.tempAddr = (this.tempAddr & 0x8C1F) |\n                         ((data & 0x07) << 12) |\n                         ((data & 0xF8) << 2);\n        }\n        this.addressLatch = !this.addressLatch;\n        break;\n\n      case 0x2006: // PPUADDR\n        if (!this.addressLatch) {\n          // 第一次寫入：高位元組\n          this.tempAddr = (this.tempAddr & 0x00FF) | ((data & 0x3F) << 8);\n        } else {\n          // 第二次寫入：低位元組\n          this.tempAddr = (this.tempAddr & 0xFF00) | data;\n          this.vramAddr = this.tempAddr;\n        }\n        this.addressLatch = !this.addressLatch;\n        break;\n\n      case 0x2007: // PPUDATA\n        this.ppuWrite(this.vramAddr, data);\n        this.vramAddr += (this.ctrl & PpuCtrl.INCREMENT_MODE) ? 32 : 1;\n        this.vramAddr &= 0x3FFF;\n        break;\n    }\n  }\n\n  /** OAM DMA 寫入 */\n  public oamWrite(address: number, data: number): void {\n    this.oam[address] = data;\n  }\n\n  // ===== PPU 內部記憶體存取 =====\n\n  /** PPU 讀取記憶體 */\n  private ppuRead(address: number): number {\n    address &= 0x3FFF;\n\n    // 圖案表 ($0000-$1FFF) - 由卡帶處理\n    if (address < 0x2000) {\n      return this.cartridge?.ppuRead(address) ?? 0;\n    }\n\n    // 命名表 ($2000-$3EFF)\n    if (address < 0x3F00) {\n      address &= 0x0FFF;\n      // 根據卡帶的鏡像模式決定位址\n      const mirroredAddr = this.getMirroredNametableAddr(address);\n      return this.nametableRam[mirroredAddr];\n    }\n\n    // 調色盤 ($3F00-$3FFF)\n    address &= 0x1F;\n    // 處理鏡像：$3F10, $3F14, $3F18, $3F1C 鏡像到 $3F00, $3F04, $3F08, $3F0C\n    if ((address & 0x13) === 0x10) {\n      address &= 0x0F;\n    }\n    return this.paletteRam[address];\n  }\n\n  /** PPU 寫入記憶體 */\n  private ppuWrite(address: number, data: number): void {\n    address &= 0x3FFF;\n\n    // 圖案表 ($0000-$1FFF) - 由卡帶處理\n    if (address < 0x2000) {\n      this.cartridge?.ppuWrite(address, data);\n      return;\n    }\n\n    // 命名表 ($2000-$3EFF)\n    if (address < 0x3F00) {\n      address &= 0x0FFF;\n      const mirroredAddr = this.getMirroredNametableAddr(address);\n      this.nametableRam[mirroredAddr] = data;\n      return;\n    }\n\n    // 調色盤 ($3F00-$3FFF)\n    address &= 0x1F;\n    if ((address & 0x13) === 0x10) {\n      address &= 0x0F;\n    }\n    this.paletteRam[address] = data;\n  }\n\n  /** 取得鏡像後的命名表位址 */\n  private getMirroredNametableAddr(address: number): number {\n    const mirrorMode = this.cartridge?.getMirrorMode() ?? 0;\n\n    switch (mirrorMode) {\n      case 0: // 水平鏡像\n        if (address < 0x0800) return address & 0x03FF;\n        return 0x0400 + (address & 0x03FF);\n\n      case 1: // 垂直鏡像\n        return address & 0x07FF;\n\n      case 2: // 單螢幕 (低)\n        return address & 0x03FF;\n\n      case 3: // 單螢幕 (高)\n        return 0x0400 + (address & 0x03FF);\n\n      default:\n        return address & 0x07FF;\n    }\n  }\n\n  // ===== 渲染方法 =====\n\n  /** 是否啟用渲染 */\n  private isRenderingEnabled(): boolean {\n    return (this.mask & (PpuMask.SHOW_BACKGROUND | PpuMask.SHOW_SPRITES)) !== 0;\n  }\n\n  /** 增加 X 捲動 */\n  private incrementScrollX(): void {\n    if (!this.isRenderingEnabled()) return;\n\n    if ((this.vramAddr & 0x001F) === 31) {\n      this.vramAddr &= ~0x001F; // 重置粗略 X\n      this.vramAddr ^= 0x0400;  // 切換水平命名表\n    } else {\n      this.vramAddr++;\n    }\n  }\n\n  /** 增加 Y 捲動 */\n  private incrementScrollY(): void {\n    if (!this.isRenderingEnabled()) return;\n\n    if ((this.vramAddr & 0x7000) !== 0x7000) {\n      this.vramAddr += 0x1000; // 增加精細 Y\n    } else {\n      this.vramAddr &= ~0x7000; // 重置精細 Y\n      let coarseY = (this.vramAddr & 0x03E0) >> 5;\n\n      if (coarseY === 29) {\n        coarseY = 0;\n        this.vramAddr ^= 0x0800; // 切換垂直命名表\n      } else if (coarseY === 31) {\n        coarseY = 0;\n      } else {\n        coarseY++;\n      }\n\n      this.vramAddr = (this.vramAddr & ~0x03E0) | (coarseY << 5);\n    }\n  }\n\n  /** 傳輸 X 位址 */\n  private transferAddressX(): void {\n    if (!this.isRenderingEnabled()) return;\n    this.vramAddr = (this.vramAddr & 0xFBE0) | (this.tempAddr & 0x041F);\n  }\n\n  /** 傳輸 Y 位址 */\n  private transferAddressY(): void {\n    if (!this.isRenderingEnabled()) return;\n    this.vramAddr = (this.vramAddr & 0x841F) | (this.tempAddr & 0x7BE0);\n  }\n\n  /** 載入背景移位器 */\n  private loadBackgroundShifters(): void {\n    this.bgShifterPatternLo = (this.bgShifterPatternLo & 0xFF00) | this.bgNextTileLo;\n    this.bgShifterPatternHi = (this.bgShifterPatternHi & 0xFF00) | this.bgNextTileHi;\n    this.bgShifterAttrLo = (this.bgShifterAttrLo & 0xFF00) | ((this.bgNextTileAttr & 1) ? 0xFF : 0);\n    this.bgShifterAttrHi = (this.bgShifterAttrHi & 0xFF00) | ((this.bgNextTileAttr & 2) ? 0xFF : 0);\n  }\n\n  /** 更新移位器 */\n  private updateShifters(): void {\n    if (this.mask & PpuMask.SHOW_BACKGROUND) {\n      this.bgShifterPatternLo = (this.bgShifterPatternLo << 1) & 0xFFFF;\n      this.bgShifterPatternHi = (this.bgShifterPatternHi << 1) & 0xFFFF;\n      this.bgShifterAttrLo = (this.bgShifterAttrLo << 1) & 0xFFFF;\n      this.bgShifterAttrHi = (this.bgShifterAttrHi << 1) & 0xFFFF;\n    }\n\n    if ((this.mask & PpuMask.SHOW_SPRITES) && this.cycle >= 1 && this.cycle < 258) {\n      for (let i = 0; i < this.spriteCount; i++) {\n        const x = this.secondaryOam[i * 4 + 3];\n        if (x > 0) {\n          this.secondaryOam[i * 4 + 3]--;\n        } else {\n          this.spriteShifterPatternLo[i] = (this.spriteShifterPatternLo[i] << 1) & 0xFF;\n          this.spriteShifterPatternHi[i] = (this.spriteShifterPatternHi[i] << 1) & 0xFF;\n        }\n      }\n    }\n  }\n\n  /** 執行一個 PPU 時鐘週期 */\n  public clock(): void {\n    // 可見掃描線 (0-239) 和預渲染掃描線 (-1)\n    if (this.scanline >= -1 && this.scanline < 240) {\n      // 奇數幀跳過 (0,0) 週期\n      if (this.scanline === 0 && this.cycle === 0 && this.oddFrame && this.isRenderingEnabled()) {\n        this.cycle = 1;\n      }\n\n      // 預渲染掃描線\n      if (this.scanline === -1 && this.cycle === 1) {\n        this.status &= ~PpuStatus.VBLANK;\n        this.status &= ~PpuStatus.SPRITE_OVERFLOW;\n        this.status &= ~PpuStatus.SPRITE_ZERO_HIT;\n        this.spriteShifterPatternLo.fill(0);\n        this.spriteShifterPatternHi.fill(0);\n      }\n\n      // 背景渲染\n      if ((this.cycle >= 2 && this.cycle < 258) || (this.cycle >= 321 && this.cycle < 338)) {\n        this.updateShifters();\n\n        switch ((this.cycle - 1) % 8) {\n          case 0:\n            this.loadBackgroundShifters();\n            // 讀取命名表位元組\n            this.bgNextTileId = this.ppuRead(0x2000 | (this.vramAddr & 0x0FFF));\n            break;\n          case 2:\n            // 讀取屬性位元組\n            this.bgNextTileAttr = this.ppuRead(\n              0x23C0 |\n              (this.vramAddr & 0x0C00) |\n              ((this.vramAddr >> 4) & 0x38) |\n              ((this.vramAddr >> 2) & 0x07)\n            );\n            if ((this.vramAddr >> 5) & 0x02) this.bgNextTileAttr >>= 4;\n            if (this.vramAddr & 0x02) this.bgNextTileAttr >>= 2;\n            this.bgNextTileAttr &= 0x03;\n            break;\n          case 4:\n            // 讀取圖案低位元組\n            this.bgNextTileLo = this.ppuRead(\n              ((this.ctrl & PpuCtrl.BACKGROUND_PATTERN) ? 0x1000 : 0) +\n              (this.bgNextTileId << 4) +\n              ((this.vramAddr >> 12) & 0x07)\n            );\n            break;\n          case 6:\n            // 讀取圖案高位元組\n            this.bgNextTileHi = this.ppuRead(\n              ((this.ctrl & PpuCtrl.BACKGROUND_PATTERN) ? 0x1000 : 0) +\n              (this.bgNextTileId << 4) +\n              ((this.vramAddr >> 12) & 0x07) + 8\n            );\n            break;\n          case 7:\n            this.incrementScrollX();\n            break;\n        }\n      }\n\n      if (this.cycle === 256) {\n        this.incrementScrollY();\n      }\n\n      if (this.cycle === 257) {\n        this.loadBackgroundShifters();\n        this.transferAddressX();\n      }\n\n      // 精靈評估\n      if (this.cycle === 257 && this.scanline >= 0) {\n        this.evaluateSprites();\n      }\n      \n      // 觸發掃描線 IRQ (用於 MMC3)\n      if (this.cycle === 260 && this.isRenderingEnabled()) {\n        this.scanlineIrqFlag = true;\n      }\n\n      // 預渲染掃描線期間重載 Y\n      if (this.scanline === -1 && this.cycle >= 280 && this.cycle < 305) {\n        this.transferAddressY();\n      }\n    }\n\n    // VBlank 開始\n    if (this.scanline === 241 && this.cycle === 1) {\n      this.status |= PpuStatus.VBLANK;\n      if (this.ctrl & PpuCtrl.NMI_ENABLE) {\n        this.nmiTriggered = true;\n      }\n    }\n\n    // 渲染像素\n    if (this.scanline >= 0 && this.scanline < 240 && this.cycle >= 1 && this.cycle <= 256) {\n      this.renderPixel();\n    }\n\n    // 推進週期計數器\n    this.cycle++;\n    if (this.cycle >= 341) {\n      this.cycle = 0;\n      this.scanline++;\n      if (this.scanline >= 261) {\n        this.scanline = -1;\n        this.frameComplete = true;\n        this.oddFrame = !this.oddFrame;\n      }\n    }\n  }\n\n  /** 評估當前掃描線的精靈 */\n  private evaluateSprites(): void {\n    this.secondaryOam.fill(0xFF);\n    this.spriteCount = 0;\n    this.spriteZeroHitPossible = false;\n\n    const spriteHeight = (this.ctrl & PpuCtrl.SPRITE_SIZE) ? 16 : 8;\n\n    for (let i = 0; i < 64 && this.spriteCount < 8; i++) {\n      const y = this.oam[i * 4];\n      const diff = this.scanline - y;\n\n      if (diff >= 0 && diff < spriteHeight) {\n        if (i === 0) {\n          this.spriteZeroHitPossible = true;\n        }\n\n        // 複製精靈資料\n        for (let j = 0; j < 4; j++) {\n          this.secondaryOam[this.spriteCount * 4 + j] = this.oam[i * 4 + j];\n        }\n\n        // 載入精靈圖案\n        this.loadSpritePattern(this.spriteCount, diff);\n        this.spriteCount++;\n      }\n    }\n\n    // 檢查精靈溢出\n    if (this.spriteCount >= 8) {\n      this.status |= PpuStatus.SPRITE_OVERFLOW;\n    }\n  }\n\n  /** 載入精靈圖案 */\n  private loadSpritePattern(spriteIndex: number, row: number): void {\n    const tileIndex = this.secondaryOam[spriteIndex * 4 + 1];\n    const attributes = this.secondaryOam[spriteIndex * 4 + 2];\n    const flipVertical = (attributes & 0x80) !== 0;\n    const flipHorizontal = (attributes & 0x40) !== 0;\n    const spriteHeight = (this.ctrl & PpuCtrl.SPRITE_SIZE) ? 16 : 8;\n\n    let patternAddr: number;\n\n    if (spriteHeight === 8) {\n      // 8x8 精靈\n      patternAddr = ((this.ctrl & PpuCtrl.SPRITE_PATTERN) ? 0x1000 : 0) + (tileIndex << 4);\n      if (flipVertical) {\n        row = 7 - row;\n      }\n    } else {\n      // 8x16 精靈\n      patternAddr = ((tileIndex & 0x01) ? 0x1000 : 0) + ((tileIndex & 0xFE) << 4);\n      if (flipVertical) {\n        row = 15 - row;\n      }\n      if (row >= 8) {\n        patternAddr += 16;\n        row -= 8;\n      }\n    }\n\n    let patternLo = this.ppuRead(patternAddr + row);\n    let patternHi = this.ppuRead(patternAddr + row + 8);\n\n    // 水平翻轉\n    if (flipHorizontal) {\n      patternLo = this.reverseBits(patternLo);\n      patternHi = this.reverseBits(patternHi);\n    }\n\n    this.spriteShifterPatternLo[spriteIndex] = patternLo;\n    this.spriteShifterPatternHi[spriteIndex] = patternHi;\n  }\n\n  /** 位元反轉 */\n  private reverseBits(b: number): number {\n    b = ((b & 0xF0) >> 4) | ((b & 0x0F) << 4);\n    b = ((b & 0xCC) >> 2) | ((b & 0x33) << 2);\n    b = ((b & 0xAA) >> 1) | ((b & 0x55) << 1);\n    return b;\n  }\n\n  /** 渲染一個像素 */\n  private renderPixel(): void {\n    const x = this.cycle - 1;\n    const y = this.scanline;\n\n    let bgPixel = 0;\n    let bgPalette = 0;\n    let spritePixel = 0;\n    let spritePalette = 0;\n    let spritePriority = false;\n\n    // 背景像素\n    if (this.mask & PpuMask.SHOW_BACKGROUND) {\n      if ((this.mask & PpuMask.SHOW_BACKGROUND_LEFT) || x >= 8) {\n        const mux = 0x8000 >> this.fineX;\n        const p0 = (this.bgShifterPatternLo & mux) ? 1 : 0;\n        const p1 = (this.bgShifterPatternHi & mux) ? 2 : 0;\n        bgPixel = p0 | p1;\n\n        const a0 = (this.bgShifterAttrLo & mux) ? 1 : 0;\n        const a1 = (this.bgShifterAttrHi & mux) ? 2 : 0;\n        bgPalette = a0 | a1;\n      }\n    }\n\n    // 精靈像素\n    if (this.mask & PpuMask.SHOW_SPRITES) {\n      if ((this.mask & PpuMask.SHOW_SPRITES_LEFT) || x >= 8) {\n        this.spriteZeroRendering = false;\n\n        for (let i = 0; i < this.spriteCount; i++) {\n          const spriteX = this.secondaryOam[i * 4 + 3];\n          if (spriteX === 0) {\n            const p0 = (this.spriteShifterPatternLo[i] & 0x80) ? 1 : 0;\n            const p1 = (this.spriteShifterPatternHi[i] & 0x80) ? 2 : 0;\n            spritePixel = p0 | p1;\n\n            const attr = this.secondaryOam[i * 4 + 2];\n            spritePalette = (attr & 0x03) + 4;\n            spritePriority = (attr & 0x20) === 0;\n\n            if (spritePixel !== 0) {\n              if (i === 0) {\n                this.spriteZeroRendering = true;\n              }\n              break;\n            }\n          }\n        }\n      }\n    }\n\n    // 決定最終像素\n    let finalPixel = 0;\n    let finalPalette = 0;\n\n    if (bgPixel === 0 && spritePixel === 0) {\n      finalPixel = 0;\n      finalPalette = 0;\n    } else if (bgPixel === 0 && spritePixel !== 0) {\n      finalPixel = spritePixel;\n      finalPalette = spritePalette;\n    } else if (bgPixel !== 0 && spritePixel === 0) {\n      finalPixel = bgPixel;\n      finalPalette = bgPalette;\n    } else {\n      // 精靈 0 碰撞檢測\n      if (this.spriteZeroHitPossible && this.spriteZeroRendering) {\n        if ((this.mask & PpuMask.SHOW_BACKGROUND) && (this.mask & PpuMask.SHOW_SPRITES)) {\n          // 如果左側 8 像素被隱藏，則在 x >= 8 時才能發生碰撞\n          const leftClip = !((this.mask & PpuMask.SHOW_BACKGROUND_LEFT) && \n                             (this.mask & PpuMask.SHOW_SPRITES_LEFT));\n          if (leftClip) {\n            if (x >= 8 && x < 255) {\n              this.status |= PpuStatus.SPRITE_ZERO_HIT;\n            }\n          } else {\n            if (x >= 0 && x < 255) {\n              this.status |= PpuStatus.SPRITE_ZERO_HIT;\n            }\n          }\n        }\n      }\n\n      if (spritePriority) {\n        finalPixel = spritePixel;\n        finalPalette = spritePalette;\n      } else {\n        finalPixel = bgPixel;\n        finalPalette = bgPalette;\n      }\n    }\n\n    // 取得顏色並寫入幀緩衝區\n    const colorIndex = this.ppuRead(0x3F00 + (finalPalette << 2) + finalPixel) & 0x3F;\n    const color = SYSTEM_PALETTE[colorIndex];\n    this.frameBuffer[y * 256 + x] = 0xFF000000 | color;\n  }\n\n  // ===== 公開方法 =====\n\n  /** 檢查並清除 NMI 旗標 */\n  public checkNmi(): boolean {\n    if (this.nmiTriggered) {\n      this.nmiTriggered = false;\n      return true;\n    }\n    return false;\n  }\n\n  /** 取得調色盤顏色 (用於除錯) */\n  public getPaletteColor(paletteIndex: number, colorIndex: number): number {\n    const index = this.ppuRead(0x3F00 + (paletteIndex << 2) + colorIndex) & 0x3F;\n    return SYSTEM_PALETTE[index];\n  }\n\n  /** 取得圖案表 (用於除錯) */\n  public getPatternTable(index: number, palette: number): Uint32Array {\n    const table = new Uint32Array(128 * 128);\n\n    for (let tileY = 0; tileY < 16; tileY++) {\n      for (let tileX = 0; tileX < 16; tileX++) {\n        const offset = tileY * 256 + tileX * 16;\n\n        for (let row = 0; row < 8; row++) {\n          let tileLo = this.ppuRead(index * 0x1000 + offset + row);\n          let tileHi = this.ppuRead(index * 0x1000 + offset + row + 8);\n\n          for (let col = 0; col < 8; col++) {\n            const pixel = ((tileLo & 0x01) << 0) | ((tileHi & 0x01) << 1);\n            tileLo >>= 1;\n            tileHi >>= 1;\n\n            const x = tileX * 8 + (7 - col);\n            const y = tileY * 8 + row;\n            const color = this.getPaletteColor(palette, pixel);\n            table[y * 128 + x] = 0xFF000000 | color;\n          }\n        }\n      }\n    }\n\n    return table;\n  }\n\n  /** 掃描線 IRQ 旗標 (用於 MMC3) */\n  /**\n   * 檢查是否需要觸發掃描線 IRQ\n   * 在渲染期間的每條掃描線結束時檢查 A12 上升沿\n   */\n  public checkScanlineIrq(): boolean {\n    const flag = this.scanlineIrqFlag;\n    this.scanlineIrqFlag = false;\n    return flag;\n  }\n\n  // ===== 序列化 (存檔) =====\n\n  /** 儲存狀態 */\n  public saveState(): object {\n    return {\n      ctrl: this.ctrl,\n      mask: this.mask,\n      status: this.status,\n      oamAddress: this.oamAddress,\n      vramAddr: this.vramAddr,\n      tempAddr: this.tempAddr,\n      fineX: this.fineX,\n      addressLatch: this.addressLatch,\n      dataBuffer: this.dataBuffer,\n      nametableRam: Array.from(this.nametableRam),\n      paletteRam: Array.from(this.paletteRam),\n      oam: Array.from(this.oam),\n      secondaryOam: Array.from(this.secondaryOam),\n      scanline: this.scanline,\n      cycle: this.cycle,\n      oddFrame: this.oddFrame,\n      nmiTriggered: this.nmiTriggered,\n      bgNextTileId: this.bgNextTileId,\n      bgNextTileAttr: this.bgNextTileAttr,\n      bgNextTileLo: this.bgNextTileLo,\n      bgNextTileHi: this.bgNextTileHi,\n    };\n  }\n\n  /** 載入狀態 */\n  public loadState(state: any): void {\n    this.ctrl = state.ctrl;\n    this.mask = state.mask;\n    this.status = state.status;\n    this.oamAddress = state.oamAddress;\n    this.vramAddr = state.vramAddr;\n    this.tempAddr = state.tempAddr;\n    this.fineX = state.fineX;\n    this.addressLatch = state.addressLatch;\n    this.dataBuffer = state.dataBuffer;\n    this.nametableRam.set(state.nametableRam);\n    this.paletteRam.set(state.paletteRam);\n    this.oam.set(state.oam);\n    this.secondaryOam.set(state.secondaryOam);\n    this.scanline = state.scanline;\n    this.cycle = state.cycle;\n    this.oddFrame = state.oddFrame;\n    this.nmiTriggered = state.nmiTriggered;\n    this.bgNextTileId = state.bgNextTileId;\n    this.bgNextTileAttr = state.bgNextTileAttr;\n    this.bgNextTileLo = state.bgNextTileLo;\n    this.bgNextTileHi = state.bgNextTileHi;\n  }\n}\n","/**\n * APU 查找表\n */\n\n/**\n * 長度計數器查找表\n * 索引 0-31 對應不同的長度值\n */\nexport const LENGTH_TABLE: number[] = [\n  10, 254, 20, 2, 40, 4, 80, 6,\n  160, 8, 60, 10, 14, 12, 26, 14,\n  12, 16, 24, 18, 48, 20, 96, 22,\n  192, 24, 72, 26, 16, 28, 32, 30,\n];\n","/**\n * 包絡線生成器\n * \n * 用於脈衝波和雜訊通道的音量控制\n * 可以產生衰減效果或固定音量\n */\n\nexport class Envelope {\n  /** 是否使用常量音量 */\n  private constantVolume: boolean = false;\n\n  /** 常量音量值 / 包絡線週期 */\n  private volume: number = 0;\n\n  /** 包絡線分頻器 */\n  private divider: number = 0;\n\n  /** 包絡線衰減等級 */\n  private decayLevel: number = 0;\n\n  /** 開始旗標 */\n  private startFlag: boolean = false;\n\n  /** 迴圈旗標 (與長度計數器停止旗標共用) */\n  private loopFlag: boolean = false;\n\n  constructor() {\n    this.reset();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.constantVolume = false;\n    this.volume = 0;\n    this.divider = 0;\n    this.decayLevel = 0;\n    this.startFlag = false;\n    this.loopFlag = false;\n  }\n\n  /**\n   * 設定常量音量模式\n   */\n  public setConstantVolume(constant: boolean): void {\n    this.constantVolume = constant;\n  }\n\n  /**\n   * 設定音量/週期\n   */\n  public setVolume(volume: number): void {\n    this.volume = volume & 0x0F;\n  }\n\n  /**\n   * 設定迴圈旗標\n   */\n  public setLoop(loop: boolean): void {\n    this.loopFlag = loop;\n  }\n\n  /**\n   * 開始新的包絡線週期\n   */\n  public start(): void {\n    this.startFlag = true;\n  }\n\n  /**\n   * 時鐘 (每個四分之一幀)\n   */\n  public clock(): void {\n    if (this.startFlag) {\n      this.startFlag = false;\n      this.decayLevel = 15;\n      this.divider = this.volume;\n    } else {\n      // 分頻器計數\n      if (this.divider === 0) {\n        this.divider = this.volume;\n        // 衰減\n        if (this.decayLevel > 0) {\n          this.decayLevel--;\n        } else if (this.loopFlag) {\n          this.decayLevel = 15;\n        }\n      } else {\n        this.divider--;\n      }\n    }\n  }\n\n  /**\n   * 取得輸出音量\n   */\n  public output(): number {\n    if (this.constantVolume) {\n      return this.volume;\n    } else {\n      return this.decayLevel;\n    }\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      constantVolume: this.constantVolume,\n      volume: this.volume,\n      divider: this.divider,\n      decayLevel: this.decayLevel,\n      startFlag: this.startFlag,\n      loopFlag: this.loopFlag,\n    };\n  }\n\n  public loadState(state: any): void {\n    this.constantVolume = state.constantVolume;\n    this.volume = state.volume;\n    this.divider = state.divider;\n    this.decayLevel = state.decayLevel;\n    this.startFlag = state.startFlag;\n    this.loopFlag = state.loopFlag;\n  }\n}\n","/**\n * 長度計數器\n * \n * 用於控制音符的持續時間\n * 當計數器達到 0 時，通道會被靜音\n */\n\nexport class LengthCounter {\n  /** 計數器值 */\n  private counter: number = 0;\n\n  /** 停止旗標 (如果為 true，計數器不會遞減) */\n  private haltFlag: boolean = false;\n\n  constructor() {\n    this.reset();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.counter = 0;\n    this.haltFlag = false;\n  }\n\n  /**\n   * 載入計數器值\n   */\n  public load(value: number): void {\n    this.counter = value;\n  }\n\n  /**\n   * 設定停止旗標\n   */\n  public setHalt(halt: boolean): void {\n    this.haltFlag = halt;\n  }\n\n  /**\n   * 清除計數器\n   */\n  public clear(): void {\n    this.counter = 0;\n  }\n\n  /**\n   * 時鐘 (每個半幀)\n   */\n  public clock(): void {\n    if (!this.haltFlag && this.counter > 0) {\n      this.counter--;\n    }\n  }\n\n  /**\n   * 取得計數器值\n   */\n  public getValue(): number {\n    return this.counter;\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      counter: this.counter,\n      haltFlag: this.haltFlag,\n    };\n  }\n\n  public loadState(state: any): void {\n    this.counter = state.counter;\n    this.haltFlag = state.haltFlag;\n  }\n}\n","/**\n * 掃頻單元\n * \n * 用於脈衝波通道的頻率掃描效果\n * 可以產生音高上升或下降的效果\n */\n\nexport class Sweep {\n  /** 是否為通道 1 (影響否定計算) */\n  private isChannel1: boolean;\n\n  /** 是否啟用 */\n  private enabled: boolean = false;\n\n  /** 掃頻週期 */\n  private period: number = 0;\n\n  /** 否定旗標 */\n  private negate: boolean = false;\n\n  /** 移位量 */\n  private shift: number = 0;\n\n  /** 分頻器 */\n  private divider: number = 0;\n\n  /** 重載旗標 */\n  private reloadFlag: boolean = false;\n\n  /** 當前定時器週期 */\n  private timerPeriod: number = 0;\n\n  constructor(isChannel1: boolean) {\n    this.isChannel1 = isChannel1;\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.enabled = false;\n    this.period = 0;\n    this.negate = false;\n    this.shift = 0;\n    this.divider = 0;\n    this.reloadFlag = false;\n    this.timerPeriod = 0;\n  }\n\n  /**\n   * 寫入暫存器\n   * \n   * EPPP NSSS\n   * E: 啟用\n   * P: 週期\n   * N: 否定\n   * S: 移位量\n   */\n  public write(data: number): void {\n    this.enabled = (data & 0x80) !== 0;\n    this.period = (data >> 4) & 0x07;\n    this.negate = (data & 0x08) !== 0;\n    this.shift = data & 0x07;\n    this.reloadFlag = true;\n  }\n\n  /**\n   * 設定定時器週期\n   */\n  public setTimerPeriod(period: number): void {\n    this.timerPeriod = period;\n  }\n\n  /**\n   * 時鐘 (每個半幀)\n   * 回傳新的定時器週期，或 null 表示不變\n   */\n  public clock(): number | null {\n    // 計算目標週期\n    const changeAmount = this.timerPeriod >> this.shift;\n    let targetPeriod: number;\n\n    if (this.negate) {\n      // 通道 1 和通道 2 的否定計算不同\n      if (this.isChannel1) {\n        targetPeriod = this.timerPeriod - changeAmount - 1;\n      } else {\n        targetPeriod = this.timerPeriod - changeAmount;\n      }\n    } else {\n      targetPeriod = this.timerPeriod + changeAmount;\n    }\n\n    // 檢查分頻器\n    let result: number | null = null;\n\n    if (this.divider === 0 && this.enabled && this.shift > 0 && !this.isMuting(this.timerPeriod)) {\n      if (targetPeriod <= 0x7FF) {\n        this.timerPeriod = targetPeriod;\n        result = targetPeriod;\n      }\n    }\n\n    // 更新分頻器\n    if (this.divider === 0 || this.reloadFlag) {\n      this.divider = this.period;\n      this.reloadFlag = false;\n    } else {\n      this.divider--;\n    }\n\n    return result;\n  }\n\n  /**\n   * 檢查是否應該靜音\n   */\n  public isMuting(currentPeriod: number): boolean {\n    // 週期太小\n    if (currentPeriod < 8) {\n      return true;\n    }\n\n    // 目標週期太大\n    if (!this.negate) {\n      const changeAmount = currentPeriod >> this.shift;\n      const targetPeriod = currentPeriod + changeAmount;\n      if (targetPeriod > 0x7FF) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      enabled: this.enabled,\n      period: this.period,\n      negate: this.negate,\n      shift: this.shift,\n      divider: this.divider,\n      reloadFlag: this.reloadFlag,\n      timerPeriod: this.timerPeriod,\n    };\n  }\n\n  public loadState(state: any): void {\n    this.enabled = state.enabled;\n    this.period = state.period;\n    this.negate = state.negate;\n    this.shift = state.shift;\n    this.divider = state.divider;\n    this.reloadFlag = state.reloadFlag;\n    this.timerPeriod = state.timerPeriod;\n  }\n}\n","/**\n * 脈衝波 (Pulse/Square Wave) 通道\n * \n * 產生可變占空比的方波\n * 占空比: 12.5%, 25%, 50%, 75%\n */\n\nimport { LENGTH_TABLE } from '../tables';\nimport { Envelope } from './envelope';\nimport { LengthCounter } from './length-counter';\nimport { Sweep } from './sweep';\n\n/**\n * 占空比波形表\n * 每個陣列代表一個完整週期的 8 個步驟\n */\nconst DUTY_TABLE: number[][] = [\n  [0, 1, 0, 0, 0, 0, 0, 0], // 12.5%\n  [0, 1, 1, 0, 0, 0, 0, 0], // 25%\n  [0, 1, 1, 1, 1, 0, 0, 0], // 50%\n  [1, 0, 0, 1, 1, 1, 1, 1], // 25% (反相)\n];\n\n/**\n * 脈衝波通道類別\n */\nexport class PulseChannel {\n\n  /** 包絡線生成器 */\n  private envelope: Envelope;\n\n  /** 長度計數器 */\n  private lengthCounter: LengthCounter;\n\n  /** 掃頻單元 */\n  private sweep: Sweep;\n\n  /** 占空比索引 (0-3) */\n  private dutyMode: number = 0;\n\n  /** 波形序列位置 (0-7) */\n  private sequencePos: number = 0;\n\n  /** 定時器值 */\n  private timerPeriod: number = 0;\n  private timerValue: number = 0;\n\n  /** 是否啟用 */\n  private enabled: boolean = false;\n\n  constructor(isChannel1: boolean) {\n    this.envelope = new Envelope();\n    this.lengthCounter = new LengthCounter();\n    this.sweep = new Sweep(isChannel1);\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.envelope.reset();\n    this.lengthCounter.reset();\n    this.sweep.reset();\n    this.dutyMode = 0;\n    this.sequencePos = 0;\n    this.timerPeriod = 0;\n    this.timerValue = 0;\n    this.enabled = false;\n  }\n\n  /**\n   * 寫入控制暫存器 ($4000/$4004)\n   * \n   * DDLC VVVV\n   * D: 占空比\n   * L: 長度計數器停止旗標\n   * C: 常量音量旗標\n   * V: 音量/包絡線週期\n   */\n  public writeControl(data: number): void {\n    this.dutyMode = (data >> 6) & 0x03;\n    this.lengthCounter.setHalt((data & 0x20) !== 0);\n    this.envelope.setConstantVolume((data & 0x10) !== 0);\n    this.envelope.setVolume(data & 0x0F);\n  }\n\n  /**\n   * 寫入掃頻暫存器 ($4001/$4005)\n   * \n   * EPPP NSSS\n   * E: 掃頻啟用\n   * P: 掃頻週期\n   * N: 否定旗標\n   * S: 移位量\n   */\n  public writeSweep(data: number): void {\n    this.sweep.write(data);\n  }\n\n  /**\n   * 寫入定時器低位元組 ($4002/$4006)\n   */\n  public writeTimerLow(data: number): void {\n    this.timerPeriod = (this.timerPeriod & 0x700) | data;\n    this.sweep.setTimerPeriod(this.timerPeriod);\n  }\n\n  /**\n   * 寫入定時器高位元組和長度計數器 ($4003/$4007)\n   * \n   * LLLL LTTT\n   * L: 長度計數器載入值\n   * T: 定時器高 3 位元\n   */\n  public writeTimerHigh(data: number): void {\n    this.timerPeriod = (this.timerPeriod & 0x0FF) | ((data & 0x07) << 8);\n    this.sweep.setTimerPeriod(this.timerPeriod);\n\n    if (this.enabled) {\n      const lengthIndex = (data >> 3) & 0x1F;\n      this.lengthCounter.load(LENGTH_TABLE[lengthIndex]);\n    }\n\n    this.sequencePos = 0;\n    this.envelope.start();\n  }\n\n  /**\n   * 定時器時鐘\n   */\n  public clockTimer(): void {\n    if (this.timerValue === 0) {\n      this.timerValue = this.timerPeriod;\n      this.sequencePos = (this.sequencePos + 1) & 0x07;\n    } else {\n      this.timerValue--;\n    }\n  }\n\n  /**\n   * 包絡線時鐘\n   */\n  public clockEnvelope(): void {\n    this.envelope.clock();\n  }\n\n  /**\n   * 長度計數器時鐘\n   */\n  public clockLengthCounter(): void {\n    this.lengthCounter.clock();\n  }\n\n  /**\n   * 掃頻時鐘\n   */\n  public clockSweep(): void {\n    const newPeriod = this.sweep.clock();\n    if (newPeriod !== null) {\n      this.timerPeriod = newPeriod;\n    }\n  }\n\n  /**\n   * 取得輸出值\n   */\n  public output(): number {\n    // 靜音條件\n    if (!this.enabled) return 0;\n    if (this.lengthCounter.getValue() === 0) return 0;\n    if (this.timerPeriod < 8) return 0; // 頻率太高\n    if (this.sweep.isMuting(this.timerPeriod)) return 0;\n\n    // 取得波形值\n    const waveform = DUTY_TABLE[this.dutyMode][this.sequencePos];\n    if (waveform === 0) return 0;\n\n    // 回傳包絡線音量\n    return this.envelope.output();\n  }\n\n  /**\n   * 設定是否啟用\n   */\n  public setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n    if (!enabled) {\n      this.lengthCounter.clear();\n    }\n  }\n\n  /**\n   * 取得長度計數器值\n   */\n  public getLengthCounter(): number {\n    return this.lengthCounter.getValue();\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      dutyMode: this.dutyMode,\n      sequencePos: this.sequencePos,\n      timerPeriod: this.timerPeriod,\n      timerValue: this.timerValue,\n      enabled: this.enabled,\n      envelope: this.envelope.saveState(),\n      lengthCounter: this.lengthCounter.saveState(),\n      sweep: this.sweep.saveState(),\n    };\n  }\n\n  public loadState(state: any): void {\n    this.dutyMode = state.dutyMode;\n    this.sequencePos = state.sequencePos;\n    this.timerPeriod = state.timerPeriod;\n    this.timerValue = state.timerValue;\n    this.enabled = state.enabled;\n    this.envelope.loadState(state.envelope);\n    this.lengthCounter.loadState(state.lengthCounter);\n    this.sweep.loadState(state.sweep);\n  }\n}\n","/**\n * 三角波 (Triangle Wave) 通道\n * \n * 產生 32 步階梯式的三角波\n * 頻率範圍較其他通道更低\n */\n\nimport { LENGTH_TABLE } from '../tables';\nimport { LengthCounter } from './length-counter';\n\n/**\n * 三角波序列表 (32 步)\n */\nconst TRIANGLE_SEQUENCE: number[] = [\n  15, 14, 13, 12, 11, 10,  9,  8,  7,  6,  5,  4,  3,  2,  1,  0,\n   0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15,\n];\n\n/**\n * 三角波通道類別\n */\nexport class TriangleChannel {\n  /** 長度計數器 */\n  private lengthCounter: LengthCounter;\n\n  /** 線性計數器控制/停止旗標 */\n  private controlFlag: boolean = false;\n\n  /** 線性計數器重載值 */\n  private linearCounterReload: number = 0;\n\n  /** 線性計數器值 */\n  private linearCounter: number = 0;\n\n  /** 線性計數器重載旗標 */\n  private linearCounterReloadFlag: boolean = false;\n\n  /** 序列位置 (0-31) */\n  private sequencePos: number = 0;\n\n  /** 定時器週期 */\n  private timerPeriod: number = 0;\n\n  /** 定時器值 */\n  private timerValue: number = 0;\n\n  /** 是否啟用 */\n  private enabled: boolean = false;\n\n  constructor() {\n    this.lengthCounter = new LengthCounter();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.lengthCounter.reset();\n    this.controlFlag = false;\n    this.linearCounterReload = 0;\n    this.linearCounter = 0;\n    this.linearCounterReloadFlag = false;\n    this.sequencePos = 0;\n    this.timerPeriod = 0;\n    this.timerValue = 0;\n    this.enabled = false;\n  }\n\n  /**\n   * 寫入控制暫存器 ($4008)\n   * \n   * CRRR RRRR\n   * C: 控制旗標 (長度計數器停止)\n   * R: 線性計數器重載值\n   */\n  public writeControl(data: number): void {\n    this.controlFlag = (data & 0x80) !== 0;\n    this.lengthCounter.setHalt(this.controlFlag);\n    this.linearCounterReload = data & 0x7F;\n  }\n\n  /**\n   * 寫入定時器低位元組 ($400A)\n   */\n  public writeTimerLow(data: number): void {\n    this.timerPeriod = (this.timerPeriod & 0x700) | data;\n  }\n\n  /**\n   * 寫入定時器高位元組和長度計數器 ($400B)\n   * \n   * LLLL LTTT\n   * L: 長度計數器載入值\n   * T: 定時器高 3 位元\n   */\n  public writeTimerHigh(data: number): void {\n    this.timerPeriod = (this.timerPeriod & 0x0FF) | ((data & 0x07) << 8);\n\n    if (this.enabled) {\n      const lengthIndex = (data >> 3) & 0x1F;\n      this.lengthCounter.load(LENGTH_TABLE[lengthIndex]);\n    }\n\n    this.linearCounterReloadFlag = true;\n  }\n\n  /**\n   * 定時器時鐘 (每個 CPU 週期)\n   */\n  public clockTimer(): void {\n    if (this.timerValue === 0) {\n      this.timerValue = this.timerPeriod;\n\n      // 只有當兩個計數器都 > 0 時才更新序列\n      if (this.lengthCounter.getValue() > 0 && this.linearCounter > 0) {\n        this.sequencePos = (this.sequencePos + 1) & 0x1F;\n      }\n    } else {\n      this.timerValue--;\n    }\n  }\n\n  /**\n   * 線性計數器時鐘 (每個半幀)\n   */\n  public clockLinearCounter(): void {\n    if (this.linearCounterReloadFlag) {\n      this.linearCounter = this.linearCounterReload;\n    } else if (this.linearCounter > 0) {\n      this.linearCounter--;\n    }\n\n    if (!this.controlFlag) {\n      this.linearCounterReloadFlag = false;\n    }\n  }\n\n  /**\n   * 長度計數器時鐘\n   */\n  public clockLengthCounter(): void {\n    this.lengthCounter.clock();\n  }\n\n  /**\n   * 取得輸出值\n   */\n  public output(): number {\n    if (!this.enabled) return 0;\n    if (this.lengthCounter.getValue() === 0) return 0;\n    if (this.linearCounter === 0) return 0;\n    \n    // 避免高頻時產生的噪音 (超音波)\n    if (this.timerPeriod < 2) return 7; // 回傳中間值\n\n    return TRIANGLE_SEQUENCE[this.sequencePos];\n  }\n\n  /**\n   * 設定是否啟用\n   */\n  public setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n    if (!enabled) {\n      this.lengthCounter.clear();\n    }\n  }\n\n  /**\n   * 取得長度計數器值\n   */\n  public getLengthCounter(): number {\n    return this.lengthCounter.getValue();\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      controlFlag: this.controlFlag,\n      linearCounterReload: this.linearCounterReload,\n      linearCounter: this.linearCounter,\n      linearCounterReloadFlag: this.linearCounterReloadFlag,\n      sequencePos: this.sequencePos,\n      timerPeriod: this.timerPeriod,\n      timerValue: this.timerValue,\n      enabled: this.enabled,\n      lengthCounter: this.lengthCounter.saveState(),\n    };\n  }\n\n  public loadState(state: any): void {\n    this.controlFlag = state.controlFlag;\n    this.linearCounterReload = state.linearCounterReload;\n    this.linearCounter = state.linearCounter;\n    this.linearCounterReloadFlag = state.linearCounterReloadFlag;\n    this.sequencePos = state.sequencePos;\n    this.timerPeriod = state.timerPeriod;\n    this.timerValue = state.timerValue;\n    this.enabled = state.enabled;\n    this.lengthCounter.loadState(state.lengthCounter);\n  }\n}\n","/**\n * 雜訊 (Noise) 通道\n * \n * 使用線性回饋移位暫存器 (LFSR) 產生虛擬隨機雜訊\n * 支援兩種模式：普通模式和短週期模式\n */\n\nimport { LENGTH_TABLE } from '../tables';\nimport { Envelope } from './envelope';\nimport { LengthCounter } from './length-counter';\n\n/**\n * 雜訊週期表 (NTSC)\n */\nconst NOISE_PERIOD_TABLE: number[] = [\n  4, 8, 16, 32, 64, 96, 128, 160, 202, 254, 380, 508, 762, 1016, 2034, 4068\n];\n\n/**\n * 雜訊通道類別\n */\nexport class NoiseChannel {\n  /** 包絡線生成器 */\n  private envelope: Envelope;\n\n  /** 長度計數器 */\n  private lengthCounter: LengthCounter;\n\n  /** 移位暫存器 (15 位元) */\n  private shiftRegister: number = 1;\n\n  /** 模式旗標 (短週期模式) */\n  private mode: boolean = false;\n\n  /** 定時器週期 */\n  private timerPeriod: number = 0;\n\n  /** 定時器值 */\n  private timerValue: number = 0;\n\n  /** 是否啟用 */\n  private enabled: boolean = false;\n\n  constructor() {\n    this.envelope = new Envelope();\n    this.lengthCounter = new LengthCounter();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.envelope.reset();\n    this.lengthCounter.reset();\n    this.shiftRegister = 1;\n    this.mode = false;\n    this.timerPeriod = 0;\n    this.timerValue = 0;\n    this.enabled = false;\n  }\n\n  /**\n   * 寫入控制暫存器 ($400C)\n   * \n   * --LC VVVV\n   * L: 長度計數器停止旗標\n   * C: 常量音量旗標\n   * V: 音量/包絡線週期\n   */\n  public writeControl(data: number): void {\n    this.lengthCounter.setHalt((data & 0x20) !== 0);\n    this.envelope.setConstantVolume((data & 0x10) !== 0);\n    this.envelope.setVolume(data & 0x0F);\n  }\n\n  /**\n   * 寫入週期暫存器 ($400E)\n   * \n   * M--- PPPP\n   * M: 模式旗標\n   * P: 週期索引\n   */\n  public writePeriod(data: number): void {\n    this.mode = (data & 0x80) !== 0;\n    this.timerPeriod = NOISE_PERIOD_TABLE[data & 0x0F];\n  }\n\n  /**\n   * 寫入長度計數器 ($400F)\n   * \n   * LLLL L---\n   * L: 長度計數器載入值\n   */\n  public writeLength(data: number): void {\n    if (this.enabled) {\n      const lengthIndex = (data >> 3) & 0x1F;\n      this.lengthCounter.load(LENGTH_TABLE[lengthIndex]);\n    }\n    this.envelope.start();\n  }\n\n  /**\n   * 定時器時鐘\n   */\n  public clockTimer(): void {\n    if (this.timerValue === 0) {\n      this.timerValue = this.timerPeriod;\n      this.clockShiftRegister();\n    } else {\n      this.timerValue--;\n    }\n  }\n\n  /**\n   * 移位暫存器時鐘\n   */\n  private clockShiftRegister(): void {\n    // 計算回饋位元\n    const bit0 = this.shiftRegister & 1;\n    const bit1 = this.mode \n      ? (this.shiftRegister >> 6) & 1  // 短週期模式: bit 0 XOR bit 6\n      : (this.shiftRegister >> 1) & 1; // 普通模式: bit 0 XOR bit 1\n\n    const feedback = bit0 ^ bit1;\n\n    // 右移並設定最高位元\n    this.shiftRegister = (this.shiftRegister >> 1) | (feedback << 14);\n  }\n\n  /**\n   * 包絡線時鐘\n   */\n  public clockEnvelope(): void {\n    this.envelope.clock();\n  }\n\n  /**\n   * 長度計數器時鐘\n   */\n  public clockLengthCounter(): void {\n    this.lengthCounter.clock();\n  }\n\n  /**\n   * 取得輸出值\n   */\n  public output(): number {\n    if (!this.enabled) return 0;\n    if (this.lengthCounter.getValue() === 0) return 0;\n    \n    // 如果移位暫存器的 bit 0 為 1，輸出 0\n    if (this.shiftRegister & 1) return 0;\n\n    return this.envelope.output();\n  }\n\n  /**\n   * 設定是否啟用\n   */\n  public setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n    if (!enabled) {\n      this.lengthCounter.clear();\n    }\n  }\n\n  /**\n   * 取得長度計數器值\n   */\n  public getLengthCounter(): number {\n    return this.lengthCounter.getValue();\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      shiftRegister: this.shiftRegister,\n      mode: this.mode,\n      timerPeriod: this.timerPeriod,\n      timerValue: this.timerValue,\n      enabled: this.enabled,\n      envelope: this.envelope.saveState(),\n      lengthCounter: this.lengthCounter.saveState(),\n    };\n  }\n\n  public loadState(state: any): void {\n    this.shiftRegister = state.shiftRegister;\n    this.mode = state.mode;\n    this.timerPeriod = state.timerPeriod;\n    this.timerValue = state.timerValue;\n    this.enabled = state.enabled;\n    this.envelope.loadState(state.envelope);\n    this.lengthCounter.loadState(state.lengthCounter);\n  }\n}\n","/**\n * DMC (Delta Modulation Channel) 通道\n * \n * 播放 1 位元 delta 調製的取樣資料\n * 可以直接從 PRG ROM 讀取取樣\n */\n\n/**\n * DMC 週期表 (NTSC)\n */\nconst DMC_PERIOD_TABLE: number[] = [\n  428, 380, 340, 320, 286, 254, 226, 214, 190, 160, 142, 128, 106, 84, 72, 54\n];\n\n/**\n * DMC 通道類別\n */\nexport class DmcChannel {\n  /** 記憶體讀取回調 */\n  private memoryReader: ((address: number) => number) | null = null;\n\n  /** IRQ 回調 */\n  private irqCallback: (() => void) | null = null;\n\n  /** IRQ 啟用旗標 */\n  private irqEnabled: boolean = false;\n\n  /** 迴圈旗標 */\n  private loop: boolean = false;\n\n  /** 定時器週期 */\n  private timerPeriod: number = 0;\n\n  /** 定時器值 */\n  private timerValue: number = 0;\n\n  /** 輸出電平 (7 位元) */\n  private outputLevel: number = 0;\n\n  /** 取樣位址 */\n  private sampleAddress: number = 0;\n\n  /** 當前位址 */\n  private currentAddress: number = 0;\n\n  /** 取樣長度 */\n  private sampleLength: number = 0;\n\n  /** 剩餘位元組 */\n  private bytesRemaining: number = 0;\n\n  /** 取樣緩衝區 */\n  private sampleBuffer: number = 0;\n\n  /** 緩衝區是否為空 */\n  private bufferEmpty: boolean = true;\n\n  /** 移位暫存器 */\n  private shiftRegister: number = 0;\n\n  /** 位元計數器 */\n  private bitsRemaining: number = 0;\n\n  /** 是否靜音 */\n  private silence: boolean = true;\n\n  /** IRQ 旗標 */\n  private irqFlag: boolean = false;\n\n  constructor() {\n    this.reset();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.irqEnabled = false;\n    this.loop = false;\n    this.timerPeriod = 0;\n    this.timerValue = 0;\n    this.outputLevel = 0;\n    this.sampleAddress = 0xC000;\n    this.currentAddress = 0xC000;\n    this.sampleLength = 0;\n    this.bytesRemaining = 0;\n    this.sampleBuffer = 0;\n    this.bufferEmpty = true;\n    this.shiftRegister = 0;\n    this.bitsRemaining = 8;\n    this.silence = true;\n    this.irqFlag = false;\n  }\n\n  /**\n   * 設定記憶體讀取器\n   */\n  public setMemoryReader(reader: (address: number) => number): void {\n    this.memoryReader = reader;\n  }\n\n  /**\n   * 設定 IRQ 回調\n   */\n  public setIrqCallback(callback: () => void): void {\n    this.irqCallback = callback;\n  }\n\n  /**\n   * 寫入控制暫存器 ($4010)\n   * \n   * IL-- RRRR\n   * I: IRQ 啟用\n   * L: 迴圈旗標\n   * R: 週期索引\n   */\n  public writeControl(data: number): void {\n    this.irqEnabled = (data & 0x80) !== 0;\n    this.loop = (data & 0x40) !== 0;\n    this.timerPeriod = DMC_PERIOD_TABLE[data & 0x0F];\n\n    if (!this.irqEnabled) {\n      this.irqFlag = false;\n    }\n  }\n\n  /**\n   * 寫入直接載入 ($4011)\n   * \n   * -DDD DDDD\n   * D: 直接載入到輸出電平\n   */\n  public writeDirectLoad(data: number): void {\n    this.outputLevel = data & 0x7F;\n  }\n\n  /**\n   * 寫入取樣位址 ($4012)\n   * \n   * AAAA AAAA\n   * 位址 = $C000 + (A * 64)\n   */\n  public writeAddress(data: number): void {\n    this.sampleAddress = 0xC000 | (data << 6);\n  }\n\n  /**\n   * 寫入取樣長度 ($4013)\n   * \n   * LLLL LLLL\n   * 長度 = (L * 16) + 1\n   */\n  public writeLength(data: number): void {\n    this.sampleLength = (data << 4) | 1;\n  }\n\n  /**\n   * 定時器時鐘\n   */\n  public clockTimer(): void {\n    if (!this.silence) {\n      if (this.shiftRegister & 1) {\n        // 增加輸出電平\n        if (this.outputLevel <= 125) {\n          this.outputLevel += 2;\n        }\n      } else {\n        // 減少輸出電平\n        if (this.outputLevel >= 2) {\n          this.outputLevel -= 2;\n        }\n      }\n    }\n\n    this.shiftRegister >>= 1;\n    this.bitsRemaining--;\n\n    if (this.bitsRemaining === 0) {\n      this.bitsRemaining = 8;\n      this.startOutputCycle();\n    }\n  }\n\n  /**\n   * 開始輸出週期\n   */\n  private startOutputCycle(): void {\n    if (this.bufferEmpty) {\n      this.silence = true;\n    } else {\n      this.silence = false;\n      this.shiftRegister = this.sampleBuffer;\n      this.bufferEmpty = true;\n      this.fetchSample();\n    }\n  }\n\n  /**\n   * 讀取取樣\n   */\n  private fetchSample(): void {\n    if (this.bytesRemaining > 0 && this.bufferEmpty) {\n      // 從記憶體讀取取樣\n      if (this.memoryReader) {\n        this.sampleBuffer = this.memoryReader(this.currentAddress);\n        this.bufferEmpty = false;\n      }\n\n      // 更新位址\n      this.currentAddress = ((this.currentAddress + 1) & 0xFFFF) | 0x8000;\n      this.bytesRemaining--;\n\n      // 檢查是否完成\n      if (this.bytesRemaining === 0) {\n        if (this.loop) {\n          // 重新開始\n          this.currentAddress = this.sampleAddress;\n          this.bytesRemaining = this.sampleLength;\n        } else if (this.irqEnabled) {\n          // 觸發 IRQ\n          this.irqFlag = true;\n          if (this.irqCallback) {\n            this.irqCallback();\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * 取得輸出值\n   */\n  public output(): number {\n    return this.outputLevel;\n  }\n\n  /**\n   * 設定是否啟用\n   */\n  public setEnabled(enabled: boolean): void {\n    if (!enabled) {\n      this.bytesRemaining = 0;\n    } else {\n      if (this.bytesRemaining === 0) {\n        this.currentAddress = this.sampleAddress;\n        this.bytesRemaining = this.sampleLength;\n      }\n    }\n    this.irqFlag = false;\n  }\n\n  /**\n   * 取得剩餘位元組數\n   */\n  public getBytesRemaining(): number {\n    return this.bytesRemaining;\n  }\n\n  /**\n   * 取得 IRQ 旗標\n   */\n  public getIrqFlag(): boolean {\n    return this.irqFlag;\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      irqEnabled: this.irqEnabled,\n      loop: this.loop,\n      timerPeriod: this.timerPeriod,\n      timerValue: this.timerValue,\n      outputLevel: this.outputLevel,\n      sampleAddress: this.sampleAddress,\n      currentAddress: this.currentAddress,\n      sampleLength: this.sampleLength,\n      bytesRemaining: this.bytesRemaining,\n      sampleBuffer: this.sampleBuffer,\n      bufferEmpty: this.bufferEmpty,\n      shiftRegister: this.shiftRegister,\n      bitsRemaining: this.bitsRemaining,\n      silence: this.silence,\n      irqFlag: this.irqFlag,\n    };\n  }\n\n  public loadState(state: any): void {\n    this.irqEnabled = state.irqEnabled;\n    this.loop = state.loop;\n    this.timerPeriod = state.timerPeriod;\n    this.timerValue = state.timerValue;\n    this.outputLevel = state.outputLevel;\n    this.sampleAddress = state.sampleAddress;\n    this.currentAddress = state.currentAddress;\n    this.sampleLength = state.sampleLength;\n    this.bytesRemaining = state.bytesRemaining;\n    this.sampleBuffer = state.sampleBuffer;\n    this.bufferEmpty = state.bufferEmpty;\n    this.shiftRegister = state.shiftRegister;\n    this.bitsRemaining = state.bitsRemaining;\n    this.silence = state.silence;\n    this.irqFlag = state.irqFlag;\n  }\n}\n","/**\n * APU 幀計數器\n * \n * 控制包絡線、長度計數器和掃頻單元的時序\n * 支援 4 步模式和 5 步模式\n */\n\n/**\n * 幀計數器模式\n */\nexport enum FrameCounterMode {\n  /** 4 步模式 (產生 IRQ) */\n  FourStep = 0,\n  /** 5 步模式 (不產生 IRQ) */\n  FiveStep = 1,\n}\n\n/**\n * 4 步序列 (以 CPU 週期為單位)\n * 每個值表示該步驟觸發的時間點\n */\nconst FOUR_STEP_SEQUENCE = [7457, 14913, 22371, 29829];\n\n/**\n * 5 步序列 (以 CPU 週期為單位)\n */\nconst FIVE_STEP_SEQUENCE = [7457, 14913, 22371, 29829, 37281];\n\n/**\n * 幀計數器類別\n */\nexport class FrameCounter {\n  /** 模式 */\n  private mode: FrameCounterMode = FrameCounterMode.FourStep;\n\n  /** IRQ 禁用旗標 */\n  private irqInhibit: boolean = false;\n\n  /** 時鐘計數器 */\n  private clockCounter: number = 0;\n\n  /** 當前步驟 */\n  private currentStep: number = 0;\n\n  /** IRQ 旗標 */\n  private irqFlag: boolean = false;\n\n  /** IRQ 回調 */\n  private irqCallback: (() => void) | null = null;\n\n  constructor() {\n    this.reset();\n  }\n\n  /**\n   * 重置\n   */\n  public reset(): void {\n    this.mode = FrameCounterMode.FourStep;\n    this.irqInhibit = false;\n    this.clockCounter = 0;\n    this.currentStep = 0;\n    this.irqFlag = false;\n  }\n\n  /**\n   * 設定 IRQ 回調\n   */\n  public setIrqCallback(callback: () => void): void {\n    this.irqCallback = callback;\n  }\n\n  /**\n   * 寫入暫存器 ($4017)\n   * \n   * MI-- ----\n   * M: 模式 (0 = 4步, 1 = 5步)\n   * I: IRQ 禁用\n   */\n  public write(data: number): void {\n    this.mode = (data & 0x80) ? FrameCounterMode.FiveStep : FrameCounterMode.FourStep;\n    this.irqInhibit = (data & 0x40) !== 0;\n\n    if (this.irqInhibit) {\n      this.irqFlag = false;\n    }\n\n    // 重置計數器\n    this.clockCounter = 0;\n    this.currentStep = 0;\n\n    // 5 步模式在寫入時立即觸發一次\n    if (this.mode === FrameCounterMode.FiveStep) {\n      // 立即觸發半幀和四分之一幀\n      return; // 回傳到主循環處理\n    }\n  }\n\n  /**\n   * 時鐘 (每個 CPU 週期呼叫)\n   * 回傳需要執行的動作:\n   * - 0: 無動作\n   * - 1: 四分之一幀 (包絡線 & 線性計數器)\n   * - 2: 半幀 (長度計數器 & 掃頻)\n   * - 3: 兩者都執行\n   */\n  public clock(): number {\n    this.clockCounter++;\n\n    const sequence = this.mode === FrameCounterMode.FourStep \n      ? FOUR_STEP_SEQUENCE \n      : FIVE_STEP_SEQUENCE;\n\n    if (this.currentStep >= sequence.length) {\n      return 0;\n    }\n\n    if (this.clockCounter >= sequence[this.currentStep]) {\n      let action = 0;\n\n      if (this.mode === FrameCounterMode.FourStep) {\n        // 4 步模式\n        switch (this.currentStep) {\n          case 0: // 步驟 1: 四分之一幀\n            action = 1;\n            break;\n          case 1: // 步驟 2: 半幀\n            action = 3;\n            break;\n          case 2: // 步驟 3: 四分之一幀\n            action = 1;\n            break;\n          case 3: // 步驟 4: 半幀 + IRQ\n            action = 3;\n            if (!this.irqInhibit) {\n              this.irqFlag = true;\n              if (this.irqCallback) {\n                this.irqCallback();\n              }\n            }\n            // 重置計數器\n            this.clockCounter = 0;\n            this.currentStep = -1; // 會在下面 +1\n            break;\n        }\n      } else {\n        // 5 步模式\n        switch (this.currentStep) {\n          case 0: // 步驟 1: 四分之一幀\n            action = 1;\n            break;\n          case 1: // 步驟 2: 半幀\n            action = 3;\n            break;\n          case 2: // 步驟 3: 四分之一幀\n            action = 1;\n            break;\n          case 3: // 步驟 4: 無動作\n            action = 0;\n            break;\n          case 4: // 步驟 5: 半幀\n            action = 3;\n            // 重置計數器\n            this.clockCounter = 0;\n            this.currentStep = -1;\n            break;\n        }\n      }\n\n      this.currentStep++;\n      return action;\n    }\n\n    return 0;\n  }\n\n  /**\n   * 取得 IRQ 旗標\n   */\n  public getIrqFlag(): boolean {\n    return this.irqFlag;\n  }\n\n  /**\n   * 清除 IRQ 旗標\n   */\n  public clearIrqFlag(): void {\n    this.irqFlag = false;\n  }\n\n  // ===== 序列化 =====\n\n  public saveState(): object {\n    return {\n      mode: this.mode,\n      irqInhibit: this.irqInhibit,\n      clockCounter: this.clockCounter,\n      currentStep: this.currentStep,\n      irqFlag: this.irqFlag,\n    };\n  }\n\n  public loadState(state: any): void {\n    this.mode = state.mode;\n    this.irqInhibit = state.irqInhibit;\n    this.clockCounter = state.clockCounter;\n    this.currentStep = state.currentStep;\n    this.irqFlag = state.irqFlag;\n  }\n}\n","/**\n * NES APU (Audio Processing Unit) 模擬器\n * \n * APU 規格：\n * - 2 個脈衝波 (Pulse/Square) 通道\n * - 1 個三角波 (Triangle) 通道\n * - 1 個雜訊 (Noise) 通道\n * - 1 個 DMC (Delta Modulation Channel) 通道\n * \n * 暫存器映射 ($4000-$4017):\n * $4000-$4003: 脈衝波 1\n * $4004-$4007: 脈衝波 2\n * $4008-$400B: 三角波\n * $400C-$400F: 雜訊\n * $4010-$4013: DMC\n * $4015: 狀態/控制\n * $4017: 幀計數器\n */\n\nimport { PulseChannel } from './channels/pulse';\nimport { TriangleChannel } from './channels/triangle';\nimport { NoiseChannel } from './channels/noise';\nimport { DmcChannel } from './channels/dmc';\nimport { FrameCounter } from './frame-counter';\n\n/**\n * 音頻回調函數類型\n */\nexport type AudioCallback = (sample: number) => void;\n\n/**\n * APU 類別\n */\nexport class Apu {\n  // ===== 音頻通道 =====\n  /** 脈衝波通道 1 */\n  private pulse1: PulseChannel;\n  \n  /** 脈衝波通道 2 */\n  private pulse2: PulseChannel;\n  \n  /** 三角波通道 */\n  private triangle: TriangleChannel;\n  \n  /** 雜訊通道 */\n  private noise: NoiseChannel;\n  \n  /** DMC 通道 */\n  private dmc: DmcChannel;\n\n  // ===== 幀計數器 =====\n  /** 幀計數器 */\n  private frameCounter: FrameCounter;\n\n  // ===== 狀態 =====\n  /** 狀態暫存器 ($4015) */\n  private statusRegister: number = 0;\n\n  /** 時鐘計數器 */\n  private clockCounter: number = 0;\n\n  /** 取樣計數器 */\n  private sampleCounter: number = 0;\n\n  /** 取樣率 */\n  private sampleRate: number = 44100;\n\n  /** NES CPU 時鐘頻率 */\n  private readonly CPU_FREQUENCY: number = 1789773;\n\n  /** 每個取樣的 CPU 週期數 */\n  private cyclesPerSample: number;\n\n  /** 音頻回調 */\n  private audioCallback: AudioCallback | null = null;\n\n  /** 音頻緩衝區 (環形緩衝區) */\n  private audioBuffer: Float32Array;\n  private writeIndex: number = 0;\n  private readIndex: number = 0;\n  private readonly BUFFER_SIZE: number = 8192; // 增大緩衝區\n\n  /** 低通濾波器狀態 */\n  private filterAccumulator: number = 0;\n  private readonly FILTER_COEFFICIENT: number = 0.9; // 提高濾波強度\n\n  /** 高通濾波器狀態 (移除直流偏移) */\n  private highPassPrev: number = 0;\n  private highPassOutput: number = 0;\n  private readonly HIGHPASS_COEFFICIENT: number = 0.996;\n\n\n\n  constructor() {\n    this.pulse1 = new PulseChannel(true); // 通道 1 有掃頻否定差異\n    this.pulse2 = new PulseChannel(false);\n    this.triangle = new TriangleChannel();\n    this.noise = new NoiseChannel();\n    this.dmc = new DmcChannel();\n\n    this.frameCounter = new FrameCounter();\n\n    this.cyclesPerSample = this.CPU_FREQUENCY / this.sampleRate;\n    this.audioBuffer = new Float32Array(this.BUFFER_SIZE);\n\n    this.reset();\n  }\n\n  /**\n   * 重置 APU\n   */\n  public reset(): void {\n    this.pulse1.reset();\n    this.pulse2.reset();\n    this.triangle.reset();\n    this.noise.reset();\n    this.dmc.reset();\n    this.frameCounter.reset();\n\n    this.statusRegister = 0;\n    this.clockCounter = 0;\n    this.sampleCounter = 0;\n    this.writeIndex = 0;\n    this.readIndex = 0;\n    this.filterAccumulator = 0;\n    this.highPassPrev = 0;\n    this.highPassOutput = 0;\n    this.audioBuffer.fill(0);\n  }\n\n  /**\n   * 設定音頻回調\n   */\n  public setAudioCallback(callback: AudioCallback): void {\n    this.audioCallback = callback;\n  }\n\n  /**\n   * 設定取樣率\n   */\n  public setSampleRate(rate: number): void {\n    this.sampleRate = rate;\n    this.cyclesPerSample = this.CPU_FREQUENCY / rate;\n  }\n\n  /**\n   * 設定記憶體讀取器 (用於 DMC)\n   */\n  public setMemoryReader(reader: (address: number) => number): void {\n    this.dmc.setMemoryReader(reader);\n  }\n\n  /**\n   * 設定 IRQ 回調\n   */\n  public setIrqCallback(callback: () => void): void {\n    this.frameCounter.setIrqCallback(callback);\n    this.dmc.setIrqCallback(callback);\n  }\n\n  /**\n   * CPU 時鐘\n   * APU 每個 CPU 週期執行一次\n   */\n  public clock(): void {\n    // 三角波每個 CPU 週期更新\n    this.triangle.clockTimer();\n\n    // 其他通道每 2 個 CPU 週期更新一次 (APU 週期)\n    if (this.clockCounter % 2 === 0) {\n      this.pulse1.clockTimer();\n      this.pulse2.clockTimer();\n      this.noise.clockTimer();\n      this.dmc.clockTimer();\n    }\n\n    // 幀計數器\n    const frameAction = this.frameCounter.clock();\n    if (frameAction) {\n      this.handleFrameAction(frameAction);\n    }\n\n    // 生成取樣\n    this.sampleCounter += 1;\n    if (this.sampleCounter >= this.cyclesPerSample) {\n      this.sampleCounter -= this.cyclesPerSample;\n      this.generateSample();\n    }\n\n    this.clockCounter++;\n  }\n\n  /**\n   * 處理幀計數器動作\n   */\n  private handleFrameAction(action: number): void {\n    // Bit 0: 包絡線 & 三角波線性計數器\n    if (action & 1) {\n      this.pulse1.clockEnvelope();\n      this.pulse2.clockEnvelope();\n      this.triangle.clockLinearCounter();\n      this.noise.clockEnvelope();\n    }\n\n    // Bit 1: 長度計數器 & 掃頻\n    if (action & 2) {\n      this.pulse1.clockLengthCounter();\n      this.pulse1.clockSweep();\n      this.pulse2.clockLengthCounter();\n      this.pulse2.clockSweep();\n      this.triangle.clockLengthCounter();\n      this.noise.clockLengthCounter();\n    }\n  }\n\n  /**\n   * 生成一個音頻取樣\n   */\n  private generateSample(): void {\n    // 取得各通道輸出 (0-15 範圍)\n    const pulse1 = this.pulse1.output();\n    const pulse2 = this.pulse2.output();\n    const triangle = this.triangle.output();\n    const noise = this.noise.output();\n    const dmc = this.dmc.output();\n\n    // 混音 (使用 NES 非線性混音公式)\n    const pulseOut = this.mixPulse(pulse1, pulse2);\n    const tndOut = this.mixTnd(triangle, noise, dmc);\n\n    // 合併 (輸出範圍約 0 到 1)\n    let sample = pulseOut + tndOut;\n    \n    // 應用低通濾波器減少高頻噪音\n    this.filterAccumulator = this.filterAccumulator * this.FILTER_COEFFICIENT + \n                             sample * (1 - this.FILTER_COEFFICIENT);\n    sample = this.filterAccumulator;\n\n    // 應用高通濾波器移除直流偏移\n    const input = sample;\n    this.highPassOutput = this.HIGHPASS_COEFFICIENT * this.highPassOutput + \n                          input - this.highPassPrev;\n    this.highPassPrev = input;\n    sample = this.highPassOutput;\n    \n    // 縮放到 [-1, 1] 範圍並調整音量\n    sample = sample * 1.5; // 適度放大\n    \n    // 軟削波避免爆音\n    if (sample > 0.95) {\n      sample = 0.95 + (sample - 0.95) * 0.2;\n    } else if (sample < -0.95) {\n      sample = -0.95 + (sample + 0.95) * 0.2;\n    }\n    \n    // 最終限制\n    sample = Math.max(-1, Math.min(1, sample));\n\n    // 寫入環形緩衝區\n    this.audioBuffer[this.writeIndex] = sample;\n    this.writeIndex = (this.writeIndex + 1) % this.BUFFER_SIZE;\n  }\n\n  /**\n   * 脈衝波混音 (非線性)\n   * 輸出範圍: 0 到約 0.26\n   */\n  private mixPulse(pulse1: number, pulse2: number): number {\n    const sum = pulse1 + pulse2;\n    if (sum === 0) {\n      return 0;\n    }\n    return 95.88 / (8128 / sum + 100);\n  }\n\n  /**\n   * 三角波/雜訊/DMC 混音 (非線性)\n   * 輸出範圍: 0 到約 0.74\n   */\n  private mixTnd(triangle: number, noise: number, dmc: number): number {\n    if (triangle === 0 && noise === 0 && dmc === 0) {\n      return 0;\n    }\n    const tnd = triangle / 8227 + noise / 12241 + dmc / 22638;\n    if (tnd === 0) {\n      return 0;\n    }\n    return 159.79 / (1 / tnd + 100);\n  }\n\n  /**\n   * CPU 讀取暫存器\n   */\n  public cpuRead(address: number): number {\n    if (address === 0x4015) {\n      return this.readStatus();\n    }\n    return 0;\n  }\n\n  /**\n   * CPU 寫入暫存器\n   */\n  public cpuWrite(address: number, data: number): void {\n    data &= 0xFF;\n\n    switch (address) {\n      // 脈衝波 1\n      case 0x4000:\n        this.pulse1.writeControl(data);\n        break;\n      case 0x4001:\n        this.pulse1.writeSweep(data);\n        break;\n      case 0x4002:\n        this.pulse1.writeTimerLow(data);\n        break;\n      case 0x4003:\n        this.pulse1.writeTimerHigh(data);\n        break;\n\n      // 脈衝波 2\n      case 0x4004:\n        this.pulse2.writeControl(data);\n        break;\n      case 0x4005:\n        this.pulse2.writeSweep(data);\n        break;\n      case 0x4006:\n        this.pulse2.writeTimerLow(data);\n        break;\n      case 0x4007:\n        this.pulse2.writeTimerHigh(data);\n        break;\n\n      // 三角波\n      case 0x4008:\n        this.triangle.writeControl(data);\n        break;\n      case 0x400A:\n        this.triangle.writeTimerLow(data);\n        break;\n      case 0x400B:\n        this.triangle.writeTimerHigh(data);\n        break;\n\n      // 雜訊\n      case 0x400C:\n        this.noise.writeControl(data);\n        break;\n      case 0x400E:\n        this.noise.writePeriod(data);\n        break;\n      case 0x400F:\n        this.noise.writeLength(data);\n        break;\n\n      // DMC\n      case 0x4010:\n        this.dmc.writeControl(data);\n        break;\n      case 0x4011:\n        this.dmc.writeDirectLoad(data);\n        break;\n      case 0x4012:\n        this.dmc.writeAddress(data);\n        break;\n      case 0x4013:\n        this.dmc.writeLength(data);\n        break;\n\n      // 狀態\n      case 0x4015:\n        this.writeStatus(data);\n        break;\n\n      // 幀計數器\n      case 0x4017:\n        this.frameCounter.write(data);\n        break;\n    }\n  }\n\n  /**\n   * 讀取狀態暫存器\n   */\n  private readStatus(): number {\n    let status = 0;\n\n    if (this.pulse1.getLengthCounter() > 0) status |= 0x01;\n    if (this.pulse2.getLengthCounter() > 0) status |= 0x02;\n    if (this.triangle.getLengthCounter() > 0) status |= 0x04;\n    if (this.noise.getLengthCounter() > 0) status |= 0x08;\n    if (this.dmc.getBytesRemaining() > 0) status |= 0x10;\n\n    // 幀 IRQ\n    if (this.frameCounter.getIrqFlag()) {\n      status |= 0x40;\n    }\n    this.frameCounter.clearIrqFlag();\n\n    // DMC IRQ\n    if (this.dmc.getIrqFlag()) {\n      status |= 0x80;\n    }\n\n    return status;\n  }\n\n  /**\n   * 寫入狀態暫存器\n   */\n  private writeStatus(data: number): void {\n    this.statusRegister = data;\n\n    this.pulse1.setEnabled((data & 0x01) !== 0);\n    this.pulse2.setEnabled((data & 0x02) !== 0);\n    this.triangle.setEnabled((data & 0x04) !== 0);\n    this.noise.setEnabled((data & 0x08) !== 0);\n    this.dmc.setEnabled((data & 0x10) !== 0);\n  }\n\n  /**\n   * 從環形緩衝區讀取音頻取樣\n   * @param outputBuffer 輸出緩衝區\n   * @returns 實際讀取的取樣數\n   */\n  public readSamples(outputBuffer: Float32Array): number {\n    let samplesRead = 0;\n    const length = outputBuffer.length;\n    \n    // 計算可用的取樣數\n    const available = this.getAvailableSamples();\n    \n    if (available === 0) {\n      // 緩衝區空，靜音輸出（漸變到0避免爆音）\n      for (let i = 0; i < length; i++) {\n        outputBuffer[i] = 0;\n      }\n      return 0;\n    }\n    \n    // 如果可用取樣少於需要的量，進行線性插值以避免爆音\n    if (available < length) {\n      // 讀取所有可用的取樣\n      const tempBuffer: number[] = [];\n      while (this.readIndex !== this.writeIndex) {\n        tempBuffer.push(this.audioBuffer[this.readIndex]);\n        this.readIndex = (this.readIndex + 1) % this.BUFFER_SIZE;\n      }\n      \n      // 線性插值以填滿輸出緩衝區\n      const ratio = tempBuffer.length / length;\n      for (let i = 0; i < length; i++) {\n        const pos = i * ratio;\n        const index = Math.floor(pos);\n        const frac = pos - index;\n        const current = tempBuffer[Math.min(index, tempBuffer.length - 1)];\n        const next = tempBuffer[Math.min(index + 1, tempBuffer.length - 1)];\n        outputBuffer[i] = current * (1 - frac) + next * frac;\n      }\n      return length;\n    }\n    \n    // 正常情況：直接從緩衝區讀取\n    while (samplesRead < length && this.readIndex !== this.writeIndex) {\n      outputBuffer[samplesRead] = this.audioBuffer[this.readIndex];\n      this.readIndex = (this.readIndex + 1) % this.BUFFER_SIZE;\n      samplesRead++;\n    }\n    \n    return samplesRead;\n  }\n\n  /**\n   * 取得緩衝區中可用的取樣數\n   */\n  public getAvailableSamples(): number {\n    if (this.writeIndex >= this.readIndex) {\n      return this.writeIndex - this.readIndex;\n    }\n    return this.BUFFER_SIZE - this.readIndex + this.writeIndex;\n  }\n\n  // ===== 序列化 (用於存檔) =====\n\n  /**\n   * 儲存狀態\n   */\n  public saveState(): object {\n    return {\n      pulse1: this.pulse1.saveState(),\n      pulse2: this.pulse2.saveState(),\n      triangle: this.triangle.saveState(),\n      noise: this.noise.saveState(),\n      dmc: this.dmc.saveState(),\n      frameCounter: this.frameCounter.saveState(),\n      statusRegister: this.statusRegister,\n      clockCounter: this.clockCounter,\n    };\n  }\n\n  /**\n   * 載入狀態\n   */\n  public loadState(state: any): void {\n    this.pulse1.loadState(state.pulse1);\n    this.pulse2.loadState(state.pulse2);\n    this.triangle.loadState(state.triangle);\n    this.noise.loadState(state.noise);\n    this.dmc.loadState(state.dmc);\n    this.frameCounter.loadState(state.frameCounter);\n    this.statusRegister = state.statusRegister;\n    this.clockCounter = state.clockCounter;\n  }\n}\n","/**\n * NES 記憶體匯流排\n * \n * 負責管理 CPU 和 PPU 的記憶體存取\n * \n * CPU 記憶體映射 (16 位元位址空間，$0000-$FFFF):\n * $0000-$07FF: 2KB 內部 RAM\n * $0800-$1FFF: RAM 鏡像 (每 2KB 重複)\n * $2000-$2007: PPU 暫存器\n * $2008-$3FFF: PPU 暫存器鏡像 (每 8 位元組重複)\n * $4000-$4017: APU 和 I/O 暫存器\n * $4018-$401F: 通常禁用的 APU 和 I/O 功能\n * $4020-$FFFF: 卡帶空間 (PRG ROM, PRG RAM, mapper 暫存器)\n */\n\nimport type { Ppu } from './ppu/ppu';\nimport type { Apu } from './apu/apu';\nimport type { Cartridge } from './cartridge';\nimport type { Controller } from './controller';\n\nexport class Bus {\n  /** 2KB 內部 RAM */\n  private ram: Uint8Array = new Uint8Array(2048);\n\n  /** PPU 參考 */\n  private ppu: Ppu | null = null;\n\n  /** APU 參考 */\n  private apu: Apu | null = null;\n\n  /** 卡帶參考 */\n  private cartridge: Cartridge | null = null;\n\n  /** 控制器參考 */\n  private controller1: Controller | null = null;\n  private controller2: Controller | null = null;\n\n  /** 控制器讀取狀態 */\n  private controllerState: [number, number] = [0, 0];\n\n  /** DMA 傳輸相關 */\n  private dmaPage: number = 0;\n  private dmaAddress: number = 0;\n  private dmaData: number = 0;\n  private dmaTransfer: boolean = false;\n  private dmaDummy: boolean = true;\n\n  constructor() {\n    this.ram.fill(0);\n  }\n\n  // ===== 元件連接 =====\n\n  /** 連接 PPU */\n  public connectPpu(ppu: Ppu): void {\n    this.ppu = ppu;\n  }\n\n  /** 連接 APU */\n  public connectApu(apu: Apu): void {\n    this.apu = apu;\n  }\n\n  /** 連接卡帶 */\n  public connectCartridge(cartridge: Cartridge): void {\n    this.cartridge = cartridge;\n  }\n\n  /** 連接控制器 */\n  public connectController(port: 1 | 2, controller: Controller): void {\n    if (port === 1) {\n      this.controller1 = controller;\n    } else {\n      this.controller2 = controller;\n    }\n  }\n\n  // ===== CPU 記憶體存取 =====\n\n  /**\n   * CPU 讀取記憶體\n   * @param address 16 位元位址\n   * @returns 8 位元資料\n   */\n  public cpuRead(address: number): number {\n    address &= 0xFFFF;\n\n    // 卡帶空間 ($4020-$FFFF)\n    if (address >= 0x4020) {\n      if (this.cartridge) {\n        return this.cartridge.cpuRead(address);\n      }\n      return 0;\n    }\n\n    // 內部 RAM ($0000-$1FFF，每 2KB 鏡像)\n    if (address < 0x2000) {\n      return this.ram[address & 0x07FF];\n    }\n\n    // PPU 暫存器 ($2000-$3FFF，每 8 位元組鏡像)\n    if (address < 0x4000) {\n      if (this.ppu) {\n        return this.ppu.cpuRead(address & 0x2007);\n      }\n      return 0;\n    }\n\n    // APU 和 I/O ($4000-$401F)\n    if (address === 0x4016) {\n      // 控制器 1\n      const data = (this.controllerState[0] & 0x80) ? 1 : 0;\n      this.controllerState[0] <<= 1;\n      return data;\n    }\n\n    if (address === 0x4017) {\n      // 控制器 2\n      const data = (this.controllerState[1] & 0x80) ? 1 : 0;\n      this.controllerState[1] <<= 1;\n      return data;\n    }\n\n    // APU 狀態暫存器 ($4015)\n    if (address === 0x4015 && this.apu) {\n      return this.apu.cpuRead(address);\n    }\n\n    return 0;\n  }\n\n  /**\n   * CPU 寫入記憶體\n   * @param address 16 位元位址\n   * @param data 8 位元資料\n   */\n  public cpuWrite(address: number, data: number): void {\n    address &= 0xFFFF;\n    data &= 0xFF;\n\n    // 卡帶空間 ($4020-$FFFF)\n    if (address >= 0x4020) {\n      if (this.cartridge) {\n        this.cartridge.cpuWrite(address, data);\n      }\n      return;\n    }\n\n    // 內部 RAM ($0000-$1FFF)\n    if (address < 0x2000) {\n      this.ram[address & 0x07FF] = data;\n      return;\n    }\n\n    // PPU 暫存器 ($2000-$3FFF)\n    if (address < 0x4000) {\n      if (this.ppu) {\n        this.ppu.cpuWrite(address & 0x2007, data);\n      }\n      return;\n    }\n\n    // OAM DMA ($4014)\n    if (address === 0x4014) {\n      this.dmaPage = data;\n      this.dmaAddress = 0;\n      this.dmaTransfer = true;\n      this.dmaDummy = true;\n      return;\n    }\n\n    // 控制器 ($4016)\n    if (address === 0x4016) {\n      this.controllerState[0] = this.controller1?.getState() ?? 0;\n      this.controllerState[1] = this.controller2?.getState() ?? 0;\n      return;\n    }\n\n    // APU 暫存器 ($4000-$4013, $4015, $4017)\n    if ((address >= 0x4000 && address <= 0x4013) || address === 0x4015 || address === 0x4017) {\n      if (this.apu) {\n        this.apu.cpuWrite(address, data);\n      }\n      return;\n    }\n  }\n\n  // ===== DMA 處理 =====\n\n  /** 是否正在進行 DMA 傳輸 */\n  public isDmaTransferring(): boolean {\n    return this.dmaTransfer;\n  }\n\n  /** 執行 DMA 時鐘週期 */\n  public doCycle(oddCycle: boolean): void {\n    if (!this.dmaTransfer) return;\n\n    if (this.dmaDummy) {\n      // DMA 開始時需要等待對齊\n      if (oddCycle) {\n        this.dmaDummy = false;\n      }\n    } else {\n      if (!oddCycle) {\n        // 偶數週期：讀取資料\n        this.dmaData = this.cpuRead((this.dmaPage << 8) | this.dmaAddress);\n      } else {\n        // 奇數週期：寫入 OAM\n        if (this.ppu) {\n          this.ppu.oamWrite(this.dmaAddress, this.dmaData);\n        }\n        this.dmaAddress++;\n        if (this.dmaAddress > 255) {\n          this.dmaTransfer = false;\n          this.dmaAddress = 0;\n        }\n      }\n    }\n  }\n\n  // ===== 除錯方法 =====\n\n  /** 直接讀取 RAM (不經過 mapper) */\n  public debugReadRam(address: number): number {\n    return this.ram[address & 0x07FF];\n  }\n\n  /** 直接寫入 RAM (不經過 mapper) */\n  public debugWriteRam(address: number, data: number): void {\n    this.ram[address & 0x07FF] = data & 0xFF;\n  }\n\n  // ===== 序列化 (存檔) =====\n\n  /** 儲存狀態 */\n  public saveState(): object {\n    return {\n      ram: Array.from(this.ram),\n      controllerState: [...this.controllerState],\n      dmaPage: this.dmaPage,\n      dmaAddress: this.dmaAddress,\n      dmaData: this.dmaData,\n      dmaTransfer: this.dmaTransfer,\n      dmaDummy: this.dmaDummy,\n    };\n  }\n\n  /** 載入狀態 */\n  public loadState(state: any): void {\n    this.ram.set(state.ram);\n    this.controllerState = [state.controllerState[0], state.controllerState[1]];\n    this.dmaPage = state.dmaPage;\n    this.dmaAddress = state.dmaAddress;\n    this.dmaData = state.dmaData;\n    this.dmaTransfer = state.dmaTransfer;\n    this.dmaDummy = state.dmaDummy;\n  }\n}\n","/**\n * Mapper 基底類別與工廠函數\n * \n * Mapper 負責處理卡帶的記憶體映射，不同的 Mapper 支援不同的遊戲\n * 常見的 Mapper:\n * - Mapper 0 (NROM): 無映射，最簡單的類型\n * - Mapper 1 (MMC1): 支援 bank 切換\n * - Mapper 2 (UxROM): PRG ROM 切換\n * - Mapper 3 (CNROM): CHR ROM 切換\n * - Mapper 4 (MMC3): 最常用的 mapper 之一\n */\n\nimport { MirrorMode } from '../core/cartridge';\n\n/**\n * Mapper 寫入結果\n */\nexport interface MapperWriteResult {\n  /** 是否觸發 IRQ */\n  irq?: boolean;\n  /** 新的鏡像模式 */\n  mirrorMode?: MirrorMode;\n}\n\n/**\n * Mapper 基底介面\n */\nexport interface Mapper {\n  /** CPU 讀取映射 */\n  cpuMapRead(address: number): number | null;\n  \n  /** CPU 寫入映射 */\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null;\n  \n  /** PPU 讀取映射 */\n  ppuMapRead(address: number): number | null;\n  \n  /** PPU 寫入映射 */\n  ppuMapWrite(address: number): number | null;\n  \n  /** 重置 */\n  reset?(): void;\n  \n  /** 掃描線計數 (用於 MMC3 等 scanline-based IRQ) */\n  scanline?(): void;\n  \n  /** CPU 週期計數 (用於 Bandai FCG 等 cycle-based IRQ) */\n  cpuClock?(): void;\n}\n\n/**\n * Mapper 0 (NROM)\n * \n * 最簡單的 Mapper，無 bank 切換\n * PRG ROM: 16KB 或 32KB\n * CHR ROM: 8KB\n */\nexport class Mapper0 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      // 如果只有 16KB PRG ROM，則 $C000-$FFFF 鏡像 $8000-$BFFF\n      const mask = this.prgBanks > 1 ? 0x7FFF : 0x3FFF;\n      return address & mask;\n    }\n    return null;\n  }\n\n  cpuMapWrite(_address: number, _data: number): MapperWriteResult | null {\n    // NROM 不支援寫入 PRG ROM\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      // CHR RAM\n      return address;\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 1 (MMC1)\n * \n * 支援 PRG ROM bank 切換和 CHR ROM bank 切換\n * 使用串列寫入來設定暫存器\n */\nexport class Mapper1 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n\n  // 內部暫存器\n  private shiftRegister: number = 0x10;\n  private controlRegister: number = 0x0C;\n  private chrBank0: number = 0;\n  private chrBank1: number = 0;\n  private prgBank: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n    this.reset();\n  }\n\n  reset(): void {\n    this.shiftRegister = 0x10;\n    this.controlRegister = 0x0C;\n    this.chrBank0 = 0;\n    this.chrBank1 = 0;\n    this.prgBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const prgMode = (this.controlRegister >> 2) & 0x03;\n\n      if (prgMode <= 1) {\n        // 32KB 模式\n        const bank = (this.prgBank & 0x0E) * 16384;\n        return bank + (address & 0x7FFF);\n      } else if (prgMode === 2) {\n        // 固定第一個 bank 在 $8000\n        if (address < 0xC000) {\n          return address & 0x3FFF;\n        } else {\n          return this.prgBank * 16384 + (address & 0x3FFF);\n        }\n      } else {\n        // 固定最後一個 bank 在 $C000\n        if (address < 0xC000) {\n          return this.prgBank * 16384 + (address & 0x3FFF);\n        } else {\n          return (this.prgBanks - 1) * 16384 + (address & 0x3FFF);\n        }\n      }\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      if (data & 0x80) {\n        // 重置移位暫存器\n        this.shiftRegister = 0x10;\n        this.controlRegister |= 0x0C;\n        return null;\n      }\n\n      const complete = this.shiftRegister & 0x01;\n      this.shiftRegister = (this.shiftRegister >> 1) | ((data & 0x01) << 4);\n\n      if (complete) {\n        const targetRegister = (address >> 13) & 0x03;\n        const value = this.shiftRegister;\n\n        switch (targetRegister) {\n          case 0: // 控制暫存器\n            this.controlRegister = value;\n            break;\n          case 1: // CHR bank 0\n            this.chrBank0 = value;\n            break;\n          case 2: // CHR bank 1\n            this.chrBank1 = value;\n            break;\n          case 3: // PRG bank\n            this.prgBank = value & 0x0F;\n            break;\n        }\n\n        this.shiftRegister = 0x10;\n\n        // 回傳鏡像模式\n        const mirrorBits = this.controlRegister & 0x03;\n        let mirrorMode: MirrorMode;\n        switch (mirrorBits) {\n          case 0: mirrorMode = MirrorMode.SingleScreenLow; break;\n          case 1: mirrorMode = MirrorMode.SingleScreenHigh; break;\n          case 2: mirrorMode = MirrorMode.Vertical; break;\n          default: mirrorMode = MirrorMode.Horizontal; break;\n        }\n\n        return { mirrorMode };\n      }\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      const chrMode = (this.controlRegister >> 4) & 0x01;\n      // 以 4KB 為單位的總 bank 數\n      const totalChrBanks = Math.max(1, this.chrBanks * 2);\n\n      if (chrMode === 0) {\n        // 8KB 模式 - 忽略最低位\n        const bank = (this.chrBank0 & 0x1E) % totalChrBanks;\n        return bank * 4096 + address;\n      } else {\n        // 4KB 模式\n        if (address < 0x1000) {\n          const bank = this.chrBank0 % totalChrBanks;\n          return bank * 4096 + address;\n        } else {\n          const bank = this.chrBank1 % totalChrBanks;\n          return bank * 4096 + (address & 0x0FFF);\n        }\n      }\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      // CHR RAM\n      return address;\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 2 (UxROM)\n * \n * PRG ROM bank 切換，最後一個 bank 固定在 $C000\n */\nexport class Mapper2 implements Mapper {\n  private prgBanks: number;\n  private _chrBanks: number;\n  private selectedBank: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this._chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.selectedBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000 && address < 0xC000) {\n      return this.selectedBank * 16384 + (address & 0x3FFF);\n    }\n    if (address >= 0xC000) {\n      return (this.prgBanks - 1) * 16384 + (address & 0x3FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.selectedBank = data & 0x0F;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 3 (CNROM)\n * \n * CHR ROM bank 切換\n */\nexport class Mapper3 implements Mapper {\n  private prgBanks: number;\n  private _chrBanks: number;\n  private selectedChrBank: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this._chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.selectedChrBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const mask = this.prgBanks > 1 ? 0x7FFF : 0x3FFF;\n      return address & mask;\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.selectedChrBank = data & 0x03;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return this.selectedChrBank * 8192 + address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n}\n\n/**\n * Mapper 4 (MMC3)\n * \n * 最常見的 Mapper 之一，用於超級瑪利歐兄弟 3 等遊戲\n * 特點：\n * - 可切換的 PRG ROM banks (8KB 單位)\n * - 可切換的 CHR ROM banks (1KB/2KB 單位)\n * - 掃描線計數器 (用於 IRQ)\n * - 可控的鏡像模式\n */\nexport class Mapper4 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n\n  // Bank 暫存器\n  private registers: number[] = new Array(8).fill(0);\n  \n  // 控制\n  private bankSelect: number = 0;\n  private prgRomBankMode: boolean = false;\n  private chrA12Inversion: boolean = false;\n\n  // 鏡像\n  private mirrorMode: MirrorMode = MirrorMode.Vertical;\n\n  // IRQ\n  private irqCounter: number = 0;\n  private irqLatch: number = 0;\n  private irqEnabled: boolean = false;\n  private irqReload: boolean = false;\n  private irqPending: boolean = false;\n\n  // PRG RAM\n  private _prgRamEnabled: boolean = true;\n  private _prgRamWriteProtect: boolean = false;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n    this.reset();\n  }\n\n  reset(): void {\n    this.registers = new Array(8).fill(0);\n    this.bankSelect = 0;\n    this.prgRomBankMode = false;\n    this.chrA12Inversion = false;\n    this.mirrorMode = MirrorMode.Vertical;\n    this.irqCounter = 0;\n    this.irqLatch = 0;\n    this.irqEnabled = false;\n    this.irqReload = false;\n    this.irqPending = false;\n    this._prgRamEnabled = true;\n    this._prgRamWriteProtect = false;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const bank = this.getPrgBank(address);\n      return bank * 8192 + (address & 0x1FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      const even = (address & 1) === 0;\n      const region = (address >> 13) & 0x03;\n\n      switch (region) {\n        case 0: // $8000-$9FFF\n          if (even) {\n            // Bank Select\n            this.bankSelect = data & 0x07;\n            this.prgRomBankMode = (data & 0x40) !== 0;\n            this.chrA12Inversion = (data & 0x80) !== 0;\n          } else {\n            // Bank Data\n            this.registers[this.bankSelect] = data;\n          }\n          break;\n\n        case 1: // $A000-$BFFF\n          if (even) {\n            // Mirroring\n            this.mirrorMode = (data & 1) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n            return { mirrorMode: this.mirrorMode };\n          } else {\n            // PRG RAM protect\n            this._prgRamWriteProtect = (data & 0x40) !== 0;\n            this._prgRamEnabled = (data & 0x80) !== 0;\n          }\n          break;\n\n        case 2: // $C000-$DFFF\n          if (even) {\n            // IRQ Latch\n            this.irqLatch = data;\n          } else {\n            // IRQ Reload\n            this.irqReload = true;\n          }\n          break;\n\n        case 3: // $E000-$FFFF\n          if (even) {\n            // IRQ Disable\n            this.irqEnabled = false;\n            this.irqPending = false;\n          } else {\n            // IRQ Enable\n            this.irqEnabled = true;\n          }\n          break;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * 取得 PRG bank\n   */\n  private getPrgBank(address: number): number {\n    const lastBank = this.prgBanks * 2 - 1;\n    const secondLastBank = this.prgBanks * 2 - 2;\n\n    if (address < 0xA000) {\n      // $8000-$9FFF\n      if (this.prgRomBankMode) {\n        return secondLastBank;\n      } else {\n        return this.registers[6] & 0x3F;\n      }\n    } else if (address < 0xC000) {\n      // $A000-$BFFF\n      return this.registers[7] & 0x3F;\n    } else if (address < 0xE000) {\n      // $C000-$DFFF\n      if (this.prgRomBankMode) {\n        return this.registers[6] & 0x3F;\n      } else {\n        return secondLastBank;\n      }\n    } else {\n      // $E000-$FFFF\n      return lastBank;\n    }\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return this.getChrBank(address) * 1024 + (address & 0x03FF);\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  /**\n   * 取得 CHR bank\n   */\n  private getChrBank(address: number): number {\n    const region = address >> 10; // 0-7 (每個區域 1KB)\n    \n    if (this.chrA12Inversion) {\n      // A12 反轉: R0-R1 在 $1000, R2-R5 在 $0000\n      switch (region) {\n        case 0: return this.registers[2];\n        case 1: return this.registers[3];\n        case 2: return this.registers[4];\n        case 3: return this.registers[5];\n        case 4: return this.registers[0] & 0xFE;\n        case 5: return (this.registers[0] & 0xFE) | 1;\n        case 6: return this.registers[1] & 0xFE;\n        case 7: return (this.registers[1] & 0xFE) | 1;\n      }\n    } else {\n      // 正常: R0-R1 在 $0000, R2-R5 在 $1000\n      switch (region) {\n        case 0: return this.registers[0] & 0xFE;\n        case 1: return (this.registers[0] & 0xFE) | 1;\n        case 2: return this.registers[1] & 0xFE;\n        case 3: return (this.registers[1] & 0xFE) | 1;\n        case 4: return this.registers[2];\n        case 5: return this.registers[3];\n        case 6: return this.registers[4];\n        case 7: return this.registers[5];\n      }\n    }\n    return 0;\n  }\n\n  /**\n   * 掃描線計數 (由 PPU 在 A12 上升沿呼叫)\n   */\n  scanline(): void {\n    if (this.irqCounter === 0 || this.irqReload) {\n      this.irqCounter = this.irqLatch;\n      this.irqReload = false;\n    } else {\n      this.irqCounter--;\n    }\n\n    if (this.irqCounter === 0 && this.irqEnabled) {\n      this.irqPending = true;\n    }\n  }\n\n  /**\n   * 檢查是否有待處理的 IRQ\n   */\n  getIrqPending(): boolean {\n    const pending = this.irqPending;\n    this.irqPending = false;\n    return pending;\n  }\n}\n\n/**\n * Mapper 7 (AxROM)\n * \n * PRG ROM: 32KB 切換\n * CHR: RAM\n * 鏡像: 單屏\n */\nexport class Mapper7 implements Mapper {\n  private prgBanks: number;\n  private selectedBank: number = 0;\n  private singleScreen: number = 0; // 0 = 低頁, 1 = 高頁\n  private mirrorModeValue: MirrorMode = MirrorMode.SingleScreenLow;\n\n  constructor(prgBanks: number, _chrBanks: number) {\n    this.prgBanks = prgBanks;\n  }\n\n  reset(): void {\n    this.selectedBank = 0;\n    this.singleScreen = 0;\n    this.mirrorModeValue = MirrorMode.SingleScreenLow;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      return this.selectedBank * 32768 + (address & 0x7FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.selectedBank = data & 0x07;\n      this.singleScreen = (data >> 4) & 0x01;\n      this.mirrorModeValue = this.singleScreen ? MirrorMode.SingleScreenHigh : MirrorMode.SingleScreenLow;\n      return { mirrorMode: this.mirrorModeValue };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 11 (Color Dreams)\n * \n * 簡單的 PRG/CHR ROM 切換\n */\nexport class Mapper11 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private chrBank: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.chrBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      return (this.prgBank % this.prgBanks) * 32768 + (address & 0x7FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.prgBank = data & 0x03;\n      this.chrBank = (data >> 4) & 0x0F;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return (this.chrBank % Math.max(1, this.chrBanks)) * 8192 + address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n}\n\n/**\n * Mapper 16 (Bandai FCG)\n * \n * 用於龍珠系列遊戲\n * 支援 PRG/CHR bank 切換和 IRQ\n */\nexport class Mapper16 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  \n  // Bank 暫存器\n  private chrBankRegs: number[] = [0, 0, 0, 0, 0, 0, 0, 0];\n  private prgBank: number = 0;\n  \n  // IRQ 相關\n  private irqCounter: number = 0;\n  private irqLatch: number = 0;\n  private irqEnabled: boolean = false;\n  private irqPending: boolean = false;\n  \n  // 鏡像\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.chrBankRegs.fill(0);\n    this.prgBank = 0;\n    this.irqCounter = 0;\n    this.irqLatch = 0;\n    this.irqEnabled = false;\n    this.irqPending = false;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000 && address < 0xC000) {\n      return (this.prgBank % this.prgBanks) * 16384 + (address & 0x3FFF);\n    } else if (address >= 0xC000) {\n      // 最後一個 bank 固定\n      return (this.prgBanks - 1) * 16384 + (address & 0x3FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    // Bandai FCG 有多種變體\n    // FCG-1/FCG-2: 使用 $6000-$7FFF\n    // LZ93D50: 使用 $8000-$FFFF\n    \n    let reg: number;\n    \n    if (address >= 0x6000 && address < 0x8000) {\n      // FCG-1/FCG-2 變體\n      reg = address & 0x000F;\n    } else if (address >= 0x8000) {\n      // LZ93D50 變體 (龍珠系列使用這個)\n      reg = address & 0x000F;\n    } else {\n      return null;\n    }\n    \n    if (reg < 8) {\n      // CHR bank 暫存器 (0-7)\n      this.chrBankRegs[reg] = data;\n    } else if (reg === 8) {\n      // PRG bank\n      this.prgBank = data & 0x0F;\n    } else if (reg === 9) {\n      // 鏡像控制\n      const mirror = data & 0x03;\n      switch (mirror) {\n        case 0: this.mirrorModeValue = MirrorMode.Vertical; break;\n        case 1: this.mirrorModeValue = MirrorMode.Horizontal; break;\n        case 2: this.mirrorModeValue = MirrorMode.SingleScreenLow; break;\n        case 3: this.mirrorModeValue = MirrorMode.SingleScreenHigh; break;\n      }\n      return { mirrorMode: this.mirrorModeValue };\n    } else if (reg === 0x0A) {\n      // IRQ 控制\n      this.irqEnabled = (data & 0x01) !== 0;\n      this.irqCounter = this.irqLatch;\n      this.irqPending = false;\n    } else if (reg === 0x0B) {\n      // IRQ latch 低位元\n      this.irqLatch = (this.irqLatch & 0xFF00) | data;\n    } else if (reg === 0x0C) {\n      // IRQ latch 高位元\n      this.irqLatch = (this.irqLatch & 0x00FF) | (data << 8);\n    } else if (reg === 0x0D) {\n      // EEPROM 控制 (某些變體)\n      // 忽略此暫存器\n    }\n    \n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      const region = address >> 10; // 1KB region (0-7)\n      const totalChrBanks = Math.max(1, this.chrBanks * 8);\n      const bank = this.chrBankRegs[region] % totalChrBanks;\n      return bank * 1024 + (address & 0x3FF);\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n\n  /**\n   * Bandai FCG 使用 CPU 週期計時器，而非 scanline 計時器\n   * IRQ 在每個 CPU 週期遞減計數器\n   */\n  cpuClock(): void {\n    if (this.irqEnabled) {\n      if (this.irqCounter === 0) {\n        this.irqPending = true;\n      } else {\n        this.irqCounter--;\n      }\n    }\n  }\n\n  getIrqPending(): boolean {\n    const pending = this.irqPending;\n    this.irqPending = false;\n    return pending;\n  }\n}\n\n/**\n * Mapper 23 (VRC2b/VRC4)\n * \n * Konami VRC 系列，用於魂斗羅等遊戲\n */\nexport class Mapper23 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  \n  // Bank 暫存器\n  private prgBank0: number = 0;\n  private prgBank1: number = 0;\n  private chrBankRegs: number[] = [0, 0, 0, 0, 0, 0, 0, 0];\n  \n  // 控制\n  private prgSwapMode: number = 0;\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n  \n  // IRQ (VRC4)\n  private irqLatch: number = 0;\n  private irqControl: number = 0;\n  private irqCounter: number = 0;\n  private irqPrescaler: number = 0;\n  private irqEnabled: boolean = false;\n  private irqPending: boolean = false;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank0 = 0;\n    this.prgBank1 = 0;\n    this.chrBankRegs.fill(0);\n    this.prgSwapMode = 0;\n    this.irqLatch = 0;\n    this.irqControl = 0;\n    this.irqCounter = 0;\n    this.irqPrescaler = 0;\n    this.irqEnabled = false;\n    this.irqPending = false;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000 && address < 0xA000) {\n      const bank = this.prgSwapMode ? (this.prgBanks * 2 - 2) : this.prgBank0;\n      return (bank % (this.prgBanks * 2)) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xA000 && address < 0xC000) {\n      return (this.prgBank1 % (this.prgBanks * 2)) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xC000 && address < 0xE000) {\n      const bank = this.prgSwapMode ? this.prgBank0 : (this.prgBanks * 2 - 2);\n      return (bank % (this.prgBanks * 2)) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xE000) {\n      return (this.prgBanks * 2 - 1) * 8192 + (address & 0x1FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    // VRC2/VRC4 地址解碼\n    const a0 = address & 0x0001;\n    const a1 = (address & 0x0002) >> 1;\n    const reg = (address & 0xF000) | (a1 << 1) | a0;\n\n    switch (reg) {\n      case 0x8000:\n      case 0x8001:\n      case 0x8002:\n      case 0x8003:\n        this.prgBank0 = data & 0x1F;\n        break;\n\n      case 0x9000:\n      case 0x9001:\n        const mirror = data & 0x03;\n        switch (mirror) {\n          case 0: this.mirrorModeValue = MirrorMode.Vertical; break;\n          case 1: this.mirrorModeValue = MirrorMode.Horizontal; break;\n          case 2: this.mirrorModeValue = MirrorMode.SingleScreenLow; break;\n          case 3: this.mirrorModeValue = MirrorMode.SingleScreenHigh; break;\n        }\n        return { mirrorMode: this.mirrorModeValue };\n\n      case 0x9002:\n      case 0x9003:\n        this.prgSwapMode = (data >> 1) & 0x01;\n        break;\n\n      case 0xA000:\n      case 0xA001:\n      case 0xA002:\n      case 0xA003:\n        this.prgBank1 = data & 0x1F;\n        break;\n\n      // CHR banks (1KB 切換)\n      case 0xB000: this.chrBankRegs[0] = (this.chrBankRegs[0] & 0xF0) | (data & 0x0F); break;\n      case 0xB001: this.chrBankRegs[0] = (this.chrBankRegs[0] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xB002: this.chrBankRegs[1] = (this.chrBankRegs[1] & 0xF0) | (data & 0x0F); break;\n      case 0xB003: this.chrBankRegs[1] = (this.chrBankRegs[1] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xC000: this.chrBankRegs[2] = (this.chrBankRegs[2] & 0xF0) | (data & 0x0F); break;\n      case 0xC001: this.chrBankRegs[2] = (this.chrBankRegs[2] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xC002: this.chrBankRegs[3] = (this.chrBankRegs[3] & 0xF0) | (data & 0x0F); break;\n      case 0xC003: this.chrBankRegs[3] = (this.chrBankRegs[3] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xD000: this.chrBankRegs[4] = (this.chrBankRegs[4] & 0xF0) | (data & 0x0F); break;\n      case 0xD001: this.chrBankRegs[4] = (this.chrBankRegs[4] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xD002: this.chrBankRegs[5] = (this.chrBankRegs[5] & 0xF0) | (data & 0x0F); break;\n      case 0xD003: this.chrBankRegs[5] = (this.chrBankRegs[5] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xE000: this.chrBankRegs[6] = (this.chrBankRegs[6] & 0xF0) | (data & 0x0F); break;\n      case 0xE001: this.chrBankRegs[6] = (this.chrBankRegs[6] & 0x0F) | ((data & 0x0F) << 4); break;\n      case 0xE002: this.chrBankRegs[7] = (this.chrBankRegs[7] & 0xF0) | (data & 0x0F); break;\n      case 0xE003: this.chrBankRegs[7] = (this.chrBankRegs[7] & 0x0F) | ((data & 0x0F) << 4); break;\n\n      // IRQ (VRC4)\n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (data & 0x0F);\n        break;\n      case 0xF001:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((data & 0x0F) << 4);\n        break;\n      case 0xF002:\n        this.irqControl = data;\n        this.irqEnabled = (data & 0x02) !== 0;\n        if (data & 0x02) {\n          this.irqCounter = this.irqLatch;\n          this.irqPrescaler = 341;\n        }\n        this.irqPending = false;\n        break;\n      case 0xF003:\n        this.irqEnabled = (this.irqControl & 0x01) !== 0;\n        this.irqPending = false;\n        break;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      const region = address >> 10; // 1KB region\n      const bank = this.chrBankRegs[region];\n      const totalChrBanks = this.chrBanks * 8; // 以 1KB 為單位\n      return (bank % totalChrBanks) * 1024 + (address & 0x3FF);\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n\n  scanline(): void {\n    if (this.irqEnabled) {\n      this.irqPrescaler -= 3;\n      if (this.irqPrescaler <= 0) {\n        this.irqPrescaler += 341;\n        if (this.irqCounter === 0xFF) {\n          this.irqCounter = this.irqLatch;\n          this.irqPending = true;\n        } else {\n          this.irqCounter++;\n        }\n      }\n    }\n  }\n\n  getIrqPending(): boolean {\n    const pending = this.irqPending;\n    this.irqPending = false;\n    return pending;\n  }\n}\n\n/**\n * Mapper 66 (GxROM)\n * \n * 簡單的 PRG/CHR 切換\n */\nexport class Mapper66 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private chrBank: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.chrBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      return (this.prgBank % this.prgBanks) * 32768 + (address & 0x7FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.chrBank = data & 0x03;\n      this.prgBank = (data >> 4) & 0x03;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return (this.chrBank % Math.max(1, this.chrBanks)) * 8192 + address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n}\n\n/**\n * Mapper 71 (Camerica/Codemasters)\n * \n * 用於 Camerica 和 Codemasters 遊戲\n */\nexport class Mapper71 implements Mapper {\n  private prgBanks: number;\n  private selectedBank: number = 0;\n  private mirrorModeValue: MirrorMode = MirrorMode.Horizontal;\n\n  constructor(prgBanks: number, _chrBanks: number) {\n    this.prgBanks = prgBanks;\n  }\n\n  reset(): void {\n    this.selectedBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000 && address < 0xC000) {\n      return this.selectedBank * 16384 + (address & 0x3FFF);\n    } else if (address >= 0xC000) {\n      return (this.prgBanks - 1) * 16384 + (address & 0x3FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x9000 && address < 0xA000) {\n      // 鏡像控制 (部分變體)\n      this.mirrorModeValue = (data & 0x10) ? MirrorMode.SingleScreenHigh : MirrorMode.SingleScreenLow;\n      return { mirrorMode: this.mirrorModeValue };\n    } else if (address >= 0xC000) {\n      this.selectedBank = data & 0x0F;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 15 (100-in-1 Contra Function 16)\n * \n * 用於 100 合 1 多遊戲卡帶\n */\nexport class Mapper15 implements Mapper {\n  private prgBanks: number;\n  private prgBank: number = 0;\n  private prgMode: number = 0;\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, _chrBanks: number) {\n    this.prgBanks = prgBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.prgMode = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const bank8k = this.prgBank * 2;\n      const totalBanks = this.prgBanks * 2; // 8KB banks\n\n      switch (this.prgMode) {\n        case 0: // 32KB mode\n          return ((bank8k & ~3) % totalBanks) * 8192 + (address & 0x7FFF);\n        case 1: // 128KB mode (mirror $8000-$BFFF)\n          if (address < 0xC000) {\n            return (bank8k % totalBanks) * 8192 + (address & 0x3FFF);\n          } else {\n            return ((bank8k | 1) % totalBanks) * 8192 + (address & 0x3FFF);\n          }\n        case 2: // 8KB mode\n          return (bank8k % totalBanks) * 8192 + (address & 0x1FFF);\n        case 3: // 16KB mode\n        default:\n          if (address < 0xC000) {\n            return (bank8k % totalBanks) * 8192 + (address & 0x3FFF);\n          } else {\n            return ((bank8k | 1) % totalBanks) * 8192 + (address & 0x3FFF);\n          }\n      }\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      this.prgMode = address & 0x03;\n      this.prgBank = ((data & 0x3F) | ((data & 0x80) >> 1));\n      this.mirrorModeValue = (data & 0x40) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n      return { mirrorMode: this.mirrorModeValue };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 113 (NINA-03/06 / Sachen / Hacker / HES)\n * \n * 用於台灣麻將等遊戲\n */\nexport class Mapper113 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private chrBank: number = 0;\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.chrBank = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      return (this.prgBank % this.prgBanks) * 32768 + (address & 0x7FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x4100 && address < 0x6000) {\n      // $4100-$5FFF\n      this.prgBank = (data >> 3) & 0x07;\n      this.chrBank = ((data & 0x07) | ((data >> 3) & 0x08));\n      this.mirrorModeValue = (data & 0x80) ? MirrorMode.Vertical : MirrorMode.Horizontal;\n      return { mirrorMode: this.mirrorModeValue };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      const totalChrBanks = Math.max(1, this.chrBanks);\n      return (this.chrBank % totalChrBanks) * 8192 + address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(_address: number): number | null {\n    return null;\n  }\n}\n\n/**\n * Mapper 202\n * \n * 用於 150合1 等合集卡帶\n * 簡單的 PRG/CHR bank 切換\n */\nexport class Mapper202 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private chrBank: number = 0;\n  private prgMode: number = 0; // 0 = 32KB, 1 = 16KB\n  private mirrorMode: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.chrBank = 0;\n    this.prgMode = 0;\n    this.mirrorMode = MirrorMode.Vertical;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const totalPrgSize = this.prgBanks * 16384;\n      \n      if (this.prgMode === 0) {\n        // 16KB 模式 (鏡像)\n        const offset = address & 0x3FFF;\n        return ((this.prgBank * 16384) + offset) % totalPrgSize;\n      } else {\n        // 32KB 模式\n        const bank32k = this.prgBank >> 1;\n        const offset = address & 0x7FFF;\n        return ((bank32k * 32768) + offset) % totalPrgSize;\n      }\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, _data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      // $8000-$FFFF: Bank 選擇\n      // 地址的低位決定 bank\n      const bank = (address >> 1) & 0x07;\n      this.prgBank = bank;\n      this.chrBank = bank;\n      this.prgMode = (address & 0x01) ^ ((address >> 3) & 0x01);\n      this.mirrorMode = (address & 0x01) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n      \n      return { mirrorMode: this.mirrorMode };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      if (this.chrBanks === 0) {\n        return address; // CHR RAM\n      }\n      const totalChrSize = this.chrBanks * 8192;\n      return ((this.chrBank * 8192) + (address & 0x1FFF)) % totalChrSize;\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 245 (Waixing MMC3 variant)\n * \n * 類似 MMC3 但有額外的 CHR RAM 控制\n * 用於一些中文版遊戲\n */\nexport class Mapper245 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  \n  // Bank 暫存器\n  private bankRegs: number[] = [0, 0, 0, 0, 0, 0, 0, 0];\n  private bankSelect: number = 0;\n  \n  // 鏡像\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n  \n  // IRQ (與 MMC3 類似)\n  private irqCounter: number = 0;\n  private irqLatch: number = 0;\n  private irqEnabled: boolean = false;\n  private irqReload: boolean = false;\n  private irqPending: boolean = false;\n\n  // 額外的 PRG 控制\n  private prgHighBit: number = 0;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.bankRegs.fill(0);\n    this.bankSelect = 0;\n    this.irqCounter = 0;\n    this.irqLatch = 0;\n    this.irqEnabled = false;\n    this.irqReload = false;\n    this.irqPending = false;\n    this.prgHighBit = 0;\n  }\n\n  cpuMapRead(address: number): number | null {\n    const prgBankCount = this.prgBanks * 2; // 8KB banks\n    \n    if (address >= 0x8000 && address < 0xA000) {\n      const bank = (this.bankSelect & 0x40) \n        ? (prgBankCount - 2) \n        : ((this.bankRegs[6] | this.prgHighBit) % prgBankCount);\n      return bank * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xA000 && address < 0xC000) {\n      const bank = (this.bankRegs[7] | this.prgHighBit) % prgBankCount;\n      return bank * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xC000 && address < 0xE000) {\n      const bank = (this.bankSelect & 0x40)\n        ? ((this.bankRegs[6] | this.prgHighBit) % prgBankCount)\n        : (prgBankCount - 2);\n      return bank * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xE000) {\n      return (prgBankCount - 1) * 8192 + (address & 0x1FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    if (address >= 0x8000 && address < 0xA000) {\n      if (address & 1) {\n        // Bank data\n        const reg = this.bankSelect & 0x07;\n        this.bankRegs[reg] = data;\n        // R0 控制 PRG 高位\n        if (reg === 0) {\n          this.prgHighBit = (data & 0x02) ? 0x40 : 0;\n        }\n      } else {\n        // Bank select\n        this.bankSelect = data;\n      }\n    } else if (address >= 0xA000 && address < 0xC000) {\n      if (!(address & 1)) {\n        // 鏡像\n        this.mirrorModeValue = (data & 0x01) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n        return { mirrorMode: this.mirrorModeValue };\n      }\n    } else if (address >= 0xC000 && address < 0xE000) {\n      if (address & 1) {\n        this.irqReload = true;\n      } else {\n        this.irqLatch = data;\n      }\n    } else if (address >= 0xE000) {\n      if (address & 1) {\n        this.irqEnabled = true;\n      } else {\n        this.irqEnabled = false;\n        this.irqPending = false;\n      }\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      // CHR RAM\n      return address;\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  scanline(): void {\n    if (this.irqReload || this.irqCounter === 0) {\n      this.irqCounter = this.irqLatch;\n      this.irqReload = false;\n    } else {\n      this.irqCounter--;\n    }\n    \n    if (this.irqCounter === 0 && this.irqEnabled) {\n      this.irqPending = true;\n    }\n  }\n\n  getIrqPending(): boolean {\n    const pending = this.irqPending;\n    this.irqPending = false;\n    return pending;\n  }\n}\n\n/**\n * Mapper 253 (Waixing VRC4 variant)\n * \n * 類似 VRC4 的中國變體\n * 用於龍珠等遊戲\n */\nexport class Mapper253 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  \n  // Bank 暫存器\n  private prgBank0: number = 0;\n  private prgBank1: number = 0;\n  private chrBankRegs: number[] = [0, 0, 0, 0, 0, 0, 0, 0];\n  private chrBankHigh: number[] = [0, 0, 0, 0, 0, 0, 0, 0];\n  \n  // 鏡像\n  private mirrorModeValue: MirrorMode = MirrorMode.Vertical;\n  \n  // IRQ\n  private irqLatch: number = 0;\n  private irqControl: number = 0;\n  private irqCounter: number = 0;\n  private irqEnabled: boolean = false;\n  private irqPending: boolean = false;\n  private irqPrescaler: number = 0;\n\n  // VRAM 控制\n  private vramEnable: boolean = false;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank0 = 0;\n    this.prgBank1 = 0;\n    this.chrBankRegs.fill(0);\n    this.chrBankHigh.fill(0);\n    this.irqLatch = 0;\n    this.irqControl = 0;\n    this.irqCounter = 0;\n    this.irqEnabled = false;\n    this.irqPending = false;\n    this.irqPrescaler = 0;\n    this.vramEnable = false;\n  }\n\n  cpuMapRead(address: number): number | null {\n    const prgBankCount = this.prgBanks * 2;\n    \n    if (address >= 0x8000 && address < 0xA000) {\n      return (this.prgBank0 % prgBankCount) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xA000 && address < 0xC000) {\n      return (this.prgBank1 % prgBankCount) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xC000 && address < 0xE000) {\n      return (prgBankCount - 2) * 8192 + (address & 0x1FFF);\n    } else if (address >= 0xE000) {\n      return (prgBankCount - 1) * 8192 + (address & 0x1FFF);\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, data: number): MapperWriteResult | null {\n    const addr = address & 0xF00C;\n    \n    switch (addr) {\n      case 0x8000:\n      case 0x8004:\n      case 0x8008:\n      case 0x800C:\n        this.prgBank0 = data;\n        break;\n        \n      case 0x9000:\n        this.mirrorModeValue = (data & 0x01) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n        return { mirrorMode: this.mirrorModeValue };\n        \n      case 0xA000:\n      case 0xA004:\n      case 0xA008:\n      case 0xA00C:\n        this.prgBank1 = data;\n        break;\n        \n      case 0xB000:\n        this.chrBankRegs[0] = (this.chrBankRegs[0] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xB004:\n        this.chrBankRegs[0] = (this.chrBankRegs[0] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[0] = data & 0x10;\n        break;\n      case 0xB008:\n        this.chrBankRegs[1] = (this.chrBankRegs[1] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xB00C:\n        this.chrBankRegs[1] = (this.chrBankRegs[1] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[1] = data & 0x10;\n        break;\n        \n      case 0xC000:\n        this.chrBankRegs[2] = (this.chrBankRegs[2] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xC004:\n        this.chrBankRegs[2] = (this.chrBankRegs[2] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[2] = data & 0x10;\n        break;\n      case 0xC008:\n        this.chrBankRegs[3] = (this.chrBankRegs[3] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xC00C:\n        this.chrBankRegs[3] = (this.chrBankRegs[3] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[3] = data & 0x10;\n        break;\n        \n      case 0xD000:\n        this.chrBankRegs[4] = (this.chrBankRegs[4] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xD004:\n        this.chrBankRegs[4] = (this.chrBankRegs[4] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[4] = data & 0x10;\n        break;\n      case 0xD008:\n        this.chrBankRegs[5] = (this.chrBankRegs[5] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xD00C:\n        this.chrBankRegs[5] = (this.chrBankRegs[5] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[5] = data & 0x10;\n        break;\n        \n      case 0xE000:\n        this.chrBankRegs[6] = (this.chrBankRegs[6] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xE004:\n        this.chrBankRegs[6] = (this.chrBankRegs[6] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[6] = data & 0x10;\n        break;\n      case 0xE008:\n        this.chrBankRegs[7] = (this.chrBankRegs[7] & 0xF0) | (data & 0x0F);\n        break;\n      case 0xE00C:\n        this.chrBankRegs[7] = (this.chrBankRegs[7] & 0x0F) | ((data & 0x0F) << 4);\n        this.chrBankHigh[7] = data & 0x10;\n        break;\n        \n      case 0xF000:\n        this.irqLatch = (this.irqLatch & 0xF0) | (data & 0x0F);\n        break;\n      case 0xF004:\n        this.irqLatch = (this.irqLatch & 0x0F) | ((data & 0x0F) << 4);\n        break;\n      case 0xF008:\n        this.irqControl = data;\n        this.irqEnabled = (data & 0x02) !== 0;\n        if (data & 0x02) {\n          this.irqCounter = this.irqLatch;\n          this.irqPrescaler = 341;\n        }\n        this.irqPending = false;\n        break;\n      case 0xF00C:\n        this.irqEnabled = (this.irqControl & 0x01) !== 0;\n        this.irqPending = false;\n        break;\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      const region = address >> 10;\n      const bank = this.chrBankRegs[region] | (this.chrBankHigh[region] ? 0x100 : 0);\n      \n      // 如果沒有 CHR ROM，使用 CHR RAM\n      if (this.chrBanks === 0) {\n        return address;\n      }\n      \n      const totalChrBanks = this.chrBanks * 8;\n      return (bank % totalChrBanks) * 1024 + (address & 0x3FF);\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  scanline(): void {\n    if (this.irqEnabled) {\n      this.irqPrescaler -= 3;\n      if (this.irqPrescaler <= 0) {\n        this.irqPrescaler += 341;\n        if (this.irqCounter === 0xFF) {\n          this.irqCounter = this.irqLatch;\n          this.irqPending = true;\n        } else {\n          this.irqCounter++;\n        }\n      }\n    }\n  }\n\n  getIrqPending(): boolean {\n    const pending = this.irqPending;\n    this.irqPending = false;\n    return pending;\n  }\n}\n\n/**\n * Mapper 225\n * \n * 用於 52合1、64合1、72合1 等合集卡帶\n * 支援高達 2MB PRG ROM 和 1MB CHR ROM\n */\nexport class Mapper225 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private chrBank: number = 0;\n  private prgMode: number = 0; // 0 = 32KB, 1 = 16KB\n  private mirrorMode: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.chrBank = 0;\n    this.prgMode = 0;\n    this.mirrorMode = MirrorMode.Vertical;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const totalPrgSize = this.prgBanks * 16384; // PRG ROM 總大小\n      \n      if (this.prgMode === 0) {\n        // 32KB 模式\n        const bank32k = this.prgBank >> 1;\n        const offset = address & 0x7FFF;\n        return ((bank32k * 32768) + offset) % totalPrgSize;\n      } else {\n        // 16KB 模式\n        const offset = address & 0x3FFF;\n        return ((this.prgBank * 16384) + offset) % totalPrgSize;\n      }\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, _data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      // $8000-$FFFF: Bank 選擇\n      // A0-A5: PRG bank\n      // A6: PRG mode (0=32KB, 1=16KB)\n      // A7: Mirroring (0=vertical, 1=horizontal)\n      // A8-A13: CHR bank\n      // A14: High PRG bit (512KB boundary)\n      \n      this.prgBank = (address & 0x3F) | ((address >> 8) & 0x40);\n      this.prgMode = (address >> 6) & 1;\n      this.chrBank = ((address >> 8) & 0x3F);\n      this.mirrorMode = (address & 0x80) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n      \n      return { mirrorMode: this.mirrorMode };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      if (this.chrBanks === 0) {\n        return address; // CHR RAM\n      }\n      const totalChrSize = this.chrBanks * 8192;\n      return ((this.chrBank * 8192) + (address & 0x1FFF)) % totalChrSize;\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000 && this.chrBanks === 0) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * Mapper 227\n * \n * 用於 1200合1 等合集卡帶\n * 支援高達 1MB PRG ROM (無 CHR ROM，使用 CHR RAM)\n */\nexport class Mapper227 implements Mapper {\n  private prgBanks: number;\n  private chrBanks: number;\n  private prgBank: number = 0;\n  private prgMode: number = 0; // 0 = 32KB, 1 = 16KB\n  private lastBank: boolean = false;\n  private mirrorMode: MirrorMode = MirrorMode.Vertical;\n\n  constructor(prgBanks: number, chrBanks: number) {\n    this.prgBanks = prgBanks;\n    this.chrBanks = chrBanks;\n  }\n\n  reset(): void {\n    this.prgBank = 0;\n    this.prgMode = 0;\n    this.lastBank = false;\n    this.mirrorMode = MirrorMode.Vertical;\n  }\n\n  cpuMapRead(address: number): number | null {\n    if (address >= 0x8000) {\n      const totalPrgSize = this.prgBanks * 16384;\n      \n      if (this.prgMode === 0) {\n        // 32KB 模式\n        const offset = address & 0x7FFF;\n        const bank32k = this.prgBank >> 1;\n        return ((bank32k * 32768) + offset) % totalPrgSize;\n      } else {\n        // 16KB 模式\n        const offset = address & 0x3FFF;\n        if (address >= 0xC000) {\n          if (this.lastBank) {\n            // $C000-$FFFF 映射到最後一個 bank\n            const lastBankStart = totalPrgSize - 16384;\n            return lastBankStart + offset;\n          } else {\n            // $C000-$FFFF 鏡像 $8000-$BFFF\n            return ((this.prgBank * 16384) + offset) % totalPrgSize;\n          }\n        }\n        return ((this.prgBank * 16384) + offset) % totalPrgSize;\n      }\n    }\n    return null;\n  }\n\n  cpuMapWrite(address: number, _data: number): MapperWriteResult | null {\n    if (address >= 0x8000) {\n      // $8000-$FFFF: Bank 選擇\n      // A0: PRG mode (0=32KB, 1=16KB)\n      // A1: Mirroring (0=vertical, 1=horizontal)\n      // A2-A6: PRG bank low bits\n      // A7: Last bank select (16KB mode only)\n      // A8-A9: PRG bank high bits\n      \n      this.prgMode = address & 0x01;\n      this.mirrorMode = (address & 0x02) ? MirrorMode.Horizontal : MirrorMode.Vertical;\n      this.prgBank = ((address >> 2) & 0x1F) | ((address >> 3) & 0x60);\n      this.lastBank = (address & 0x80) !== 0;\n      \n      return { mirrorMode: this.mirrorMode };\n    }\n    return null;\n  }\n\n  ppuMapRead(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n\n  ppuMapWrite(address: number): number | null {\n    if (address < 0x2000) {\n      return address; // CHR RAM\n    }\n    return null;\n  }\n}\n\n/**\n * 建立 Mapper 實例\n */\nexport function createMapper(mapperNumber: number, prgBanks: number, chrBanks: number): Mapper | null {\n  switch (mapperNumber) {\n    case 0:\n      return new Mapper0(prgBanks, chrBanks);\n    case 1:\n      return new Mapper1(prgBanks, chrBanks);\n    case 2:\n      return new Mapper2(prgBanks, chrBanks);\n    case 3:\n      return new Mapper3(prgBanks, chrBanks);\n    case 4:\n      return new Mapper4(prgBanks, chrBanks);\n    case 7:\n      return new Mapper7(prgBanks, chrBanks);\n    case 11:\n      return new Mapper11(prgBanks, chrBanks);\n    case 15:\n      return new Mapper15(prgBanks, chrBanks);\n    case 16:\n      return new Mapper16(prgBanks, chrBanks);\n    case 23:\n      return new Mapper23(prgBanks, chrBanks);\n    case 66:\n      return new Mapper66(prgBanks, chrBanks);\n    case 71:\n      return new Mapper71(prgBanks, chrBanks);\n    case 113:\n      return new Mapper113(prgBanks, chrBanks);\n    case 202:\n      return new Mapper202(prgBanks, chrBanks);\n    case 225:\n      return new Mapper225(prgBanks, chrBanks);\n    case 227:\n      return new Mapper227(prgBanks, chrBanks);\n    case 245:\n      return new Mapper245(prgBanks, chrBanks);\n    case 253:\n      return new Mapper253(prgBanks, chrBanks);\n    default:\n      console.warn(`未實作的 Mapper: ${mapperNumber}`);\n      return null;\n  }\n}\n","/**\n * NES 卡帶模組\n * \n * iNES 格式說明：\n * - Header (16 bytes)\n *   - Bytes 0-3: \"NES\" + 0x1A\n *   - Byte 4: PRG ROM 大小 (16KB 為單位)\n *   - Byte 5: CHR ROM 大小 (8KB 為單位)\n *   - Byte 6: Flags 6 (mapper 低 4 位元, 鏡像模式等)\n *   - Byte 7: Flags 7 (mapper 高 4 位元, NES 2.0 標識)\n *   - Bytes 8-15: 其他標誌\n * - Trainer (512 bytes, 可選)\n * - PRG ROM\n * - CHR ROM\n */\n\nimport { Mapper, createMapper } from '../mappers';\n\n/**\n * 鏡像模式\n */\nexport enum MirrorMode {\n  /** 水平鏡像 (垂直排列) */\n  Horizontal = 0,\n  /** 垂直鏡像 (水平排列) */\n  Vertical = 1,\n  /** 單螢幕 (低) */\n  SingleScreenLow = 2,\n  /** 單螢幕 (高) */\n  SingleScreenHigh = 3,\n  /** 四螢幕 */\n  FourScreen = 4,\n}\n\n/**\n * 卡帶標頭資訊\n */\nexport interface CartridgeHeader {\n  /** PRG ROM 大小 (位元組) */\n  prgRomSize: number;\n  /** CHR ROM 大小 (位元組) */\n  chrRomSize: number;\n  /** Mapper 編號 */\n  mapperNumber: number;\n  /** 鏡像模式 */\n  mirrorMode: MirrorMode;\n  /** 是否有電池備份 */\n  hasBattery: boolean;\n  /** 是否有 Trainer */\n  hasTrainer: boolean;\n  /** 是否為 NES 2.0 格式 */\n  isNes2: boolean;\n}\n\n/**\n * 卡帶類別\n */\nexport class Cartridge {\n  /** PRG ROM 資料 */\n  private prgRom: Uint8Array = new Uint8Array(0);\n  \n  /** CHR ROM 資料 (如果為 0 則使用 CHR RAM) */\n  private chrRom: Uint8Array = new Uint8Array(0);\n  \n  /** PRG RAM (8KB) */\n  private prgRam: Uint8Array = new Uint8Array(8192);\n  \n  /** CHR RAM (如果卡帶無 CHR ROM) */\n  private chrRam: Uint8Array = new Uint8Array(8192);\n  \n  /** 是否使用 CHR RAM */\n  private usesChrRam: boolean = false;\n  \n  /** 卡帶標頭資訊 */\n  private header: CartridgeHeader | null = null;\n  \n  /** Mapper */\n  private mapper: Mapper | null = null;\n  \n  /** 鏡像模式 */\n  private mirrorMode: MirrorMode = MirrorMode.Horizontal;\n\n  constructor() {\n    this.prgRam.fill(0);\n    this.chrRam.fill(0);\n  }\n\n  /**\n   * 從 ArrayBuffer 載入 ROM\n   */\n  public loadRom(data: ArrayBuffer): boolean {\n    const bytes = new Uint8Array(data);\n    \n    // 驗證 iNES 標頭\n    if (bytes[0] !== 0x4E || bytes[1] !== 0x45 ||\n        bytes[2] !== 0x53 || bytes[3] !== 0x1A) {\n      console.error('無效的 iNES 標頭');\n      return false;\n    }\n\n    // 解析標頭\n    const prgRomBanks = bytes[4];\n    const chrRomBanks = bytes[5];\n    const flags6 = bytes[6];\n    const flags7 = bytes[7];\n\n    this.header = {\n      prgRomSize: prgRomBanks * 16384,\n      chrRomSize: chrRomBanks * 8192,\n      mapperNumber: ((flags6 >> 4) & 0x0F) | (flags7 & 0xF0),\n      mirrorMode: (flags6 & 0x01) ? MirrorMode.Vertical : MirrorMode.Horizontal,\n      hasBattery: (flags6 & 0x02) !== 0,\n      hasTrainer: (flags6 & 0x04) !== 0,\n      isNes2: (flags7 & 0x0C) === 0x08,\n    };\n\n    // 四螢幕模式覆蓋\n    if (flags6 & 0x08) {\n      this.header.mirrorMode = MirrorMode.FourScreen;\n    }\n\n    this.mirrorMode = this.header.mirrorMode;\n\n    // 計算 ROM 資料偏移\n    let offset = 16;\n    if (this.header.hasTrainer) {\n      offset += 512;\n    }\n\n    // 載入 PRG ROM\n    this.prgRom = new Uint8Array(this.header.prgRomSize);\n    this.prgRom.set(bytes.slice(offset, offset + this.header.prgRomSize));\n    offset += this.header.prgRomSize;\n\n    // 載入 CHR ROM 或使用 CHR RAM\n    if (this.header.chrRomSize > 0) {\n      this.chrRom = new Uint8Array(this.header.chrRomSize);\n      this.chrRom.set(bytes.slice(offset, offset + this.header.chrRomSize));\n      this.usesChrRam = false;\n    } else {\n      // 使用 CHR RAM\n      this.chrRam = new Uint8Array(8192);\n      this.chrRam.fill(0);\n      this.usesChrRam = true;\n    }\n\n    // 建立 Mapper\n    this.mapper = createMapper(\n      this.header.mapperNumber,\n      prgRomBanks,\n      chrRomBanks\n    );\n\n    if (!this.mapper) {\n      console.error(`不支援的 Mapper: ${this.header.mapperNumber}`);\n      return false;\n    }\n\n    console.log(`ROM 載入成功:`);\n    console.log(`  PRG ROM: ${this.header.prgRomSize / 1024}KB`);\n    console.log(`  CHR ROM: ${this.header.chrRomSize / 1024}KB`);\n    console.log(`  Mapper: ${this.header.mapperNumber}`);\n    console.log(`  鏡像: ${MirrorMode[this.header.mirrorMode]}`);\n\n    return true;\n  }\n\n  /**\n   * CPU 讀取\n   */\n  public cpuRead(address: number): number {\n    // PRG RAM ($6000-$7FFF)\n    if (address >= 0x6000 && address < 0x8000) {\n      return this.prgRam[address & 0x1FFF];\n    }\n\n    // PRG ROM ($8000-$FFFF)\n    if (address >= 0x8000 && this.mapper) {\n      const mappedAddr = this.mapper.cpuMapRead(address);\n      if (mappedAddr !== null) {\n        return this.prgRom[mappedAddr % this.prgRom.length];\n      }\n    }\n\n    return 0;\n  }\n\n  /**\n   * CPU 寫入\n   */\n  public cpuWrite(address: number, data: number): void {\n    // PRG RAM ($6000-$7FFF)\n    if (address >= 0x6000 && address < 0x8000) {\n      this.prgRam[address & 0x1FFF] = data;\n      return;\n    }\n\n    // Mapper 暫存器寫入\n    if (address >= 0x8000 && this.mapper) {\n      const result = this.mapper.cpuMapWrite(address, data);\n      \n      // 檢查鏡像模式是否改變\n      if (result?.mirrorMode !== undefined) {\n        this.mirrorMode = result.mirrorMode;\n      }\n    }\n  }\n\n  /**\n   * PPU 讀取\n   */\n  public ppuRead(address: number): number {\n    if (address < 0x2000) {\n      if (this.mapper) {\n        const mappedAddr = this.mapper.ppuMapRead(address);\n        if (mappedAddr !== null) {\n          if (this.usesChrRam) {\n            return this.chrRam[mappedAddr % this.chrRam.length];\n          } else {\n            return this.chrRom[mappedAddr % this.chrRom.length];\n          }\n        }\n      }\n      \n      // 直接存取\n      if (this.usesChrRam) {\n        return this.chrRam[address];\n      } else {\n        return this.chrRom[address % this.chrRom.length];\n      }\n    }\n    return 0;\n  }\n\n  /**\n   * PPU 寫入\n   */\n  public ppuWrite(address: number, data: number): void {\n    if (address < 0x2000) {\n      if (this.mapper) {\n        const mappedAddr = this.mapper.ppuMapWrite(address);\n        if (mappedAddr !== null && this.usesChrRam) {\n          this.chrRam[mappedAddr % this.chrRam.length] = data;\n          return;\n        }\n      }\n      \n      // 直接寫入 CHR RAM\n      if (this.usesChrRam) {\n        this.chrRam[address] = data;\n      }\n    }\n  }\n\n  /**\n   * 取得鏡像模式\n   */\n  public getMirrorMode(): MirrorMode {\n    return this.mirrorMode;\n  }\n\n  /**\n   * 取得卡帶標頭資訊\n   */\n  public getHeader(): CartridgeHeader | null {\n    return this.header;\n  }\n\n  /**\n   * 重置卡帶\n   */\n  public reset(): void {\n    this.mapper?.reset?.();\n  }\n\n  /**\n   * 掃描線計數 (用於 MMC3 等 Mapper)\n   */\n  public scanline(): void {\n    this.mapper?.scanline?.();\n  }\n\n  /**\n   * CPU 週期計數 (用於 Bandai FCG 等 Mapper)\n   */\n  public cpuClock(): void {\n    this.mapper?.cpuClock?.();\n  }\n\n  /**\n   * 檢查 Mapper IRQ\n   */\n  public checkIrq(): boolean {\n    if (this.mapper && 'getIrqPending' in this.mapper) {\n      return (this.mapper as any).getIrqPending();\n    }\n    return false;\n  }\n\n  // ===== 序列化 (存檔) =====\n\n  /** 儲存狀態 */\n  public saveState(): object {\n    return {\n      prgRam: Array.from(this.prgRam),\n      chrRam: this.usesChrRam ? Array.from(this.chrRam) : [],\n      mirrorMode: this.mirrorMode,\n    };\n  }\n\n  /** 載入狀態 */\n  public loadState(state: any): void {\n    this.prgRam.set(state.prgRam);\n    if (this.usesChrRam && state.chrRam.length > 0) {\n      this.chrRam.set(state.chrRam);\n    }\n    this.mirrorMode = state.mirrorMode;\n  }\n}\n","/**\n * NES 控制器模擬\n * \n * 標準 NES 控制器有 8 個按鈕，按讀取順序：\n * A, B, Select, Start, Up, Down, Left, Right\n */\n\n/**\n * 控制器按鈕\n */\nexport enum ControllerButton {\n  A = 0,\n  B = 1,\n  Select = 2,\n  Start = 3,\n  Up = 4,\n  Down = 5,\n  Left = 6,\n  Right = 7,\n}\n\n/**\n * 控制器按鈕位元遮罩\n */\nexport const BUTTON_MASKS = {\n  [ControllerButton.A]: 1 << 7,\n  [ControllerButton.B]: 1 << 6,\n  [ControllerButton.Select]: 1 << 5,\n  [ControllerButton.Start]: 1 << 4,\n  [ControllerButton.Up]: 1 << 3,\n  [ControllerButton.Down]: 1 << 2,\n  [ControllerButton.Left]: 1 << 1,\n  [ControllerButton.Right]: 1 << 0,\n};\n\n/**\n * 控制器類別\n */\nexport class Controller {\n  /** 按鈕狀態 (8 位元，每個位元代表一個按鈕) */\n  private buttonState: number = 0;\n\n  constructor() {\n    this.buttonState = 0;\n  }\n\n  /**\n   * 設定按鈕狀態\n   * @param button 按鈕\n   * @param pressed 是否按下\n   */\n  public setButton(button: ControllerButton, pressed: boolean): void {\n    const mask = BUTTON_MASKS[button];\n    if (pressed) {\n      this.buttonState |= mask;\n    } else {\n      this.buttonState &= ~mask;\n    }\n  }\n\n  /**\n   * 取得按鈕狀態\n   * @param button 按鈕\n   * @returns 是否按下\n   */\n  public isButtonPressed(button: ControllerButton): boolean {\n    return (this.buttonState & BUTTON_MASKS[button]) !== 0;\n  }\n\n  /**\n   * 取得完整的按鈕狀態 (用於序列化讀取)\n   * @returns 8 位元狀態值\n   */\n  public getState(): number {\n    return this.buttonState;\n  }\n\n  /**\n   * 重置所有按鈕\n   */\n  public reset(): void {\n    this.buttonState = 0;\n  }\n}\n\n/**\n * 預設鍵盤映射 (玩家 1)\n */\nexport const DEFAULT_KEYBOARD_MAP_P1: Record<string, ControllerButton> = {\n  'KeyZ': ControllerButton.A,\n  'KeyX': ControllerButton.B,\n  'ShiftRight': ControllerButton.Select,\n  'Enter': ControllerButton.Start,\n  'ArrowUp': ControllerButton.Up,\n  'ArrowDown': ControllerButton.Down,\n  'ArrowLeft': ControllerButton.Left,\n  'ArrowRight': ControllerButton.Right,\n};\n\n/**\n * 預設鍵盤映射 (玩家 2)\n */\nexport const DEFAULT_KEYBOARD_MAP_P2: Record<string, ControllerButton> = {\n  'KeyN': ControllerButton.A,\n  'KeyM': ControllerButton.B,\n  'KeyQ': ControllerButton.Select,\n  'KeyW': ControllerButton.Start,\n  'KeyI': ControllerButton.Up,\n  'KeyK': ControllerButton.Down,\n  'KeyJ': ControllerButton.Left,\n  'KeyL': ControllerButton.Right,\n};\n\n/**\n * 鍵盤輸入處理器\n */\nexport class KeyboardInputHandler {\n  private controller: Controller;\n  private keyMap: Record<string, ControllerButton>;\n\n  constructor(controller: Controller, keyMap: Record<string, ControllerButton>) {\n    this.controller = controller;\n    this.keyMap = keyMap;\n  }\n\n  /**\n   * 處理按鍵按下\n   */\n  public handleKeyDown(event: KeyboardEvent): void {\n    const button = this.keyMap[event.code];\n    if (button !== undefined) {\n      this.controller.setButton(button, true);\n      event.preventDefault();\n    }\n  }\n\n  /**\n   * 處理按鍵釋放\n   */\n  public handleKeyUp(event: KeyboardEvent): void {\n    const button = this.keyMap[event.code];\n    if (button !== undefined) {\n      this.controller.setButton(button, false);\n      event.preventDefault();\n    }\n  }\n\n  /**\n   * 綁定到 window 事件\n   */\n  public bind(): void {\n    window.addEventListener('keydown', this.handleKeyDown.bind(this));\n    window.addEventListener('keyup', this.handleKeyUp.bind(this));\n  }\n\n  /**\n   * 解除綁定\n   */\n  public unbind(): void {\n    window.removeEventListener('keydown', this.handleKeyDown.bind(this));\n    window.removeEventListener('keyup', this.handleKeyUp.bind(this));\n  }\n}\n","/**\n * NES 主控台 - 整合所有硬體元件\n */\n\nimport { Cpu } from './cpu';\nimport { Ppu } from './ppu';\nimport { Apu } from './apu';\nimport { Bus } from './bus';\nimport { Cartridge } from './cartridge';\nimport { Controller } from './controller';\n\n/**\n * 存檔資料結構\n */\nexport interface SaveState {\n  version: number;\n  timestamp: number;\n  cpu: object;\n  ppu: object;\n  apu: object;\n  bus: object;\n  cartridge: object;\n}\n\n/**\n * NES 主控台類別\n */\nexport class Nes {\n  /** CPU */\n  public readonly cpu: Cpu;\n  \n  /** PPU */\n  public readonly ppu: Ppu;\n  \n  /** APU */\n  public readonly apu: Apu;\n  \n  /** 記憶體匯流排 */\n  public readonly bus: Bus;\n  \n  /** 卡帶 */\n  public readonly cartridge: Cartridge;\n  \n  /** 控制器 1 */\n  public readonly controller1: Controller;\n  \n  /** 控制器 2 */\n  public readonly controller2: Controller;\n\n  /** 系統時鐘計數器 */\n  private systemClockCounter: number = 0;\n  \n  /** 存檔版本 */\n  private static readonly SAVE_STATE_VERSION = 1;\n\n  constructor() {\n    this.bus = new Bus();\n    this.cpu = new Cpu(this.bus);\n    this.ppu = new Ppu();\n    this.apu = new Apu();\n    this.cartridge = new Cartridge();\n    this.controller1 = new Controller();\n    this.controller2 = new Controller();\n\n    // 連接元件\n    this.bus.connectPpu(this.ppu);\n    this.bus.connectApu(this.apu);\n    this.bus.connectCartridge(this.cartridge);\n    this.bus.connectController(1, this.controller1);\n    this.bus.connectController(2, this.controller2);\n    this.ppu.connectCartridge(this.cartridge);\n    \n    // 設定 APU 的記憶體讀取器 (用於 DMC)\n    this.apu.setMemoryReader((addr) => this.bus.cpuRead(addr));\n    \n    // 設定 APU IRQ 回調\n    this.apu.setIrqCallback(() => this.cpu.irq());\n  }\n\n  /**\n   * 載入 ROM\n   */\n  public loadRom(data: ArrayBuffer): boolean {\n    const success = this.cartridge.loadRom(data);\n    if (success) {\n      this.reset();\n    }\n    return success;\n  }\n\n  /**\n   * 重置系統\n   */\n  public reset(): void {\n    this.cartridge.reset();\n    this.cpu.reset();\n    this.ppu.reset();\n    this.apu.reset();\n    this.systemClockCounter = 0;\n  }\n\n  /**\n   * 執行一個主時鐘週期\n   * \n   * NES 的時序關係：\n   * - PPU 時鐘 = 主時鐘\n   * - CPU 時鐘 = 主時鐘 / 3\n   */\n  public clock(): void {\n    // PPU 每個主時鐘都執行\n    this.ppu.clock();\n\n    // CPU 每 3 個主時鐘執行一次\n    if (this.systemClockCounter % 3 === 0) {\n      // 檢查是否正在 DMA 傳輸\n      if (this.bus.isDmaTransferring()) {\n        this.bus.doCycle(this.systemClockCounter % 2 === 1);\n      } else {\n        this.cpu.clock();\n      }\n      \n      // APU 每個 CPU 週期執行\n      this.apu.clock();\n      \n      // Mapper CPU 週期計時 (用於 Bandai FCG 等 cycle-based IRQ)\n      this.cartridge.cpuClock();\n    }\n\n    // 檢查 NMI\n    if (this.ppu.checkNmi()) {\n      this.cpu.nmi();\n    }\n    \n    // 檢查 Mapper scanline IRQ (用於 MMC3 等 scanline-based IRQ)\n    if (this.ppu.checkScanlineIrq()) {\n      this.cartridge.scanline();\n    }\n    \n    // 檢查 Mapper IRQ (統一處理 cycle-based 和 scanline-based)\n    if (this.cartridge.checkIrq()) {\n      this.cpu.irq();\n    }\n\n    this.systemClockCounter++;\n  }\n\n  /**\n   * 執行一幀\n   */\n  public frame(): void {\n    // 執行直到幀完成\n    this.ppu.frameComplete = false;\n    while (!this.ppu.frameComplete) {\n      this.clock();\n    }\n  }\n\n  /**\n   * 執行一條 CPU 指令\n   */\n  public step(): void {\n    // 執行直到 CPU 完成一條指令\n    do {\n      this.clock();\n    } while (this.cpu['cycles'] > 0);\n  }\n\n  /**\n   * 取得幀緩衝區\n   */\n  public getFrameBuffer(): Uint32Array {\n    return this.ppu.frameBuffer;\n  }\n\n  /**\n   * 取得系統狀態 (用於除錯)\n   */\n  public getState(): object {\n    return {\n      cpu: {\n        pc: this.cpu.pc,\n        a: this.cpu.a,\n        x: this.cpu.x,\n        y: this.cpu.y,\n        sp: this.cpu.sp,\n        status: this.cpu.status,\n        totalCycles: this.cpu.totalCycles,\n      },\n      systemClockCounter: this.systemClockCounter,\n    };\n  }\n\n  // ===== 存檔功能 =====\n\n  /**\n   * 建立存檔\n   */\n  public saveState(): SaveState {\n    return {\n      version: Nes.SAVE_STATE_VERSION,\n      timestamp: Date.now(),\n      cpu: this.cpu.saveState(),\n      ppu: this.ppu.saveState(),\n      apu: this.apu.saveState(),\n      bus: this.bus.saveState(),\n      cartridge: this.cartridge.saveState(),\n    };\n  }\n\n  /**\n   * 載入存檔\n   */\n  public loadState(state: SaveState): boolean {\n    if (state.version !== Nes.SAVE_STATE_VERSION) {\n      console.error(`存檔版本不符: ${state.version} !== ${Nes.SAVE_STATE_VERSION}`);\n      return false;\n    }\n\n    try {\n      this.cpu.loadState(state.cpu);\n      this.ppu.loadState(state.ppu);\n      this.apu.loadState(state.apu);\n      this.bus.loadState(state.bus);\n      this.cartridge.loadState(state.cartridge);\n      return true;\n    } catch (e) {\n      console.error('載入存檔失敗:', e);\n      return false;\n    }\n  }\n\n  /**\n   * 匯出存檔為 JSON 字串\n   */\n  public exportSaveState(): string {\n    const state = this.saveState();\n    return JSON.stringify(state);\n  }\n\n  /**\n   * 從 JSON 字串匯入存檔\n   */\n  public importSaveState(json: string): boolean {\n    try {\n      const state = JSON.parse(json) as SaveState;\n      return this.loadState(state);\n    } catch (e) {\n      console.error('解析存檔失敗:', e);\n      return false;\n    }\n  }\n\n  /**\n   * 從 APU 讀取音頻取樣到輸出緩衝區\n   */\n  public readAudioSamples(outputBuffer: Float32Array): number {\n    return this.apu.readSamples(outputBuffer);\n  }\n\n  /**\n   * 取得可用的音頻取樣數\n   */\n  public getAvailableAudioSamples(): number {\n    return this.apu.getAvailableSamples();\n  }\n\n  /**\n   * 設定音頻取樣率\n   */\n  public setAudioSampleRate(rate: number): void {\n    this.apu.setSampleRate(rate);\n  }\n}\n"],"names":["Cpu","bus","flag","value","address","data","lo","hi","instruction","startCycles","mode","ptrLo","ptrHi","ptr","zp","result","table","instructions","opcode","name","execute","cycles","flags","bytes","operand","offset","state","SYSTEM_PALETTE","Ppu","cartridge","mirroredAddr","coarseY","i","spriteHeight","y","diff","j","spriteIndex","row","tileIndex","attributes","flipVertical","flipHorizontal","patternAddr","patternLo","patternHi","b","x","bgPixel","bgPalette","spritePixel","spritePalette","spritePriority","mux","p0","p1","a0","a1","attr","finalPixel","finalPalette","colorIndex","color","paletteIndex","index","palette","tileY","tileX","tileLo","tileHi","col","pixel","LENGTH_TABLE","Envelope","constant","volume","loop","LengthCounter","halt","Sweep","isChannel1","period","changeAmount","targetPeriod","currentPeriod","DUTY_TABLE","PulseChannel","lengthIndex","newPeriod","enabled","TRIANGLE_SEQUENCE","TriangleChannel","NOISE_PERIOD_TABLE","NoiseChannel","bit0","bit1","feedback","DMC_PERIOD_TABLE","DmcChannel","reader","callback","FOUR_STEP_SEQUENCE","FIVE_STEP_SEQUENCE","FrameCounter","sequence","action","Apu","rate","frameAction","pulse1","pulse2","triangle","noise","dmc","pulseOut","tndOut","sample","input","sum","tnd","status","outputBuffer","samplesRead","length","available","tempBuffer","ratio","pos","frac","current","next","Bus","ppu","apu","port","controller","oddCycle","Mapper0","prgBanks","chrBanks","mask","_address","_data","Mapper1","prgMode","complete","targetRegister","mirrorBits","mirrorMode","MirrorMode","chrMode","totalChrBanks","Mapper2","Mapper3","Mapper4","even","lastBank","secondLastBank","region","pending","Mapper7","_chrBanks","Mapper11","Mapper16","reg","Mapper23","bank","Mapper66","Mapper71","Mapper15","bank8k","totalBanks","Mapper113","Mapper202","totalPrgSize","bank32k","totalChrSize","Mapper245","prgBankCount","Mapper253","Mapper225","Mapper227","createMapper","mapperNumber","Cartridge","prgRomBanks","chrRomBanks","flags6","flags7","mappedAddr","ControllerButton","BUTTON_MASKS","Controller","button","pressed","DEFAULT_KEYBOARD_MAP_P1","KeyboardInputHandler","keyMap","event","Nes","addr","success","json"],"mappings":"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"}