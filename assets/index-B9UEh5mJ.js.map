{"version":3,"file":"index-B9UEh5mJ.js","sources":["../../src/main.ts"],"sourcesContent":["/**\n * H5-NES Ê®°Êì¨Âô®‰∏ªÁ®ãÂºèÂÖ•Âè£\n * \n * ÂäüËÉΩÔºö\n * - GameBoy È¢®Ê†º UI\n * - ROM ÈÅ∏ÊìáÂô®\n * - ËôõÊì¨ÊéßÂà∂Âô® (ÊâãÊ©üÁâà)\n * - RWD ÈüøÊáâÂºèË®≠Ë®à\n */\n\nimport { \n  Nes, \n  KeyboardInputHandler, \n  DEFAULT_KEYBOARD_MAP_P1,\n  Controller,\n  ControllerButton\n} from './core';\n\n// ===== ÂûãÂà•ÂÆöÁæ© =====\n\ninterface RomInfo {\n  name: string;\n  file: string;\n}\n\ninterface RomListResponse {\n  roms: RomInfo[];\n}\n\n// ===== ÂÖ®ÂüüËÆäÊï∏ =====\n\nlet nes: Nes | null = null;\nlet animationId: number | null = null;\nlet canvas: HTMLCanvasElement | null = null;\nlet ctx: CanvasRenderingContext2D | null = null;\nlet imageData: ImageData | null = null;\nlet audioContext: AudioContext | null = null;\nlet isRunning: boolean = false;\n\n// ===== UI ÂÖÉÁ¥† =====\n\nlet romSelector: HTMLElement | null = null;\nlet gameboyShell: HTMLElement | null = null;\nlet powerLed: HTMLElement | null = null;\n\n// ===== Èü≥È†ªË®≠ÂÆö =====\nconst AUDIO_BUFFER_SIZE = 4096;\n\n// ===== ÂàùÂßãÂåñ =====\n\n/**\n * ÂàùÂßãÂåñÊ®°Êì¨Âô®\n */\nfunction init(): void {\n  // ÂèñÂæó UI ÂÖÉÁ¥†\n  romSelector = document.getElementById('rom-selector');\n  gameboyShell = document.getElementById('gameboy-shell');\n  powerLed = document.getElementById('power-led');\n  \n  // Âª∫Á´ãÁï´Â∏É\n  canvas = document.getElementById('screen') as HTMLCanvasElement;\n  if (!canvas) {\n    console.error('Êâæ‰∏çÂà∞Áï´Â∏ÉÂÖÉÁ¥†');\n    return;\n  }\n\n  ctx = canvas.getContext('2d');\n  if (!ctx) {\n    console.error('ÁÑ°Ê≥ïÂèñÂæó Canvas 2D ‰∏ä‰∏ãÊñá');\n    return;\n  }\n\n  imageData = ctx.createImageData(256, 240);\n\n  // Âª∫Á´ã NES ÂØ¶‰æã\n  nes = new Nes();\n\n  // Ë®≠ÂÆöÈçµÁõ§Ëº∏ÂÖ•\n  const inputHandler = new KeyboardInputHandler(\n    nes.controller1,\n    DEFAULT_KEYBOARD_MAP_P1\n  );\n  inputHandler.bind();\n\n  // Ë®≠ÂÆöËôõÊì¨ÊéßÂà∂Âô®\n  setupVirtualController(nes.controller1);\n\n  // Ë®≠ÂÆöÈõªËÖ¶ÁâàÊéßÂà∂ÊåâÈàï\n  setupDesktopControls();\n\n  // Ë®≠ÂÆö ROM ÈÅ∏ÊìáÂô®\n  setupRomSelector();\n\n  // Ë®≠ÂÆöÊ™îÊ°àÈÅ∏ÊìáÂô®\n  setupFileInput();\n\n  console.log('H5-NES Ê®°Êì¨Âô®Â∑≤ÂàùÂßãÂåñ');\n}\n\n// ===== ROM ÈÅ∏ÊìáÂô® =====\n\n/**\n * Ë®≠ÂÆö ROM ÈÅ∏ÊìáÂô®\n */\nfunction setupRomSelector(): void {\n  loadRomList();\n  \n  // Ë®≠ÂÆöÊ™îÊ°à‰∏äÂÇ≥\n  const fileInput = document.getElementById('rom-file-input') as HTMLInputElement;\n  fileInput?.addEventListener('change', async (e) => {\n    const file = (e.target as HTMLInputElement).files?.[0];\n    if (file) {\n      await loadRomFromFile(file);\n    }\n  });\n}\n\n/**\n * ËºâÂÖ• ROM ÂàóË°®\n */\nasync function loadRomList(): Promise<void> {\n  const romListEl = document.getElementById('rom-list');\n  if (!romListEl) return;\n\n  try {\n    // ‰ΩøÁî® Vite ÁöÑ BASE_URL Á¢∫‰øùÂú® GitHub Pages Á≠âÂ≠êÁõÆÈåÑÈÉ®ÁΩ≤ÊôÇË∑ØÂæëÊ≠£Á¢∫\n    const baseUrl = import.meta.env.BASE_URL;\n    const response = await fetch(`${baseUrl}roms.json`);\n    if (!response.ok) {\n      throw new Error('ÁÑ°Ê≥ïËºâÂÖ• ROM ÂàóË°®');\n    }\n    \n    const data: RomListResponse = await response.json();\n    renderRomList(data.roms);\n  } catch (error) {\n    console.error('ËºâÂÖ• ROM ÂàóË°®Â§±Êïó:', error);\n    romListEl.innerHTML = `\n      <div class=\"rom-error\">\n        <p>‚ö†Ô∏è ÁÑ°Ê≥ïËºâÂÖ•ÈÅäÊà≤ÂàóË°®</p>\n        <p>Ë´ã‰ΩøÁî®‰∏ãÊñπÊåâÈàïÈÅ∏Êìá ROM Ê™îÊ°à</p>\n      </div>\n    `;\n  }\n}\n\n/**\n * Ê∏≤Êüì ROM ÂàóË°®\n */\nfunction renderRomList(roms: RomInfo[]): void {\n  const romListEl = document.getElementById('rom-list');\n  if (!romListEl) return;\n\n  if (roms.length === 0) {\n    romListEl.innerHTML = '<div class=\"rom-empty\">Ê≤íÊúâÂèØÁî®ÁöÑÈÅäÊà≤</div>';\n    return;\n  }\n\n  romListEl.innerHTML = roms.map((rom, index) => `\n    <button class=\"rom-item\" data-index=\"${index}\" data-file=\"${encodeURIComponent(rom.file)}\">\n      <span class=\"rom-icon\">üéÆ</span>\n      <span class=\"rom-name\">${rom.name}</span>\n      <span class=\"rom-arrow\">‚ñ∂</span>\n    </button>\n  `).join('');\n\n  // Á∂ÅÂÆöÈªûÊìä‰∫ã‰ª∂\n  const items = romListEl.querySelectorAll('.rom-item');\n  items.forEach(item => {\n    item.addEventListener('click', async () => {\n      const file = decodeURIComponent((item as HTMLElement).dataset.file || '');\n      if (file) {\n        await loadRomFromServer(file);\n      }\n    });\n  });\n}\n\n/**\n * Âæû‰º∫ÊúçÂô®ËºâÂÖ• ROM\n */\nasync function loadRomFromServer(filename: string): Promise<void> {\n  try {\n    // ‰ΩøÁî® Vite ÁöÑ BASE_URL Á¢∫‰øùÂú® GitHub Pages Á≠âÂ≠êÁõÆÈåÑÈÉ®ÁΩ≤ÊôÇË∑ØÂæëÊ≠£Á¢∫\n    const baseUrl = import.meta.env.BASE_URL;\n    const response = await fetch(`${baseUrl}roms/${encodeURIComponent(filename)}`);\n    if (!response.ok) {\n      throw new Error(`ÁÑ°Ê≥ïËºâÂÖ• ROM: ${filename}`);\n    }\n    \n    const buffer = await response.arrayBuffer();\n    startGame(buffer);\n  } catch (error) {\n    console.error('ËºâÂÖ• ROM Â§±Êïó:', error);\n    alert('ËºâÂÖ•ÈÅäÊà≤Â§±ÊïóÔºåË´ãÈáçË©¶');\n  }\n}\n\n/**\n * ÂæûÊ™îÊ°àËºâÂÖ• ROM\n */\nasync function loadRomFromFile(file: File): Promise<void> {\n  try {\n    const buffer = await file.arrayBuffer();\n    startGame(buffer);\n  } catch (error) {\n    console.error('ËºâÂÖ• ROM Â§±Êïó:', error);\n    alert('ËºâÂÖ•ÈÅäÊà≤Â§±ÊïóÔºåË´ãÈáçË©¶');\n  }\n}\n\n/**\n * ÈñãÂßãÈÅäÊà≤\n */\nfunction startGame(romData: ArrayBuffer): void {\n  if (!nes) return;\n\n  if (nes.loadRom(romData)) {\n    console.log('ROM ËºâÂÖ•ÊàêÂäüÔºåÈñãÂßãÂü∑Ë°å');\n    \n    // Èö±ËóèÈÅ∏ÊìáÂô®ÔºåÈ°ØÁ§∫ÈÅäÊà≤Áï´Èù¢\n    hideRomSelector();\n    \n    // Á¢∫‰øùÈü≥È†ªÁ≥ªÁµ±Ë®≠ÂÆöÊ≠£Á¢∫\n    if (audioContext) {\n      nes.setAudioSampleRate(audioContext.sampleRate);\n      resumeAudio();\n    }\n    \n    // ÈñãÂïüÈõªÊ∫êÊåáÁ§∫Ááà\n    powerLed?.classList.add('on');\n    \n    // ÈñãÂßãÊ®°Êì¨\n    startEmulation();\n  } else {\n    console.error('ROM ËºâÂÖ•Â§±Êïó');\n    alert('ÁÑ°Ê≥ïËºâÂÖ•Ê≠§ ROM Ê™îÊ°à');\n  }\n}\n\n/**\n * Èö±Ëóè ROM ÈÅ∏ÊìáÂô®\n */\nfunction hideRomSelector(): void {\n  if (romSelector) romSelector.style.display = 'none';\n  if (gameboyShell) gameboyShell.style.display = 'flex';\n}\n\n/**\n * È°ØÁ§∫ ROM ÈÅ∏ÊìáÂô®\n */\nfunction showRomSelector(): void {\n  stopEmulation();\n  powerLed?.classList.remove('on');\n  if (romSelector) romSelector.style.display = 'flex';\n  if (gameboyShell) gameboyShell.style.display = 'none';\n}\n\n// ===== ËôõÊì¨ÊéßÂà∂Âô® (Â§öÈªûËß∏ÊéßÊîØÊè¥) =====\n\n// ËøΩËπ§Ê¥ªË∫çÁöÑËß∏ÊéßÈªû\ninterface TouchState {\n  identifier: number;\n  element: string;  // 'dpad', 'a', 'b', 'start', 'select'\n}\n\nconst activeTouches: Map<number, TouchState> = new Map();\n\n// D-Pad ÊñπÂêëÁãÄÊÖã\ninterface DpadState {\n  up: boolean;\n  down: boolean;\n  left: boolean;\n  right: boolean;\n}\n\nlet currentDpadState: DpadState = { up: false, down: false, left: false, right: false };\n\n/**\n * Ë®≠ÂÆöËôõÊì¨ÊéßÂà∂Âô® (ÊîØÊè¥Â§öÈªûËß∏Êéß)\n */\nfunction setupVirtualController(controller: Controller): void {\n  // Ë®≠ÂÆö D-Pad Ëß∏ÊéßÂçÄÂüü (ÊîØÊè¥ÊñúÂêë)\n  setupDpad(controller);\n  \n  // Ë®≠ÂÆö A/B ÊåâÈàï (ÊîØÊè¥ÂêåÊôÇÊåâ)\n  setupABButtons(controller);\n  \n  // Ë®≠ÂÆöÂäüËÉΩÊåâÈàï (Select/Start)\n  setupFunctionButtons(controller);\n\n  // Èò≤Ê≠¢È†ÅÈù¢Êç≤Âãï\n  const virtualController = document.getElementById('virtual-controller');\n  virtualController?.addEventListener('touchmove', (e) => {\n    e.preventDefault();\n  }, { passive: false });\n}\n\n/**\n * Ë®≠ÂÆö D-Pad (ÂçÄÂüüÂÅµÊ∏¨ÔºåÊîØÊè¥ÊñúÂêëËº∏ÂÖ•)\n */\nfunction setupDpad(controller: Controller): void {\n  const dpadArea = document.getElementById('dpad-touch-area');\n  const dpad = document.getElementById('dpad');\n  if (!dpadArea || !dpad) return;\n\n  const updateDpadFromTouch = (touch: Touch) => {\n    const rect = dpad.getBoundingClientRect();\n    const centerX = rect.left + rect.width / 2;\n    const centerY = rect.top + rect.height / 2;\n    \n    const dx = touch.clientX - centerX;\n    const dy = touch.clientY - centerY;\n    \n    // Ë®àÁÆóË∑ùÈõ¢‰∏≠ÂøÉÁöÑË∑ùÈõ¢\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    const maxRadius = rect.width / 2;\n    \n    // Ê≠ªÂçÄÔºöË∑ùÈõ¢‰∏≠ÂøÉÂ§™ËøëÊôÇ‰∏çËß∏Áôº\n    const deadZone = maxRadius * 0.15;\n    \n    const newState: DpadState = { up: false, down: false, left: false, right: false };\n    \n    if (distance > deadZone) {\n      // Ë®àÁÆóËßíÂ∫¶ (-180 Âà∞ 180)\n      const angle = Math.atan2(dy, dx) * 180 / Math.PI;\n      \n      // 45 Â∫¶ÂàÜÂâ≤ÔºåÊîØÊè¥ 8 ÊñπÂêë\n      // Âè≥: -22.5 Âà∞ 22.5\n      // Âè≥‰∏ã: 22.5 Âà∞ 67.5\n      // ‰∏ã: 67.5 Âà∞ 112.5\n      // Â∑¶‰∏ã: 112.5 Âà∞ 157.5\n      // Â∑¶: 157.5 Âà∞ 180 Êàñ -180 Âà∞ -157.5\n      // Â∑¶‰∏ä: -157.5 Âà∞ -112.5\n      // ‰∏ä: -112.5 Âà∞ -67.5\n      // Âè≥‰∏ä: -67.5 Âà∞ -22.5\n      \n      if (angle >= -22.5 && angle < 22.5) {\n        newState.right = true;\n      } else if (angle >= 22.5 && angle < 67.5) {\n        newState.right = true;\n        newState.down = true;\n      } else if (angle >= 67.5 && angle < 112.5) {\n        newState.down = true;\n      } else if (angle >= 112.5 && angle < 157.5) {\n        newState.left = true;\n        newState.down = true;\n      } else if (angle >= 157.5 || angle < -157.5) {\n        newState.left = true;\n      } else if (angle >= -157.5 && angle < -112.5) {\n        newState.left = true;\n        newState.up = true;\n      } else if (angle >= -112.5 && angle < -67.5) {\n        newState.up = true;\n      } else if (angle >= -67.5 && angle < -22.5) {\n        newState.right = true;\n        newState.up = true;\n      }\n    }\n    \n    applyDpadState(controller, newState);\n  };\n\n  const clearDpad = () => {\n    const newState: DpadState = { up: false, down: false, left: false, right: false };\n    applyDpadState(controller, newState);\n  };\n\n  // Ëß∏ÊéßÈñãÂßã\n  dpadArea.addEventListener('touchstart', (e) => {\n    e.preventDefault();\n    for (const touch of Array.from(e.changedTouches)) {\n      activeTouches.set(touch.identifier, { identifier: touch.identifier, element: 'dpad' });\n      updateDpadFromTouch(touch);\n    }\n  }, { passive: false });\n\n  // Ëß∏ÊéßÁßªÂãï (ÊîØÊè¥ÊªëÂãïÊîπËÆäÊñπÂêë)\n  dpadArea.addEventListener('touchmove', (e) => {\n    e.preventDefault();\n    for (const touch of Array.from(e.changedTouches)) {\n      if (activeTouches.get(touch.identifier)?.element === 'dpad') {\n        updateDpadFromTouch(touch);\n      }\n    }\n  }, { passive: false });\n\n  // Ëß∏ÊéßÁµêÊùü\n  dpadArea.addEventListener('touchend', (e) => {\n    e.preventDefault();\n    for (const touch of Array.from(e.changedTouches)) {\n      if (activeTouches.get(touch.identifier)?.element === 'dpad') {\n        activeTouches.delete(touch.identifier);\n        // Ê™¢Êü•ÊòØÂê¶ÈÇÑÊúâÂÖ∂‰ªñ D-Pad Ëß∏Êéß\n        const remainingDpadTouches = Array.from(activeTouches.values()).filter(t => t.element === 'dpad');\n        if (remainingDpadTouches.length === 0) {\n          clearDpad();\n        }\n      }\n    }\n  }, { passive: false });\n\n  dpadArea.addEventListener('touchcancel', (e) => {\n    e.preventDefault();\n    for (const touch of Array.from(e.changedTouches)) {\n      activeTouches.delete(touch.identifier);\n    }\n    clearDpad();\n  }, { passive: false });\n\n  // ÊªëÈº†‰∫ã‰ª∂ (Áî®ÊñºÈõªËÖ¶Ê∏¨Ë©¶)\n  let mouseDown = false;\n  dpadArea.addEventListener('mousedown', (e) => {\n    e.preventDefault();\n    mouseDown = true;\n    const rect = dpad.getBoundingClientRect();\n    const centerX = rect.left + rect.width / 2;\n    const centerY = rect.top + rect.height / 2;\n    const dx = e.clientX - centerX;\n    const dy = e.clientY - centerY;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    const maxRadius = rect.width / 2;\n    const deadZone = maxRadius * 0.15;\n    \n    const newState: DpadState = { up: false, down: false, left: false, right: false };\n    \n    if (distance > deadZone) {\n      const angle = Math.atan2(dy, dx) * 180 / Math.PI;\n      if (angle >= -22.5 && angle < 22.5) newState.right = true;\n      else if (angle >= 22.5 && angle < 67.5) { newState.right = true; newState.down = true; }\n      else if (angle >= 67.5 && angle < 112.5) newState.down = true;\n      else if (angle >= 112.5 && angle < 157.5) { newState.left = true; newState.down = true; }\n      else if (angle >= 157.5 || angle < -157.5) newState.left = true;\n      else if (angle >= -157.5 && angle < -112.5) { newState.left = true; newState.up = true; }\n      else if (angle >= -112.5 && angle < -67.5) newState.up = true;\n      else if (angle >= -67.5 && angle < -22.5) { newState.right = true; newState.up = true; }\n    }\n    applyDpadState(controller, newState);\n  });\n\n  document.addEventListener('mousemove', (e) => {\n    if (!mouseDown) return;\n    const rect = dpad.getBoundingClientRect();\n    const centerX = rect.left + rect.width / 2;\n    const centerY = rect.top + rect.height / 2;\n    const dx = e.clientX - centerX;\n    const dy = e.clientY - centerY;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    const maxRadius = rect.width / 2;\n    const deadZone = maxRadius * 0.15;\n    \n    const newState: DpadState = { up: false, down: false, left: false, right: false };\n    \n    if (distance > deadZone && distance < maxRadius * 1.5) {\n      const angle = Math.atan2(dy, dx) * 180 / Math.PI;\n      if (angle >= -22.5 && angle < 22.5) newState.right = true;\n      else if (angle >= 22.5 && angle < 67.5) { newState.right = true; newState.down = true; }\n      else if (angle >= 67.5 && angle < 112.5) newState.down = true;\n      else if (angle >= 112.5 && angle < 157.5) { newState.left = true; newState.down = true; }\n      else if (angle >= 157.5 || angle < -157.5) newState.left = true;\n      else if (angle >= -157.5 && angle < -112.5) { newState.left = true; newState.up = true; }\n      else if (angle >= -112.5 && angle < -67.5) newState.up = true;\n      else if (angle >= -67.5 && angle < -22.5) { newState.right = true; newState.up = true; }\n    }\n    applyDpadState(controller, newState);\n  });\n\n  document.addEventListener('mouseup', () => {\n    if (mouseDown) {\n      mouseDown = false;\n      clearDpad();\n    }\n  });\n}\n\n/**\n * Â•óÁî® D-Pad ÁãÄÊÖã‰∏¶Êõ¥Êñ∞Ë¶ñË¶∫\n */\nfunction applyDpadState(controller: Controller, newState: DpadState): void {\n  // Êõ¥Êñ∞ÊéßÂà∂Âô®\n  if (newState.up !== currentDpadState.up) {\n    controller.setButton(ControllerButton.Up, newState.up);\n  }\n  if (newState.down !== currentDpadState.down) {\n    controller.setButton(ControllerButton.Down, newState.down);\n  }\n  if (newState.left !== currentDpadState.left) {\n    controller.setButton(ControllerButton.Left, newState.left);\n  }\n  if (newState.right !== currentDpadState.right) {\n    controller.setButton(ControllerButton.Right, newState.right);\n  }\n  \n  // Êõ¥Êñ∞Ë¶ñË¶∫\n  document.getElementById('dpad-up')?.classList.toggle('pressed', newState.up);\n  document.getElementById('dpad-down')?.classList.toggle('pressed', newState.down);\n  document.getElementById('dpad-left')?.classList.toggle('pressed', newState.left);\n  document.getElementById('dpad-right')?.classList.toggle('pressed', newState.right);\n  \n  currentDpadState = { ...newState };\n}\n\n/**\n * Ë®≠ÂÆö A/B ÊåâÈàï (ÊîØÊè¥Â§öÈªûËß∏ÊéßÂêåÊôÇÊåâ)\n */\nfunction setupABButtons(controller: Controller): void {\n  const btnA = document.getElementById('btn-a');\n  const btnB = document.getElementById('btn-b');\n  \n  const setupButton = (btn: HTMLElement | null, buttonType: ControllerButton, elementId: string) => {\n    if (!btn) return;\n    \n    btn.addEventListener('touchstart', (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n      for (const touch of Array.from(e.changedTouches)) {\n        activeTouches.set(touch.identifier, { identifier: touch.identifier, element: elementId });\n      }\n      controller.setButton(buttonType, true);\n      btn.classList.add('pressed');\n    }, { passive: false });\n\n    btn.addEventListener('touchend', (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n      for (const touch of Array.from(e.changedTouches)) {\n        activeTouches.delete(touch.identifier);\n      }\n      controller.setButton(buttonType, false);\n      btn.classList.remove('pressed');\n    }, { passive: false });\n\n    btn.addEventListener('touchcancel', (e) => {\n      e.preventDefault();\n      for (const touch of Array.from(e.changedTouches)) {\n        activeTouches.delete(touch.identifier);\n      }\n      controller.setButton(buttonType, false);\n      btn.classList.remove('pressed');\n    }, { passive: false });\n\n    // ÊªëÈº†‰∫ã‰ª∂\n    btn.addEventListener('mousedown', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonType, true);\n      btn.classList.add('pressed');\n    });\n\n    btn.addEventListener('mouseup', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonType, false);\n      btn.classList.remove('pressed');\n    });\n\n    btn.addEventListener('mouseleave', () => {\n      controller.setButton(buttonType, false);\n      btn.classList.remove('pressed');\n    });\n  };\n\n  setupButton(btnA, ControllerButton.A, 'a');\n  setupButton(btnB, ControllerButton.B, 'b');\n}\n\n/**\n * Ë®≠ÂÆöÂäüËÉΩÊåâÈàï (Select/Start)\n */\nfunction setupFunctionButtons(controller: Controller): void {\n  const buttons = document.querySelectorAll('[data-btn=\"select\"], [data-btn=\"start\"]');\n  \n  buttons.forEach(btn => {\n    const button = btn as HTMLElement;\n    const btnType = button.dataset.btn;\n    const buttonEnum = btnType === 'start' ? ControllerButton.Start : ControllerButton.Select;\n\n    button.addEventListener('touchstart', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonEnum, true);\n      button.classList.add('pressed');\n    }, { passive: false });\n\n    button.addEventListener('touchend', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonEnum, false);\n      button.classList.remove('pressed');\n    }, { passive: false });\n\n    button.addEventListener('touchcancel', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonEnum, false);\n      button.classList.remove('pressed');\n    }, { passive: false });\n\n    button.addEventListener('mousedown', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonEnum, true);\n      button.classList.add('pressed');\n    });\n\n    button.addEventListener('mouseup', (e) => {\n      e.preventDefault();\n      controller.setButton(buttonEnum, false);\n      button.classList.remove('pressed');\n    });\n\n    button.addEventListener('mouseleave', () => {\n      controller.setButton(buttonEnum, false);\n      button.classList.remove('pressed');\n    });\n  });\n}\n\n/**\n * ËôïÁêÜÊåâÈàïÊåâ‰∏ã/ÈáãÊîæ (‰øùÁïôÁµ¶ÂÖ∂‰ªñÁî®ÈÄî)\n */\nfunction handleButtonPress(controller: Controller, btnType: string, pressed: boolean): void {\n  const buttonMap: Record<string, ControllerButton> = {\n    'up': ControllerButton.Up,\n    'down': ControllerButton.Down,\n    'left': ControllerButton.Left,\n    'right': ControllerButton.Right,\n    'a': ControllerButton.A,\n    'b': ControllerButton.B,\n    'start': ControllerButton.Start,\n    'select': ControllerButton.Select,\n  };\n  \n  const button = buttonMap[btnType];\n  if (button !== undefined) {\n    controller.setButton(button, pressed);\n  }\n}\n\n// ===== ÈõªËÖ¶ÁâàÊéßÂà∂ =====\n\n/**\n * Ë®≠ÂÆöÈõªËÖ¶ÁâàÊéßÂà∂ÊåâÈàï\n */\nfunction setupDesktopControls(): void {\n  document.getElementById('btn-pause')?.addEventListener('click', stopEmulation);\n  document.getElementById('btn-resume')?.addEventListener('click', startEmulation);\n  document.getElementById('btn-reset')?.addEventListener('click', () => nes?.reset());\n  document.getElementById('btn-select-game')?.addEventListener('click', showRomSelector);\n  \n  // Â≠òÊ™î/ËÆÄÂèñÊåâÈàï (ÈõªËÖ¶Áâà)\n  document.getElementById('btn-save-state')?.addEventListener('click', () => {\n    if (saveState(0)) {\n      showToast('‚úÖ Â≠òÊ™îÊàêÂäü');\n    } else {\n      showToast('‚ùå Â≠òÊ™îÂ§±Êïó');\n    }\n  });\n  document.getElementById('btn-load-state')?.addEventListener('click', () => {\n    if (loadState(0)) {\n      showToast('‚úÖ ËÆÄÂèñÊàêÂäü');\n    } else {\n      showToast('‚ùå Ê≤íÊúâÂ≠òÊ™î');\n    }\n  });\n  \n  // Â≠òÊ™î/ËÆÄÂèñÊåâÈàï (ÊâãÊ©üÁâà)\n  document.getElementById('mobile-save-state')?.addEventListener('click', () => {\n    if (saveState(0)) {\n      showToast('‚úÖ Â≠òÊ™îÊàêÂäü');\n    } else {\n      showToast('‚ùå Â≠òÊ™îÂ§±Êïó');\n    }\n  });\n  document.getElementById('mobile-load-state')?.addEventListener('click', () => {\n    if (loadState(0)) {\n      showToast('‚úÖ ËÆÄÂèñÊàêÂäü');\n    } else {\n      showToast('‚ùå Ê≤íÊúâÂ≠òÊ™î');\n    }\n  });\n}\n\n/**\n * Ë®≠ÂÆöÊ™îÊ°àÈÅ∏ÊìáÂô® (ÈõªËÖ¶Áâà)\n */\nfunction setupFileInput(): void {\n  const fileInput = document.getElementById('rom-input') as HTMLInputElement;\n  \n  fileInput?.addEventListener('change', async (event) => {\n    const input = event.target as HTMLInputElement;\n    const file = input.files?.[0];\n    \n    if (file) {\n      await loadRomFromFile(file);\n    }\n  });\n}\n\n// ===== Ê®°Êì¨Âô®ÊéßÂà∂ =====\n\n/**\n * ÈñãÂßãÊ®°Êì¨\n */\nfunction startEmulation(): void {\n  if (animationId !== null) {\n    cancelAnimationFrame(animationId);\n  }\n\n  isRunning = true;\n\n  // NES NTSC ÂπÄÁéáÔºö60.0988 fps\n  const TARGET_FRAME_TIME = 1000 / 60.0988;\n  let lastFrameTime = performance.now();\n  let accumulator = 0;\n\n  const frameLoop = (currentTime: number): void => {\n    if (!nes || !ctx || !imageData || !isRunning) return;\n\n    const deltaTime = currentTime - lastFrameTime;\n    lastFrameTime = currentTime;\n    \n    accumulator += deltaTime;\n    \n    if (accumulator > TARGET_FRAME_TIME * 3) {\n      accumulator = TARGET_FRAME_TIME;\n    }\n\n    while (accumulator >= TARGET_FRAME_TIME) {\n      nes.frame();\n      accumulator -= TARGET_FRAME_TIME;\n    }\n\n    renderFrame();\n    animationId = requestAnimationFrame(frameLoop);\n  };\n\n  animationId = requestAnimationFrame(frameLoop);\n}\n\n/**\n * ÂÅúÊ≠¢Ê®°Êì¨\n */\nfunction stopEmulation(): void {\n  isRunning = false;\n  if (animationId !== null) {\n    cancelAnimationFrame(animationId);\n    animationId = null;\n  }\n}\n\n/**\n * Ê∏≤Êüì‰∏ÄÂπÄÂà∞Áï´Â∏É\n */\nfunction renderFrame(): void {\n  if (!nes || !ctx || !imageData) return;\n\n  const frameBuffer = nes.getFrameBuffer();\n  const data = imageData.data;\n\n  for (let i = 0; i < 256 * 240; i++) {\n    const pixel = frameBuffer[i];\n    const offset = i * 4;\n    data[offset + 0] = (pixel >> 16) & 0xFF;\n    data[offset + 1] = (pixel >> 8) & 0xFF;\n    data[offset + 2] = pixel & 0xFF;\n    data[offset + 3] = 255;\n  }\n\n  ctx.putImageData(imageData, 0, 0);\n}\n\n// ===== Èü≥È†ªÁ≥ªÁµ± =====\n\n/**\n * ÂàùÂßãÂåñÈü≥È†ªÁ≥ªÁµ±\n */\nasync function initAudio(): Promise<void> {\n  try {\n    audioContext = new AudioContext({ sampleRate: 44100 });\n    \n    if (nes) {\n      nes.setAudioSampleRate(audioContext.sampleRate);\n    }\n    \n    const scriptProcessor = audioContext.createScriptProcessor(AUDIO_BUFFER_SIZE, 0, 1);\n    \n    scriptProcessor.onaudioprocess = (e) => {\n      const output = e.outputBuffer.getChannelData(0);\n      if (nes && isRunning) {\n        const samplesRead = nes.readAudioSamples(output);\n        if (samplesRead === 0) {\n          output.fill(0);\n        }\n      } else {\n        output.fill(0);\n      }\n    };\n    \n    scriptProcessor.connect(audioContext.destination);\n    console.log('Èü≥È†ªÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñÔºåÂèñÊ®£Áéá:', audioContext.sampleRate);\n  } catch (e) {\n    console.error('Èü≥È†ªÂàùÂßãÂåñÂ§±Êïó:', e);\n  }\n}\n\n/**\n * ÊÅ¢Âæ©Èü≥È†ª\n */\nfunction resumeAudio(): void {\n  if (audioContext && audioContext.state === 'suspended') {\n    audioContext.resume();\n  }\n}\n\n// ===== Â≠òÊ™îÁ≥ªÁµ± =====\n\nconst SAVE_STATE_PREFIX = 'nes_savestate_';\n\n/**\n * È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ\n */\nfunction showToast(message: string): void {\n  // ÁßªÈô§ËàäÁöÑ toast\n  const existingToast = document.querySelector('.toast-message');\n  if (existingToast) {\n    existingToast.remove();\n  }\n  \n  // Âª∫Á´ãÊñ∞ÁöÑ toast\n  const toast = document.createElement('div');\n  toast.className = 'toast-message';\n  toast.textContent = message;\n  toast.style.cssText = `\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: rgba(0, 0, 0, 0.8);\n    color: white;\n    padding: 15px 30px;\n    border-radius: 10px;\n    font-size: 16px;\n    font-weight: bold;\n    z-index: 10000;\n    animation: toastFade 1.5s ease-out forwards;\n  `;\n  \n  // Ê∑ªÂä†ÂãïÁï´Ê®£Âºè\n  if (!document.querySelector('#toast-style')) {\n    const style = document.createElement('style');\n    style.id = 'toast-style';\n    style.textContent = `\n      @keyframes toastFade {\n        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n        70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n  \n  document.body.appendChild(toast);\n  \n  // Ëá™ÂãïÁßªÈô§\n  setTimeout(() => toast.remove(), 1500);\n}\n\nfunction saveState(slot: number = 0): boolean {\n  if (!nes) return false;\n  \n  try {\n    const saveData = nes.exportSaveState();\n    const key = `${SAVE_STATE_PREFIX}${slot}`;\n    localStorage.setItem(key, saveData);\n    console.log(`Â≠òÊ™îÊàêÂäü (Slot ${slot})`);\n    return true;\n  } catch (e) {\n    console.error('Â≠òÊ™îÂ§±Êïó:', e);\n    return false;\n  }\n}\n\nfunction loadState(slot: number = 0): boolean {\n  if (!nes) return false;\n  \n  try {\n    const key = `${SAVE_STATE_PREFIX}${slot}`;\n    const saveData = localStorage.getItem(key);\n    \n    if (!saveData) {\n      console.log(`Slot ${slot} Ê≤íÊúâÂ≠òÊ™î`);\n      return false;\n    }\n    \n    const success = nes.importSaveState(saveData);\n    if (success) {\n      console.log(`ËÆÄÂèñÂ≠òÊ™îÊàêÂäü (Slot ${slot})`);\n    }\n    return success;\n  } catch (e) {\n    console.error('ËÆÄÂèñÂ≠òÊ™îÂ§±Êïó:', e);\n    return false;\n  }\n}\n\nfunction exportSaveToFile(): void {\n  if (!nes) return;\n  \n  const saveData = nes.exportSaveState();\n  const blob = new Blob([saveData], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `nes_savestate_${Date.now()}.json`;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n}\n\n// ===== ÈçµÁõ§Âø´Êç∑Èçµ =====\n\nfunction setupKeyboardShortcuts(): void {\n  document.addEventListener('keydown', (e) => {\n    if (e.key === 'F5') {\n      e.preventDefault();\n      saveState(0);\n    }\n    if (e.key === 'F7') {\n      e.preventDefault();\n      loadState(0);\n    }\n    if (e.key >= 'F1' && e.key <= 'F4' && e.shiftKey) {\n      e.preventDefault();\n      const slot = parseInt(e.key[1]);\n      saveState(slot);\n    }\n    if (e.key >= '1' && e.key <= '4' && e.ctrlKey) {\n      e.preventDefault();\n      const slot = parseInt(e.key);\n      loadState(slot);\n    }\n    // ESC ÈçµËøîÂõûÈÅ∏ÊìáÁï´Èù¢\n    if (e.key === 'Escape') {\n      showRomSelector();\n    }\n  });\n}\n\n// ===== ÂÖ®ÂüüÂåØÂá∫ =====\n\ndeclare global {\n  interface Window {\n    nes: Nes | null;\n    startEmulation: () => void;\n    stopEmulation: () => void;\n    saveState: (slot?: number) => boolean;\n    loadState: (slot?: number) => boolean;\n    exportSaveToFile: () => void;\n    showRomSelector: () => void;\n  }\n}\n\nwindow.nes = null;\nwindow.startEmulation = startEmulation;\nwindow.stopEmulation = stopEmulation;\nwindow.saveState = saveState;\nwindow.loadState = loadState;\nwindow.exportSaveToFile = exportSaveToFile;\nwindow.showRomSelector = showRomSelector;\n\n// ===== ÂïüÂãï =====\n\ndocument.addEventListener('DOMContentLoaded', async () => {\n  init();\n  await initAudio();\n  setupKeyboardShortcuts();\n  window.nes = nes;\n  \n  // Áî®Êà∂‰∫§‰∫íÂæåÊÅ¢Âæ©Èü≥È†ª\n  document.addEventListener('click', resumeAudio, { once: true });\n  document.addEventListener('keydown', resumeAudio, { once: true });\n  document.addEventListener('touchstart', resumeAudio, { once: true });\n});\n"],"names":["nes","animationId","canvas","ctx","imageData","audioContext","isRunning","romSelector","gameboyShell","powerLed","AUDIO_BUFFER_SIZE","init","Nes","KeyboardInputHandler","DEFAULT_KEYBOARD_MAP_P1","setupVirtualController","setupDesktopControls","setupRomSelector","setupFileInput","loadRomList","e","file","loadRomFromFile","romListEl","response","data","renderRomList","error","roms","rom","index","item","loadRomFromServer","filename","buffer","startGame","romData","hideRomSelector","resumeAudio","startEmulation","showRomSelector","stopEmulation","activeTouches","currentDpadState","controller","setupDpad","setupABButtons","setupFunctionButtons","dpadArea","dpad","updateDpadFromTouch","touch","rect","centerX","centerY","dx","dy","distance","deadZone","newState","angle","applyDpadState","clearDpad","t","mouseDown","maxRadius","ControllerButton","btnA","btnB","setupButton","btn","buttonType","elementId","button","buttonEnum","saveState","showToast","loadState","event","TARGET_FRAME_TIME","lastFrameTime","accumulator","frameLoop","currentTime","deltaTime","renderFrame","frameBuffer","i","pixel","offset","initAudio","scriptProcessor","output","SAVE_STATE_PREFIX","message","existingToast","toast","style","slot","saveData","key","success","exportSaveToFile","blob","url","a","setupKeyboardShortcuts"],"mappings":"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"}