class M{a=0;x=0;y=0;sp=253;pc=0;status=36;cycles=0;absoluteAddress=0;relativeAddress=0;opcode=0;fetchedData=0;bus;instructions;totalCycles=0;constructor(t){this.bus=t,this.instructions=this.buildInstructionTable()}getFlag(t){return(this.status&t)!==0}setFlag(t,e){e?this.status|=t:this.status&=~t}read(t){return this.bus.cpuRead(t&65535)}write(t,e){this.bus.cpuWrite(t&65535,e&255)}pushStack(t){this.write(256+this.sp,t),this.sp=this.sp-1&255}popStack(){return this.sp=this.sp+1&255,this.read(256+this.sp)}pushStack16(t){this.pushStack(t>>8&255),this.pushStack(t&255)}popStack16(){const t=this.popStack();return this.popStack()<<8|t}reset(){const t=this.read(65532),e=this.read(65533);this.pc=e<<8|t,this.a=0,this.x=0,this.y=0,this.sp=253,this.status=36,this.cycles=8,this.totalCycles=0}irq(){if(!this.getFlag(4)){this.pushStack16(this.pc),this.setFlag(16,!1),this.setFlag(32,!0),this.pushStack(this.status),this.setFlag(4,!0);const t=this.read(65534),e=this.read(65535);this.pc=e<<8|t,this.cycles=7}}nmi(){this.pushStack16(this.pc),this.setFlag(16,!1),this.setFlag(32,!0),this.pushStack(this.status),this.setFlag(4,!0);const t=this.read(65530),e=this.read(65531);this.pc=e<<8|t,this.cycles=8}clock(){if(this.cycles===0){this.opcode=this.read(this.pc),this.pc=this.pc+1&65535,this.setFlag(32,!0);const t=this.instructions[this.opcode];return this.cycles=t.cycles,this.executeAddressingMode(t.mode),t.execute.call(this),this.setFlag(32,!0),this.totalCycles+=this.cycles,!0}return this.cycles--,!1}step(){const t=this.totalCycles;do this.clock();while(this.cycles>0);return this.totalCycles-t}executeAddressingMode(t){switch(t){case 0:return this.addrImplicit();case 1:return this.addrAccumulator();case 2:return this.addrImmediate();case 3:return this.addrZeroPage();case 4:return this.addrZeroPageX();case 5:return this.addrZeroPageY();case 6:return this.addrRelative();case 7:return this.addrAbsolute();case 8:return this.addrAbsoluteX();case 9:return this.addrAbsoluteY();case 10:return this.addrIndirect();case 11:return this.addrIndexedIndirectX();case 12:return this.addrIndirectIndexedY();default:return 0}}addrImplicit(){return this.fetchedData=this.a,0}addrAccumulator(){return this.fetchedData=this.a,0}addrImmediate(){return this.absoluteAddress=this.pc,this.pc=this.pc+1&65535,0}addrZeroPage(){return this.absoluteAddress=this.read(this.pc),this.pc=this.pc+1&65535,this.absoluteAddress&=255,0}addrZeroPageX(){return this.absoluteAddress=this.read(this.pc)+this.x&255,this.pc=this.pc+1&65535,0}addrZeroPageY(){return this.absoluteAddress=this.read(this.pc)+this.y&255,this.pc=this.pc+1&65535,0}addrRelative(){return this.relativeAddress=this.read(this.pc),this.pc=this.pc+1&65535,this.relativeAddress&128&&(this.relativeAddress|=65280),0}addrAbsolute(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(this.pc);return this.pc=this.pc+1&65535,this.absoluteAddress=e<<8|t,0}addrAbsoluteX(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(this.pc);return this.pc=this.pc+1&65535,this.absoluteAddress=(e<<8|t)+this.x,this.absoluteAddress&=65535,(this.absoluteAddress&65280)!==e<<8?1:0}addrAbsoluteY(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(this.pc);return this.pc=this.pc+1&65535,this.absoluteAddress=(e<<8|t)+this.y,this.absoluteAddress&=65535,(this.absoluteAddress&65280)!==e<<8?1:0}addrIndirect(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(this.pc);this.pc=this.pc+1&65535;const i=e<<8|t;return t===255?this.absoluteAddress=this.read(i&65280)<<8|this.read(i):this.absoluteAddress=this.read(i+1)<<8|this.read(i),0}addrIndexedIndirectX(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(t+this.x&255),i=this.read(t+this.x+1&255);return this.absoluteAddress=i<<8|e,0}addrIndirectIndexedY(){const t=this.read(this.pc);this.pc=this.pc+1&65535;const e=this.read(t),i=this.read(t+1&255);return this.absoluteAddress=(i<<8|e)+this.y,this.absoluteAddress&=65535,(this.absoluteAddress&65280)!==i<<8?1:0}fetch(){const t=this.instructions[this.opcode];return t.mode!==0&&t.mode!==1&&(this.fetchedData=this.read(this.absoluteAddress)),this.fetchedData}branch(){this.cycles++,this.absoluteAddress=this.pc+this.relativeAddress&65535,(this.absoluteAddress&65280)!==(this.pc&65280)&&this.cycles++,this.pc=this.absoluteAddress}LDA(){this.a=this.fetch(),this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}LDX(){this.x=this.fetch(),this.setFlag(2,this.x===0),this.setFlag(128,(this.x&128)!==0)}LDY(){this.y=this.fetch(),this.setFlag(2,this.y===0),this.setFlag(128,(this.y&128)!==0)}STA(){this.write(this.absoluteAddress,this.a)}STX(){this.write(this.absoluteAddress,this.x)}STY(){this.write(this.absoluteAddress,this.y)}TAX(){this.x=this.a,this.setFlag(2,this.x===0),this.setFlag(128,(this.x&128)!==0)}TAY(){this.y=this.a,this.setFlag(2,this.y===0),this.setFlag(128,(this.y&128)!==0)}TXA(){this.a=this.x,this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}TYA(){this.a=this.y,this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}TSX(){this.x=this.sp,this.setFlag(2,this.x===0),this.setFlag(128,(this.x&128)!==0)}TXS(){this.sp=this.x}PHA(){this.pushStack(this.a)}PHP(){this.pushStack(this.status|16|32)}PLA(){this.a=this.popStack(),this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}PLP(){this.status=this.popStack(),this.setFlag(32,!0),this.setFlag(16,!1)}ADC(){const t=this.fetch(),e=this.a+t+(this.getFlag(1)?1:0);this.setFlag(1,e>255),this.setFlag(2,(e&255)===0),this.setFlag(64,(~(this.a^t)&(this.a^e)&128)!==0),this.setFlag(128,(e&128)!==0),this.a=e&255}SBC(){const t=this.fetch()^255,e=this.a+t+(this.getFlag(1)?1:0);this.setFlag(1,e>255),this.setFlag(2,(e&255)===0),this.setFlag(64,(~(this.a^t)&(this.a^e)&128)!==0),this.setFlag(128,(e&128)!==0),this.a=e&255}CMP(){const t=this.fetch(),e=this.a-t;this.setFlag(1,this.a>=t),this.setFlag(2,(e&255)===0),this.setFlag(128,(e&128)!==0)}CPX(){const t=this.fetch(),e=this.x-t;this.setFlag(1,this.x>=t),this.setFlag(2,(e&255)===0),this.setFlag(128,(e&128)!==0)}CPY(){const t=this.fetch(),e=this.y-t;this.setFlag(1,this.y>=t),this.setFlag(2,(e&255)===0),this.setFlag(128,(e&128)!==0)}INC(){const t=this.fetch()+1&255;this.write(this.absoluteAddress,t),this.setFlag(2,t===0),this.setFlag(128,(t&128)!==0)}INX(){this.x=this.x+1&255,this.setFlag(2,this.x===0),this.setFlag(128,(this.x&128)!==0)}INY(){this.y=this.y+1&255,this.setFlag(2,this.y===0),this.setFlag(128,(this.y&128)!==0)}DEC(){const t=this.fetch()-1&255;this.write(this.absoluteAddress,t),this.setFlag(2,t===0),this.setFlag(128,(t&128)!==0)}DEX(){this.x=this.x-1&255,this.setFlag(2,this.x===0),this.setFlag(128,(this.x&128)!==0)}DEY(){this.y=this.y-1&255,this.setFlag(2,this.y===0),this.setFlag(128,(this.y&128)!==0)}AND(){this.a&=this.fetch(),this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}ORA(){this.a|=this.fetch(),this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}EOR(){this.a^=this.fetch(),this.setFlag(2,this.a===0),this.setFlag(128,(this.a&128)!==0)}BIT(){const t=this.fetch();this.setFlag(2,(this.a&t)===0),this.setFlag(128,(t&128)!==0),this.setFlag(64,(t&64)!==0)}ASL(){const t=this.fetch(),e=t<<1&255;this.setFlag(1,(t&128)!==0),this.setFlag(2,e===0),this.setFlag(128,(e&128)!==0),this.instructions[this.opcode].mode===1?this.a=e:this.write(this.absoluteAddress,e)}LSR(){const t=this.fetch(),e=t>>1;this.setFlag(1,(t&1)!==0),this.setFlag(2,e===0),this.setFlag(128,!1),this.instructions[this.opcode].mode===1?this.a=e:this.write(this.absoluteAddress,e)}ROL(){const t=this.fetch(),e=(t<<1|(this.getFlag(1)?1:0))&255;this.setFlag(1,(t&128)!==0),this.setFlag(2,e===0),this.setFlag(128,(e&128)!==0),this.instructions[this.opcode].mode===1?this.a=e:this.write(this.absoluteAddress,e)}ROR(){const t=this.fetch(),e=t>>1|(this.getFlag(1)?128:0);this.setFlag(1,(t&1)!==0),this.setFlag(2,e===0),this.setFlag(128,(e&128)!==0),this.instructions[this.opcode].mode===1?this.a=e:this.write(this.absoluteAddress,e)}JMP(){this.pc=this.absoluteAddress}JSR(){this.pushStack16(this.pc-1&65535),this.pc=this.absoluteAddress}RTS(){this.pc=this.popStack16()+1&65535}BCC(){this.getFlag(1)||this.branch()}BCS(){this.getFlag(1)&&this.branch()}BEQ(){this.getFlag(2)&&this.branch()}BMI(){this.getFlag(128)&&this.branch()}BNE(){this.getFlag(2)||this.branch()}BPL(){this.getFlag(128)||this.branch()}BVC(){this.getFlag(64)||this.branch()}BVS(){this.getFlag(64)&&this.branch()}CLC(){this.setFlag(1,!1)}CLD(){this.setFlag(8,!1)}CLI(){this.setFlag(4,!1)}CLV(){this.setFlag(64,!1)}SEC(){this.setFlag(1,!0)}SED(){this.setFlag(8,!0)}SEI(){this.setFlag(4,!0)}BRK(){this.pc=this.pc+1&65535,this.pushStack16(this.pc),this.setFlag(16,!0),this.pushStack(this.status|16|32),this.setFlag(4,!0);const t=this.read(65534),e=this.read(65535);this.pc=e<<8|t}NOP(){}RTI(){this.status=this.popStack(),this.setFlag(16,!1),this.setFlag(32,!0),this.pc=this.popStack16()}XXX(){}buildInstructionTable(){const t=new Array(256);for(let i=0;i<256;i++)t[i]={name:"XXX",execute:this.XXX,mode:0,cycles:2};const e=[[169,"LDA",this.LDA,2,2],[165,"LDA",this.LDA,3,3],[181,"LDA",this.LDA,4,4],[173,"LDA",this.LDA,7,4],[189,"LDA",this.LDA,8,4],[185,"LDA",this.LDA,9,4],[161,"LDA",this.LDA,11,6],[177,"LDA",this.LDA,12,5],[162,"LDX",this.LDX,2,2],[166,"LDX",this.LDX,3,3],[182,"LDX",this.LDX,5,4],[174,"LDX",this.LDX,7,4],[190,"LDX",this.LDX,9,4],[160,"LDY",this.LDY,2,2],[164,"LDY",this.LDY,3,3],[180,"LDY",this.LDY,4,4],[172,"LDY",this.LDY,7,4],[188,"LDY",this.LDY,8,4],[133,"STA",this.STA,3,3],[149,"STA",this.STA,4,4],[141,"STA",this.STA,7,4],[157,"STA",this.STA,8,5],[153,"STA",this.STA,9,5],[129,"STA",this.STA,11,6],[145,"STA",this.STA,12,6],[134,"STX",this.STX,3,3],[150,"STX",this.STX,5,4],[142,"STX",this.STX,7,4],[132,"STY",this.STY,3,3],[148,"STY",this.STY,4,4],[140,"STY",this.STY,7,4],[170,"TAX",this.TAX,0,2],[168,"TAY",this.TAY,0,2],[138,"TXA",this.TXA,0,2],[152,"TYA",this.TYA,0,2],[186,"TSX",this.TSX,0,2],[154,"TXS",this.TXS,0,2],[72,"PHA",this.PHA,0,3],[8,"PHP",this.PHP,0,3],[104,"PLA",this.PLA,0,4],[40,"PLP",this.PLP,0,4],[105,"ADC",this.ADC,2,2],[101,"ADC",this.ADC,3,3],[117,"ADC",this.ADC,4,4],[109,"ADC",this.ADC,7,4],[125,"ADC",this.ADC,8,4],[121,"ADC",this.ADC,9,4],[97,"ADC",this.ADC,11,6],[113,"ADC",this.ADC,12,5],[233,"SBC",this.SBC,2,2],[229,"SBC",this.SBC,3,3],[245,"SBC",this.SBC,4,4],[237,"SBC",this.SBC,7,4],[253,"SBC",this.SBC,8,4],[249,"SBC",this.SBC,9,4],[225,"SBC",this.SBC,11,6],[241,"SBC",this.SBC,12,5],[201,"CMP",this.CMP,2,2],[197,"CMP",this.CMP,3,3],[213,"CMP",this.CMP,4,4],[205,"CMP",this.CMP,7,4],[221,"CMP",this.CMP,8,4],[217,"CMP",this.CMP,9,4],[193,"CMP",this.CMP,11,6],[209,"CMP",this.CMP,12,5],[224,"CPX",this.CPX,2,2],[228,"CPX",this.CPX,3,3],[236,"CPX",this.CPX,7,4],[192,"CPY",this.CPY,2,2],[196,"CPY",this.CPY,3,3],[204,"CPY",this.CPY,7,4],[230,"INC",this.INC,3,5],[246,"INC",this.INC,4,6],[238,"INC",this.INC,7,6],[254,"INC",this.INC,8,7],[232,"INX",this.INX,0,2],[200,"INY",this.INY,0,2],[198,"DEC",this.DEC,3,5],[214,"DEC",this.DEC,4,6],[206,"DEC",this.DEC,7,6],[222,"DEC",this.DEC,8,7],[202,"DEX",this.DEX,0,2],[136,"DEY",this.DEY,0,2],[41,"AND",this.AND,2,2],[37,"AND",this.AND,3,3],[53,"AND",this.AND,4,4],[45,"AND",this.AND,7,4],[61,"AND",this.AND,8,4],[57,"AND",this.AND,9,4],[33,"AND",this.AND,11,6],[49,"AND",this.AND,12,5],[9,"ORA",this.ORA,2,2],[5,"ORA",this.ORA,3,3],[21,"ORA",this.ORA,4,4],[13,"ORA",this.ORA,7,4],[29,"ORA",this.ORA,8,4],[25,"ORA",this.ORA,9,4],[1,"ORA",this.ORA,11,6],[17,"ORA",this.ORA,12,5],[73,"EOR",this.EOR,2,2],[69,"EOR",this.EOR,3,3],[85,"EOR",this.EOR,4,4],[77,"EOR",this.EOR,7,4],[93,"EOR",this.EOR,8,4],[89,"EOR",this.EOR,9,4],[65,"EOR",this.EOR,11,6],[81,"EOR",this.EOR,12,5],[36,"BIT",this.BIT,3,3],[44,"BIT",this.BIT,7,4],[10,"ASL",this.ASL,1,2],[6,"ASL",this.ASL,3,5],[22,"ASL",this.ASL,4,6],[14,"ASL",this.ASL,7,6],[30,"ASL",this.ASL,8,7],[74,"LSR",this.LSR,1,2],[70,"LSR",this.LSR,3,5],[86,"LSR",this.LSR,4,6],[78,"LSR",this.LSR,7,6],[94,"LSR",this.LSR,8,7],[42,"ROL",this.ROL,1,2],[38,"ROL",this.ROL,3,5],[54,"ROL",this.ROL,4,6],[46,"ROL",this.ROL,7,6],[62,"ROL",this.ROL,8,7],[106,"ROR",this.ROR,1,2],[102,"ROR",this.ROR,3,5],[118,"ROR",this.ROR,4,6],[110,"ROR",this.ROR,7,6],[126,"ROR",this.ROR,8,7],[76,"JMP",this.JMP,7,3],[108,"JMP",this.JMP,10,5],[32,"JSR",this.JSR,7,6],[96,"RTS",this.RTS,0,6],[144,"BCC",this.BCC,6,2],[176,"BCS",this.BCS,6,2],[240,"BEQ",this.BEQ,6,2],[48,"BMI",this.BMI,6,2],[208,"BNE",this.BNE,6,2],[16,"BPL",this.BPL,6,2],[80,"BVC",this.BVC,6,2],[112,"BVS",this.BVS,6,2],[24,"CLC",this.CLC,0,2],[216,"CLD",this.CLD,0,2],[88,"CLI",this.CLI,0,2],[184,"CLV",this.CLV,0,2],[56,"SEC",this.SEC,0,2],[248,"SED",this.SED,0,2],[120,"SEI",this.SEI,0,2],[0,"BRK",this.BRK,0,7],[234,"NOP",this.NOP,0,2],[64,"RTI",this.RTI,0,6]];for(const[i,r,h,c,l]of e)t[i]={name:r,execute:h,mode:c,cycles:l};return t}getState(){const t=[this.getFlag(128)?"N":"-",this.getFlag(64)?"V":"-","-",this.getFlag(16)?"B":"-",this.getFlag(8)?"D":"-",this.getFlag(4)?"I":"-",this.getFlag(2)?"Z":"-",this.getFlag(1)?"C":"-"].join("");return`PC:${this.pc.toString(16).padStart(4,"0").toUpperCase()} A:${this.a.toString(16).padStart(2,"0").toUpperCase()} X:${this.x.toString(16).padStart(2,"0").toUpperCase()} Y:${this.y.toString(16).padStart(2,"0").toUpperCase()} SP:${this.sp.toString(16).padStart(2,"0").toUpperCase()} [${t}]`}disassemble(t){const e=this.read(t),i=this.instructions[e];let r=1,h="";switch(i.mode){case 2:h=`#$${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()}`,r=2;break;case 3:h=`$${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()}`,r=2;break;case 4:h=`$${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()},X`,r=2;break;case 5:h=`$${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()},Y`,r=2;break;case 7:h=`$${(this.read(t+1)|this.read(t+2)<<8).toString(16).padStart(4,"0").toUpperCase()}`,r=3;break;case 8:h=`$${(this.read(t+1)|this.read(t+2)<<8).toString(16).padStart(4,"0").toUpperCase()},X`,r=3;break;case 9:h=`$${(this.read(t+1)|this.read(t+2)<<8).toString(16).padStart(4,"0").toUpperCase()},Y`,r=3;break;case 10:h=`($${(this.read(t+1)|this.read(t+2)<<8).toString(16).padStart(4,"0").toUpperCase()})`,r=3;break;case 11:h=`($${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()},X)`,r=2;break;case 12:h=`($${this.read(t+1).toString(16).padStart(2,"0").toUpperCase()}),Y`,r=2;break;case 6:let u=this.read(t+1);u&128&&(u=u-256),h=`$${(t+2+u).toString(16).padStart(4,"0").toUpperCase()}`,r=2;break;case 1:h="A";break}return{instruction:`${i.name} ${h}`.trim(),bytes:r}}saveState(){return{a:this.a,x:this.x,y:this.y,sp:this.sp,pc:this.pc,status:this.status,cycles:this.cycles,absoluteAddress:this.absoluteAddress,relativeAddress:this.relativeAddress,opcode:this.opcode,fetchedData:this.fetchedData,totalCycles:this.totalCycles}}loadState(t){this.a=t.a,this.x=t.x,this.y=t.y,this.sp=t.sp,this.pc=t.pc,this.status=t.status,this.cycles=t.cycles,this.absoluteAddress=t.absoluteAddress,this.relativeAddress=t.relativeAddress,this.opcode=t.opcode,this.fetchedData=t.fetchedData,this.totalCycles=t.totalCycles}}const C=[6710886,10888,1315495,3866788,6029438,7209024,7079424,5643520,3355904,739328,20992,20232,16461,0,0,0,11382189,1400793,4342015,7677950,10492620,12000891,11874592,10046976,7040256,3704576,824064,36658,31885,0,0,0,16776959,6598911,9605375,13006591,15952639,16674508,16679280,15375906,12369408,8968192,6087728,4579458,4771294,5197647,0,0,16776959,12640255,13882111,15255807,16499455,16696554,16698565,16242853,15000980,13627286,12448939,11793356,11922418,12105912,0,0];class q{cartridge=null;ctrl=0;mask=0;status=0;oamAddress=0;vramAddr=0;tempAddr=0;fineX=0;addressLatch=!1;dataBuffer=0;nametableRam=new Uint8Array(2048);paletteRam=new Uint8Array(32);oam=new Uint8Array(256);secondaryOam=new Uint8Array(32);scanline=0;cycle=0;oddFrame=!1;nmiTriggered=!1;bgNextTileId=0;bgNextTileAttr=0;bgNextTileLo=0;bgNextTileHi=0;bgShifterPatternLo=0;bgShifterPatternHi=0;bgShifterAttrLo=0;bgShifterAttrHi=0;spriteCount=0;spriteShifterPatternLo=new Uint8Array(8);spriteShifterPatternHi=new Uint8Array(8);spriteZeroHitPossible=!1;spriteZeroRendering=!1;scanlineIrqFlag=!1;frameBuffer=new Uint32Array(256*240);frameComplete=!1;constructor(){this.reset()}reset(){this.ctrl=0,this.mask=0,this.status=0,this.oamAddress=0,this.vramAddr=0,this.tempAddr=0,this.fineX=0,this.addressLatch=!1,this.dataBuffer=0,this.scanline=0,this.cycle=0,this.oddFrame=!1,this.nmiTriggered=!1,this.frameComplete=!1,this.nametableRam.fill(0),this.paletteRam.fill(0),this.oam.fill(0),this.frameBuffer.fill(0)}connectCartridge(t){this.cartridge=t}cpuRead(t){let e=0;switch(t&8199){case 8192:break;case 8193:break;case 8194:e=this.status&224|this.dataBuffer&31,this.status&=-129,this.addressLatch=!1;break;case 8195:break;case 8196:e=this.oam[this.oamAddress];break;case 8197:break;case 8198:break;case 8199:e=this.dataBuffer,this.dataBuffer=this.ppuRead(this.vramAddr),this.vramAddr>=16128&&(e=this.dataBuffer),this.vramAddr+=this.ctrl&4?32:1,this.vramAddr&=16383;break}return e}cpuWrite(t,e){switch(t&8199){case 8192:this.ctrl=e,this.tempAddr=this.tempAddr&62463|(e&3)<<10;break;case 8193:this.mask=e;break;case 8194:break;case 8195:this.oamAddress=e;break;case 8196:this.oam[this.oamAddress]=e,this.oamAddress=this.oamAddress+1&255;break;case 8197:this.addressLatch?this.tempAddr=this.tempAddr&35871|(e&7)<<12|(e&248)<<2:(this.fineX=e&7,this.tempAddr=this.tempAddr&65504|e>>3),this.addressLatch=!this.addressLatch;break;case 8198:this.addressLatch?(this.tempAddr=this.tempAddr&65280|e,this.vramAddr=this.tempAddr):this.tempAddr=this.tempAddr&255|(e&63)<<8,this.addressLatch=!this.addressLatch;break;case 8199:this.ppuWrite(this.vramAddr,e),this.vramAddr+=this.ctrl&4?32:1,this.vramAddr&=16383;break}}oamWrite(t,e){this.oam[t]=e}ppuRead(t){if(t&=16383,t<8192)return this.cartridge?.ppuRead(t)??0;if(t<16128){t&=4095;const e=this.getMirroredNametableAddr(t);return this.nametableRam[e]}return t&=31,(t&19)===16&&(t&=15),this.paletteRam[t]}ppuWrite(t,e){if(t&=16383,t<8192){this.cartridge?.ppuWrite(t,e);return}if(t<16128){t&=4095;const i=this.getMirroredNametableAddr(t);this.nametableRam[i]=e;return}t&=31,(t&19)===16&&(t&=15),this.paletteRam[t]=e}getMirroredNametableAddr(t){switch(this.cartridge?.getMirrorMode()??0){case 0:return t<2048?t&1023:1024+(t&1023);case 1:return t&2047;case 2:return t&1023;case 3:return 1024+(t&1023);default:return t&2047}}isRenderingEnabled(){return(this.mask&24)!==0}incrementScrollX(){this.isRenderingEnabled()&&((this.vramAddr&31)===31?(this.vramAddr&=-32,this.vramAddr^=1024):this.vramAddr++)}incrementScrollY(){if(this.isRenderingEnabled())if((this.vramAddr&28672)!==28672)this.vramAddr+=4096;else{this.vramAddr&=-28673;let t=(this.vramAddr&992)>>5;t===29?(t=0,this.vramAddr^=2048):t===31?t=0:t++,this.vramAddr=this.vramAddr&-993|t<<5}}transferAddressX(){this.isRenderingEnabled()&&(this.vramAddr=this.vramAddr&64480|this.tempAddr&1055)}transferAddressY(){this.isRenderingEnabled()&&(this.vramAddr=this.vramAddr&33823|this.tempAddr&31712)}loadBackgroundShifters(){this.bgShifterPatternLo=this.bgShifterPatternLo&65280|this.bgNextTileLo,this.bgShifterPatternHi=this.bgShifterPatternHi&65280|this.bgNextTileHi,this.bgShifterAttrLo=this.bgShifterAttrLo&65280|(this.bgNextTileAttr&1?255:0),this.bgShifterAttrHi=this.bgShifterAttrHi&65280|(this.bgNextTileAttr&2?255:0)}updateShifters(){if(this.mask&8&&(this.bgShifterPatternLo=this.bgShifterPatternLo<<1&65535,this.bgShifterPatternHi=this.bgShifterPatternHi<<1&65535,this.bgShifterAttrLo=this.bgShifterAttrLo<<1&65535,this.bgShifterAttrHi=this.bgShifterAttrHi<<1&65535),this.mask&16&&this.cycle>=1&&this.cycle<258)for(let t=0;t<this.spriteCount;t++)this.secondaryOam[t*4+3]>0?this.secondaryOam[t*4+3]--:(this.spriteShifterPatternLo[t]=this.spriteShifterPatternLo[t]<<1&255,this.spriteShifterPatternHi[t]=this.spriteShifterPatternHi[t]<<1&255)}clock(){if(this.scanline>=-1&&this.scanline<240){if(this.scanline===0&&this.cycle===0&&this.oddFrame&&this.isRenderingEnabled()&&(this.cycle=1),this.scanline===-1&&this.cycle===1&&(this.status&=-129,this.status&=-33,this.status&=-65,this.spriteShifterPatternLo.fill(0),this.spriteShifterPatternHi.fill(0)),this.cycle>=2&&this.cycle<258||this.cycle>=321&&this.cycle<338)switch(this.updateShifters(),(this.cycle-1)%8){case 0:this.loadBackgroundShifters(),this.bgNextTileId=this.ppuRead(8192|this.vramAddr&4095);break;case 2:this.bgNextTileAttr=this.ppuRead(9152|this.vramAddr&3072|this.vramAddr>>4&56|this.vramAddr>>2&7),this.vramAddr>>5&2&&(this.bgNextTileAttr>>=4),this.vramAddr&2&&(this.bgNextTileAttr>>=2),this.bgNextTileAttr&=3;break;case 4:this.bgNextTileLo=this.ppuRead((this.ctrl&16?4096:0)+(this.bgNextTileId<<4)+(this.vramAddr>>12&7));break;case 6:this.bgNextTileHi=this.ppuRead((this.ctrl&16?4096:0)+(this.bgNextTileId<<4)+(this.vramAddr>>12&7)+8);break;case 7:this.incrementScrollX();break}this.cycle===256&&this.incrementScrollY(),this.cycle===257&&(this.loadBackgroundShifters(),this.transferAddressX()),this.cycle===257&&this.scanline>=0&&this.evaluateSprites(),this.cycle===260&&this.isRenderingEnabled()&&(this.scanlineIrqFlag=!0),this.scanline===-1&&this.cycle>=280&&this.cycle<305&&this.transferAddressY()}this.scanline===241&&this.cycle===1&&(this.status|=128,this.ctrl&128&&(this.nmiTriggered=!0)),this.scanline>=0&&this.scanline<240&&this.cycle>=1&&this.cycle<=256&&this.renderPixel(),this.cycle++,this.cycle>=341&&(this.cycle=0,this.scanline++,this.scanline>=261&&(this.scanline=-1,this.frameComplete=!0,this.oddFrame=!this.oddFrame))}evaluateSprites(){this.secondaryOam.fill(255),this.spriteCount=0,this.spriteZeroHitPossible=!1;const t=this.ctrl&32?16:8;for(let e=0;e<64&&this.spriteCount<8;e++){const i=this.oam[e*4],r=this.scanline-i;if(r>=0&&r<t){e===0&&(this.spriteZeroHitPossible=!0);for(let h=0;h<4;h++)this.secondaryOam[this.spriteCount*4+h]=this.oam[e*4+h];this.loadSpritePattern(this.spriteCount,r),this.spriteCount++}}this.spriteCount>=8&&(this.status|=32)}loadSpritePattern(t,e){const i=this.secondaryOam[t*4+1],r=this.secondaryOam[t*4+2],h=(r&128)!==0,c=(r&64)!==0,l=this.ctrl&32?16:8;let n;l===8?(n=(this.ctrl&8?4096:0)+(i<<4),h&&(e=7-e)):(n=(i&1?4096:0)+((i&254)<<4),h&&(e=15-e),e>=8&&(n+=16,e-=8));let o=this.ppuRead(n+e),u=this.ppuRead(n+e+8);c&&(o=this.reverseBits(o),u=this.reverseBits(u)),this.spriteShifterPatternLo[t]=o,this.spriteShifterPatternHi[t]=u}reverseBits(t){return t=(t&240)>>4|(t&15)<<4,t=(t&204)>>2|(t&51)<<2,t=(t&170)>>1|(t&85)<<1,t}renderPixel(){const t=this.cycle-1,e=this.scanline;let i=0,r=0,h=0,c=0,l=!1;if(this.mask&8&&(this.mask&2||t>=8)){const p=32768>>this.fineX,f=this.bgShifterPatternLo&p?1:0,d=this.bgShifterPatternHi&p?2:0;i=f|d;const b=this.bgShifterAttrLo&p?1:0,m=this.bgShifterAttrHi&p?2:0;r=b|m}if(this.mask&16&&(this.mask&4||t>=8)){this.spriteZeroRendering=!1;for(let p=0;p<this.spriteCount;p++)if(this.secondaryOam[p*4+3]===0){const d=this.spriteShifterPatternLo[p]&128?1:0,b=this.spriteShifterPatternHi[p]&128?2:0;h=d|b;const m=this.secondaryOam[p*4+2];if(c=(m&3)+4,l=(m&32)===0,h!==0){p===0&&(this.spriteZeroRendering=!0);break}}}let n=0,o=0;i===0&&h===0?(n=0,o=0):i===0&&h!==0?(n=h,o=c):i!==0&&h===0?(n=i,o=r):(this.spriteZeroHitPossible&&this.spriteZeroRendering&&this.mask&8&&this.mask&16&&(!(this.mask&2&&this.mask&4)?t>=8&&t<255&&(this.status|=64):t>=0&&t<255&&(this.status|=64)),l?(n=h,o=c):(n=i,o=r));const u=this.ppuRead(16128+(o<<2)+n)&63,g=C[u];this.frameBuffer[e*256+t]=4278190080|g}checkNmi(){return this.nmiTriggered?(this.nmiTriggered=!1,!0):!1}getPaletteColor(t,e){const i=this.ppuRead(16128+(t<<2)+e)&63;return C[i]}getPatternTable(t,e){const i=new Uint32Array(16384);for(let r=0;r<16;r++)for(let h=0;h<16;h++){const c=r*256+h*16;for(let l=0;l<8;l++){let n=this.ppuRead(t*4096+c+l),o=this.ppuRead(t*4096+c+l+8);for(let u=0;u<8;u++){const g=(n&1)<<0|(o&1)<<1;n>>=1,o>>=1;const p=h*8+(7-u),f=r*8+l,d=this.getPaletteColor(e,g);i[f*128+p]=4278190080|d}}}return i}checkScanlineIrq(){const t=this.scanlineIrqFlag;return this.scanlineIrqFlag=!1,t}saveState(){return{ctrl:this.ctrl,mask:this.mask,status:this.status,oamAddress:this.oamAddress,vramAddr:this.vramAddr,tempAddr:this.tempAddr,fineX:this.fineX,addressLatch:this.addressLatch,dataBuffer:this.dataBuffer,nametableRam:Array.from(this.nametableRam),paletteRam:Array.from(this.paletteRam),oam:Array.from(this.oam),secondaryOam:Array.from(this.secondaryOam),scanline:this.scanline,cycle:this.cycle,oddFrame:this.oddFrame,nmiTriggered:this.nmiTriggered,bgNextTileId:this.bgNextTileId,bgNextTileAttr:this.bgNextTileAttr,bgNextTileLo:this.bgNextTileLo,bgNextTileHi:this.bgNextTileHi}}loadState(t){this.ctrl=t.ctrl,this.mask=t.mask,this.status=t.status,this.oamAddress=t.oamAddress,this.vramAddr=t.vramAddr,this.tempAddr=t.tempAddr,this.fineX=t.fineX,this.addressLatch=t.addressLatch,this.dataBuffer=t.dataBuffer,this.nametableRam.set(t.nametableRam),this.paletteRam.set(t.paletteRam),this.oam.set(t.oam),this.secondaryOam.set(t.secondaryOam),this.scanline=t.scanline,this.cycle=t.cycle,this.oddFrame=t.oddFrame,this.nmiTriggered=t.nmiTriggered,this.bgNextTileId=t.bgNextTileId,this.bgNextTileAttr=t.bgNextTileAttr,this.bgNextTileLo=t.bgNextTileLo,this.bgNextTileHi=t.bgNextTileHi}}const R=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];class L{constantVolume=!1;volume=0;divider=0;decayLevel=0;startFlag=!1;loopFlag=!1;constructor(){this.reset()}reset(){this.constantVolume=!1,this.volume=0,this.divider=0,this.decayLevel=0,this.startFlag=!1,this.loopFlag=!1}setConstantVolume(t){this.constantVolume=t}setVolume(t){this.volume=t&15}setLoop(t){this.loopFlag=t}start(){this.startFlag=!0}clock(){this.startFlag?(this.startFlag=!1,this.decayLevel=15,this.divider=this.volume):this.divider===0?(this.divider=this.volume,this.decayLevel>0?this.decayLevel--:this.loopFlag&&(this.decayLevel=15)):this.divider--}output(){return this.constantVolume?this.volume:this.decayLevel}saveState(){return{constantVolume:this.constantVolume,volume:this.volume,divider:this.divider,decayLevel:this.decayLevel,startFlag:this.startFlag,loopFlag:this.loopFlag}}loadState(t){this.constantVolume=t.constantVolume,this.volume=t.volume,this.divider=t.divider,this.decayLevel=t.decayLevel,this.startFlag=t.startFlag,this.loopFlag=t.loopFlag}}class S{counter=0;haltFlag=!1;constructor(){this.reset()}reset(){this.counter=0,this.haltFlag=!1}load(t){this.counter=t}setHalt(t){this.haltFlag=t}clear(){this.counter=0}clock(){!this.haltFlag&&this.counter>0&&this.counter--}getValue(){return this.counter}saveState(){return{counter:this.counter,haltFlag:this.haltFlag}}loadState(t){this.counter=t.counter,this.haltFlag=t.haltFlag}}class F{isChannel1;enabled=!1;period=0;negate=!1;shift=0;divider=0;reloadFlag=!1;timerPeriod=0;constructor(t){this.isChannel1=t}reset(){this.enabled=!1,this.period=0,this.negate=!1,this.shift=0,this.divider=0,this.reloadFlag=!1,this.timerPeriod=0}write(t){this.enabled=(t&128)!==0,this.period=t>>4&7,this.negate=(t&8)!==0,this.shift=t&7,this.reloadFlag=!0}setTimerPeriod(t){this.timerPeriod=t}clock(){const t=this.timerPeriod>>this.shift;let e;this.negate?this.isChannel1?e=this.timerPeriod-t-1:e=this.timerPeriod-t:e=this.timerPeriod+t;let i=null;return this.divider===0&&this.enabled&&this.shift>0&&!this.isMuting(this.timerPeriod)&&e<=2047&&(this.timerPeriod=e,i=e),this.divider===0||this.reloadFlag?(this.divider=this.period,this.reloadFlag=!1):this.divider--,i}isMuting(t){if(t<8)return!0;if(!this.negate){const e=t>>this.shift;if(t+e>2047)return!0}return!1}saveState(){return{enabled:this.enabled,period:this.period,negate:this.negate,shift:this.shift,divider:this.divider,reloadFlag:this.reloadFlag,timerPeriod:this.timerPeriod}}loadState(t){this.enabled=t.enabled,this.period=t.period,this.negate=t.negate,this.shift=t.shift,this.divider=t.divider,this.reloadFlag=t.reloadFlag,this.timerPeriod=t.timerPeriod}}const y=[[0,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,1,1,1,1,0,0,0],[1,0,0,1,1,1,1,1]];class A{envelope;lengthCounter;sweep;dutyMode=0;sequencePos=0;timerPeriod=0;timerValue=0;enabled=!1;constructor(t){this.envelope=new L,this.lengthCounter=new S,this.sweep=new F(t)}reset(){this.envelope.reset(),this.lengthCounter.reset(),this.sweep.reset(),this.dutyMode=0,this.sequencePos=0,this.timerPeriod=0,this.timerValue=0,this.enabled=!1}writeControl(t){this.dutyMode=t>>6&3,this.lengthCounter.setHalt((t&32)!==0),this.envelope.setConstantVolume((t&16)!==0),this.envelope.setVolume(t&15)}writeSweep(t){this.sweep.write(t)}writeTimerLow(t){this.timerPeriod=this.timerPeriod&1792|t,this.sweep.setTimerPeriod(this.timerPeriod)}writeTimerHigh(t){if(this.timerPeriod=this.timerPeriod&255|(t&7)<<8,this.sweep.setTimerPeriod(this.timerPeriod),this.enabled){const e=t>>3&31;this.lengthCounter.load(R[e])}this.sequencePos=0,this.envelope.start()}clockTimer(){this.timerValue===0?(this.timerValue=this.timerPeriod,this.sequencePos=this.sequencePos+1&7):this.timerValue--}clockEnvelope(){this.envelope.clock()}clockLengthCounter(){this.lengthCounter.clock()}clockSweep(){const t=this.sweep.clock();t!==null&&(this.timerPeriod=t)}output(){return!this.enabled||this.lengthCounter.getValue()===0||this.timerPeriod<8||this.sweep.isMuting(this.timerPeriod)||y[this.dutyMode][this.sequencePos]===0?0:this.envelope.output()}setEnabled(t){this.enabled=t,t||this.lengthCounter.clear()}getLengthCounter(){return this.lengthCounter.getValue()}saveState(){return{dutyMode:this.dutyMode,sequencePos:this.sequencePos,timerPeriod:this.timerPeriod,timerValue:this.timerValue,enabled:this.enabled,envelope:this.envelope.saveState(),lengthCounter:this.lengthCounter.saveState(),sweep:this.sweep.saveState()}}loadState(t){this.dutyMode=t.dutyMode,this.sequencePos=t.sequencePos,this.timerPeriod=t.timerPeriod,this.timerValue=t.timerValue,this.enabled=t.enabled,this.envelope.loadState(t.envelope),this.lengthCounter.loadState(t.lengthCounter),this.sweep.loadState(t.sweep)}}const v=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];class w{lengthCounter;controlFlag=!1;linearCounterReload=0;linearCounter=0;linearCounterReloadFlag=!1;sequencePos=0;timerPeriod=0;timerValue=0;enabled=!1;constructor(){this.lengthCounter=new S}reset(){this.lengthCounter.reset(),this.controlFlag=!1,this.linearCounterReload=0,this.linearCounter=0,this.linearCounterReloadFlag=!1,this.sequencePos=0,this.timerPeriod=0,this.timerValue=0,this.enabled=!1}writeControl(t){this.controlFlag=(t&128)!==0,this.lengthCounter.setHalt(this.controlFlag),this.linearCounterReload=t&127}writeTimerLow(t){this.timerPeriod=this.timerPeriod&1792|t}writeTimerHigh(t){if(this.timerPeriod=this.timerPeriod&255|(t&7)<<8,this.enabled){const e=t>>3&31;this.lengthCounter.load(R[e])}this.linearCounterReloadFlag=!0}clockTimer(){this.timerValue===0?(this.timerValue=this.timerPeriod,this.lengthCounter.getValue()>0&&this.linearCounter>0&&(this.sequencePos=this.sequencePos+1&31)):this.timerValue--}clockLinearCounter(){this.linearCounterReloadFlag?this.linearCounter=this.linearCounterReload:this.linearCounter>0&&this.linearCounter--,this.controlFlag||(this.linearCounterReloadFlag=!1)}clockLengthCounter(){this.lengthCounter.clock()}output(){return!this.enabled||this.lengthCounter.getValue()===0||this.linearCounter===0?0:this.timerPeriod<2?7:v[this.sequencePos]}setEnabled(t){this.enabled=t,t||this.lengthCounter.clear()}getLengthCounter(){return this.lengthCounter.getValue()}saveState(){return{controlFlag:this.controlFlag,linearCounterReload:this.linearCounterReload,linearCounter:this.linearCounter,linearCounterReloadFlag:this.linearCounterReloadFlag,sequencePos:this.sequencePos,timerPeriod:this.timerPeriod,timerValue:this.timerValue,enabled:this.enabled,lengthCounter:this.lengthCounter.saveState()}}loadState(t){this.controlFlag=t.controlFlag,this.linearCounterReload=t.linearCounterReload,this.linearCounter=t.linearCounter,this.linearCounterReloadFlag=t.linearCounterReloadFlag,this.sequencePos=t.sequencePos,this.timerPeriod=t.timerPeriod,this.timerValue=t.timerValue,this.enabled=t.enabled,this.lengthCounter.loadState(t.lengthCounter)}}const E=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068];class T{envelope;lengthCounter;shiftRegister=1;mode=!1;timerPeriod=0;timerValue=0;enabled=!1;constructor(){this.envelope=new L,this.lengthCounter=new S}reset(){this.envelope.reset(),this.lengthCounter.reset(),this.shiftRegister=1,this.mode=!1,this.timerPeriod=0,this.timerValue=0,this.enabled=!1}writeControl(t){this.lengthCounter.setHalt((t&32)!==0),this.envelope.setConstantVolume((t&16)!==0),this.envelope.setVolume(t&15)}writePeriod(t){this.mode=(t&128)!==0,this.timerPeriod=E[t&15]}writeLength(t){if(this.enabled){const e=t>>3&31;this.lengthCounter.load(R[e])}this.envelope.start()}clockTimer(){this.timerValue===0?(this.timerValue=this.timerPeriod,this.clockShiftRegister()):this.timerValue--}clockShiftRegister(){const t=this.shiftRegister&1,e=this.mode?this.shiftRegister>>6&1:this.shiftRegister>>1&1,i=t^e;this.shiftRegister=this.shiftRegister>>1|i<<14}clockEnvelope(){this.envelope.clock()}clockLengthCounter(){this.lengthCounter.clock()}output(){return!this.enabled||this.lengthCounter.getValue()===0||this.shiftRegister&1?0:this.envelope.output()}setEnabled(t){this.enabled=t,t||this.lengthCounter.clear()}getLengthCounter(){return this.lengthCounter.getValue()}saveState(){return{shiftRegister:this.shiftRegister,mode:this.mode,timerPeriod:this.timerPeriod,timerValue:this.timerValue,enabled:this.enabled,envelope:this.envelope.saveState(),lengthCounter:this.lengthCounter.saveState()}}loadState(t){this.shiftRegister=t.shiftRegister,this.mode=t.mode,this.timerPeriod=t.timerPeriod,this.timerValue=t.timerValue,this.enabled=t.enabled,this.envelope.loadState(t.envelope),this.lengthCounter.loadState(t.lengthCounter)}}const I=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54];class D{memoryReader=null;irqCallback=null;irqEnabled=!1;loop=!1;timerPeriod=0;timerValue=0;outputLevel=0;sampleAddress=0;currentAddress=0;sampleLength=0;bytesRemaining=0;sampleBuffer=0;bufferEmpty=!0;shiftRegister=0;bitsRemaining=0;silence=!0;irqFlag=!1;constructor(){this.reset()}reset(){this.irqEnabled=!1,this.loop=!1,this.timerPeriod=0,this.timerValue=0,this.outputLevel=0,this.sampleAddress=49152,this.currentAddress=49152,this.sampleLength=0,this.bytesRemaining=0,this.sampleBuffer=0,this.bufferEmpty=!0,this.shiftRegister=0,this.bitsRemaining=8,this.silence=!0,this.irqFlag=!1}setMemoryReader(t){this.memoryReader=t}setIrqCallback(t){this.irqCallback=t}writeControl(t){this.irqEnabled=(t&128)!==0,this.loop=(t&64)!==0,this.timerPeriod=I[t&15],this.irqEnabled||(this.irqFlag=!1)}writeDirectLoad(t){this.outputLevel=t&127}writeAddress(t){this.sampleAddress=49152|t<<6}writeLength(t){this.sampleLength=t<<4|1}clockTimer(){this.silence||(this.shiftRegister&1?this.outputLevel<=125&&(this.outputLevel+=2):this.outputLevel>=2&&(this.outputLevel-=2)),this.shiftRegister>>=1,this.bitsRemaining--,this.bitsRemaining===0&&(this.bitsRemaining=8,this.startOutputCycle())}startOutputCycle(){this.bufferEmpty?this.silence=!0:(this.silence=!1,this.shiftRegister=this.sampleBuffer,this.bufferEmpty=!0,this.fetchSample())}fetchSample(){this.bytesRemaining>0&&this.bufferEmpty&&(this.memoryReader&&(this.sampleBuffer=this.memoryReader(this.currentAddress),this.bufferEmpty=!1),this.currentAddress=this.currentAddress+1&65535|32768,this.bytesRemaining--,this.bytesRemaining===0&&(this.loop?(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength):this.irqEnabled&&(this.irqFlag=!0,this.irqCallback&&this.irqCallback())))}output(){return this.outputLevel}setEnabled(t){t?this.bytesRemaining===0&&(this.currentAddress=this.sampleAddress,this.bytesRemaining=this.sampleLength):this.bytesRemaining=0,this.irqFlag=!1}getBytesRemaining(){return this.bytesRemaining}getIrqFlag(){return this.irqFlag}saveState(){return{irqEnabled:this.irqEnabled,loop:this.loop,timerPeriod:this.timerPeriod,timerValue:this.timerValue,outputLevel:this.outputLevel,sampleAddress:this.sampleAddress,currentAddress:this.currentAddress,sampleLength:this.sampleLength,bytesRemaining:this.bytesRemaining,sampleBuffer:this.sampleBuffer,bufferEmpty:this.bufferEmpty,shiftRegister:this.shiftRegister,bitsRemaining:this.bitsRemaining,silence:this.silence,irqFlag:this.irqFlag}}loadState(t){this.irqEnabled=t.irqEnabled,this.loop=t.loop,this.timerPeriod=t.timerPeriod,this.timerValue=t.timerValue,this.outputLevel=t.outputLevel,this.sampleAddress=t.sampleAddress,this.currentAddress=t.currentAddress,this.sampleLength=t.sampleLength,this.bytesRemaining=t.bytesRemaining,this.sampleBuffer=t.sampleBuffer,this.bufferEmpty=t.bufferEmpty,this.shiftRegister=t.shiftRegister,this.bitsRemaining=t.bitsRemaining,this.silence=t.silence,this.irqFlag=t.irqFlag}}const V=[7457,14913,22371,29829],x=[7457,14913,22371,29829,37281];class N{mode=0;irqInhibit=!1;clockCounter=0;currentStep=0;irqFlag=!1;irqCallback=null;constructor(){this.reset()}reset(){this.mode=0,this.irqInhibit=!1,this.clockCounter=0,this.currentStep=0,this.irqFlag=!1}setIrqCallback(t){this.irqCallback=t}write(t){this.mode=t&128?1:0,this.irqInhibit=(t&64)!==0,this.irqInhibit&&(this.irqFlag=!1),this.clockCounter=0,this.currentStep=0,this.mode}clock(){this.clockCounter++;const t=this.mode===0?V:x;if(this.currentStep>=t.length)return 0;if(this.clockCounter>=t[this.currentStep]){let e=0;if(this.mode===0)switch(this.currentStep){case 0:e=1;break;case 1:e=3;break;case 2:e=1;break;case 3:e=3,this.irqInhibit||(this.irqFlag=!0,this.irqCallback&&this.irqCallback()),this.clockCounter=0,this.currentStep=-1;break}else switch(this.currentStep){case 0:e=1;break;case 1:e=3;break;case 2:e=1;break;case 3:e=0;break;case 4:e=3,this.clockCounter=0,this.currentStep=-1;break}return this.currentStep++,e}return 0}getIrqFlag(){return this.irqFlag}clearIrqFlag(){this.irqFlag=!1}saveState(){return{mode:this.mode,irqInhibit:this.irqInhibit,clockCounter:this.clockCounter,currentStep:this.currentStep,irqFlag:this.irqFlag}}loadState(t){this.mode=t.mode,this.irqInhibit=t.irqInhibit,this.clockCounter=t.clockCounter,this.currentStep=t.currentStep,this.irqFlag=t.irqFlag}}class O{pulse1;pulse2;triangle;noise;dmc;frameCounter;statusRegister=0;clockCounter=0;sampleCounter=0;sampleRate=44100;CPU_FREQUENCY=1789773;cyclesPerSample;audioCallback=null;audioBuffer;writeIndex=0;readIndex=0;BUFFER_SIZE=8192;filterAccumulator=0;FILTER_COEFFICIENT=.9;highPassPrev=0;highPassOutput=0;HIGHPASS_COEFFICIENT=.996;constructor(){this.pulse1=new A(!0),this.pulse2=new A(!1),this.triangle=new w,this.noise=new T,this.dmc=new D,this.frameCounter=new N,this.cyclesPerSample=this.CPU_FREQUENCY/this.sampleRate,this.audioBuffer=new Float32Array(this.BUFFER_SIZE),this.reset()}reset(){this.pulse1.reset(),this.pulse2.reset(),this.triangle.reset(),this.noise.reset(),this.dmc.reset(),this.frameCounter.reset(),this.statusRegister=0,this.clockCounter=0,this.sampleCounter=0,this.writeIndex=0,this.readIndex=0,this.filterAccumulator=0,this.highPassPrev=0,this.highPassOutput=0,this.audioBuffer.fill(0)}setAudioCallback(t){this.audioCallback=t}setSampleRate(t){this.sampleRate=t,this.cyclesPerSample=this.CPU_FREQUENCY/t}setMemoryReader(t){this.dmc.setMemoryReader(t)}setIrqCallback(t){this.frameCounter.setIrqCallback(t),this.dmc.setIrqCallback(t)}clock(){this.triangle.clockTimer(),this.clockCounter%2===0&&(this.pulse1.clockTimer(),this.pulse2.clockTimer(),this.noise.clockTimer(),this.dmc.clockTimer());const t=this.frameCounter.clock();t&&this.handleFrameAction(t),this.sampleCounter+=1,this.sampleCounter>=this.cyclesPerSample&&(this.sampleCounter-=this.cyclesPerSample,this.generateSample()),this.clockCounter++}handleFrameAction(t){t&1&&(this.pulse1.clockEnvelope(),this.pulse2.clockEnvelope(),this.triangle.clockLinearCounter(),this.noise.clockEnvelope()),t&2&&(this.pulse1.clockLengthCounter(),this.pulse1.clockSweep(),this.pulse2.clockLengthCounter(),this.pulse2.clockSweep(),this.triangle.clockLengthCounter(),this.noise.clockLengthCounter())}generateSample(){const t=this.pulse1.output(),e=this.pulse2.output(),i=this.triangle.output(),r=this.noise.output(),h=this.dmc.output(),c=this.mixPulse(t,e),l=this.mixTnd(i,r,h);let n=c+l;this.filterAccumulator=this.filterAccumulator*this.FILTER_COEFFICIENT+n*(1-this.FILTER_COEFFICIENT),n=this.filterAccumulator;const o=n;this.highPassOutput=this.HIGHPASS_COEFFICIENT*this.highPassOutput+o-this.highPassPrev,this.highPassPrev=o,n=this.highPassOutput,n=n*1.5,n>.95?n=.95+(n-.95)*.2:n<-.95&&(n=-.95+(n+.95)*.2),n=Math.max(-1,Math.min(1,n)),this.audioBuffer[this.writeIndex]=n,this.writeIndex=(this.writeIndex+1)%this.BUFFER_SIZE}mixPulse(t,e){const i=t+e;return i===0?0:95.88/(8128/i+100)}mixTnd(t,e,i){if(t===0&&e===0&&i===0)return 0;const r=t/8227+e/12241+i/22638;return r===0?0:159.79/(1/r+100)}cpuRead(t){return t===16405?this.readStatus():0}cpuWrite(t,e){switch(e&=255,t){case 16384:this.pulse1.writeControl(e);break;case 16385:this.pulse1.writeSweep(e);break;case 16386:this.pulse1.writeTimerLow(e);break;case 16387:this.pulse1.writeTimerHigh(e);break;case 16388:this.pulse2.writeControl(e);break;case 16389:this.pulse2.writeSweep(e);break;case 16390:this.pulse2.writeTimerLow(e);break;case 16391:this.pulse2.writeTimerHigh(e);break;case 16392:this.triangle.writeControl(e);break;case 16394:this.triangle.writeTimerLow(e);break;case 16395:this.triangle.writeTimerHigh(e);break;case 16396:this.noise.writeControl(e);break;case 16398:this.noise.writePeriod(e);break;case 16399:this.noise.writeLength(e);break;case 16400:this.dmc.writeControl(e);break;case 16401:this.dmc.writeDirectLoad(e);break;case 16402:this.dmc.writeAddress(e);break;case 16403:this.dmc.writeLength(e);break;case 16405:this.writeStatus(e);break;case 16407:this.frameCounter.write(e);break}}readStatus(){let t=0;return this.pulse1.getLengthCounter()>0&&(t|=1),this.pulse2.getLengthCounter()>0&&(t|=2),this.triangle.getLengthCounter()>0&&(t|=4),this.noise.getLengthCounter()>0&&(t|=8),this.dmc.getBytesRemaining()>0&&(t|=16),this.frameCounter.getIrqFlag()&&(t|=64),this.frameCounter.clearIrqFlag(),this.dmc.getIrqFlag()&&(t|=128),t}writeStatus(t){this.statusRegister=t,this.pulse1.setEnabled((t&1)!==0),this.pulse2.setEnabled((t&2)!==0),this.triangle.setEnabled((t&4)!==0),this.noise.setEnabled((t&8)!==0),this.dmc.setEnabled((t&16)!==0)}readSamples(t){let e=0;const i=t.length,r=this.getAvailableSamples();if(r===0){for(let h=0;h<i;h++)t[h]=0;return 0}if(r<i){const h=[];for(;this.readIndex!==this.writeIndex;)h.push(this.audioBuffer[this.readIndex]),this.readIndex=(this.readIndex+1)%this.BUFFER_SIZE;const c=h.length/i;for(let l=0;l<i;l++){const n=l*c,o=Math.floor(n),u=n-o,g=h[Math.min(o,h.length-1)],p=h[Math.min(o+1,h.length-1)];t[l]=g*(1-u)+p*u}return i}for(;e<i&&this.readIndex!==this.writeIndex;)t[e]=this.audioBuffer[this.readIndex],this.readIndex=(this.readIndex+1)%this.BUFFER_SIZE,e++;return e}getAvailableSamples(){return this.writeIndex>=this.readIndex?this.writeIndex-this.readIndex:this.BUFFER_SIZE-this.readIndex+this.writeIndex}saveState(){return{pulse1:this.pulse1.saveState(),pulse2:this.pulse2.saveState(),triangle:this.triangle.saveState(),noise:this.noise.saveState(),dmc:this.dmc.saveState(),frameCounter:this.frameCounter.saveState(),statusRegister:this.statusRegister,clockCounter:this.clockCounter}}loadState(t){this.pulse1.loadState(t.pulse1),this.pulse2.loadState(t.pulse2),this.triangle.loadState(t.triangle),this.noise.loadState(t.noise),this.dmc.loadState(t.dmc),this.frameCounter.loadState(t.frameCounter),this.statusRegister=t.statusRegister,this.clockCounter=t.clockCounter}}class H{ram=new Uint8Array(2048);ppu=null;apu=null;cartridge=null;controller1=null;controller2=null;controllerState=[0,0];dmaPage=0;dmaAddress=0;dmaData=0;dmaTransfer=!1;dmaDummy=!0;constructor(){this.ram.fill(0)}connectPpu(t){this.ppu=t}connectApu(t){this.apu=t}connectCartridge(t){this.cartridge=t}connectController(t,e){t===1?this.controller1=e:this.controller2=e}cpuRead(t){if(t&=65535,t>=16416)return this.cartridge?this.cartridge.cpuRead(t):0;if(t<8192)return this.ram[t&2047];if(t<16384)return this.ppu?this.ppu.cpuRead(t&8199):0;if(t===16406){const e=this.controllerState[0]&128?1:0;return this.controllerState[0]<<=1,e}if(t===16407){const e=this.controllerState[1]&128?1:0;return this.controllerState[1]<<=1,e}return t===16405&&this.apu?this.apu.cpuRead(t):0}cpuWrite(t,e){if(t&=65535,e&=255,t>=16416){this.cartridge&&this.cartridge.cpuWrite(t,e);return}if(t<8192){this.ram[t&2047]=e;return}if(t<16384){this.ppu&&this.ppu.cpuWrite(t&8199,e);return}if(t===16404){this.dmaPage=e,this.dmaAddress=0,this.dmaTransfer=!0,this.dmaDummy=!0;return}if(t===16406){this.controllerState[0]=this.controller1?.getState()??0,this.controllerState[1]=this.controller2?.getState()??0;return}if(t>=16384&&t<=16403||t===16405||t===16407){this.apu&&this.apu.cpuWrite(t,e);return}}isDmaTransferring(){return this.dmaTransfer}doCycle(t){this.dmaTransfer&&(this.dmaDummy?t&&(this.dmaDummy=!1):t?(this.ppu&&this.ppu.oamWrite(this.dmaAddress,this.dmaData),this.dmaAddress++,this.dmaAddress>255&&(this.dmaTransfer=!1,this.dmaAddress=0)):this.dmaData=this.cpuRead(this.dmaPage<<8|this.dmaAddress))}debugReadRam(t){return this.ram[t&2047]}debugWriteRam(t,e){this.ram[t&2047]=e&255}saveState(){return{ram:Array.from(this.ram),controllerState:[...this.controllerState],dmaPage:this.dmaPage,dmaAddress:this.dmaAddress,dmaData:this.dmaData,dmaTransfer:this.dmaTransfer,dmaDummy:this.dmaDummy}}loadState(t){this.ram.set(t.ram),this.controllerState=[t.controllerState[0],t.controllerState[1]],this.dmaPage=t.dmaPage,this.dmaAddress=t.dmaAddress,this.dmaData=t.dmaData,this.dmaTransfer=t.dmaTransfer,this.dmaDummy=t.dmaDummy}}class X{prgBanks;chrBanks;constructor(t,e){this.prgBanks=t,this.chrBanks=e}cpuMapRead(t){if(t>=32768){const e=this.prgBanks>1?32767:16383;return t&e}return null}cpuMapWrite(t,e){return null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}}class Y{prgBanks;chrBanks;shiftRegister=16;controlRegister=12;chrBank0=0;chrBank1=0;prgBank=0;constructor(t,e){this.prgBanks=t,this.chrBanks=e,this.reset()}reset(){this.shiftRegister=16,this.controlRegister=12,this.chrBank0=0,this.chrBank1=0,this.prgBank=0}cpuMapRead(t){if(t>=32768){const e=this.controlRegister>>2&3;return e<=1?(this.prgBank&14)*16384+(t&32767):e===2?t<49152?t&16383:this.prgBank*16384+(t&16383):t<49152?this.prgBank*16384+(t&16383):(this.prgBanks-1)*16384+(t&16383)}return null}cpuMapWrite(t,e){if(t>=32768){if(e&128)return this.shiftRegister=16,this.controlRegister|=12,null;const i=this.shiftRegister&1;if(this.shiftRegister=this.shiftRegister>>1|(e&1)<<4,i){const r=t>>13&3,h=this.shiftRegister;switch(r){case 0:this.controlRegister=h;break;case 1:this.chrBank0=h;break;case 2:this.chrBank1=h;break;case 3:this.prgBank=h&15;break}this.shiftRegister=16;const c=this.controlRegister&3;let l;switch(c){case 0:l=a.SingleScreenLow;break;case 1:l=a.SingleScreenHigh;break;case 2:l=a.Vertical;break;default:l=a.Horizontal;break}return{mirrorMode:l}}}return null}ppuMapRead(t){if(t<8192){const e=this.controlRegister>>4&1,i=Math.max(1,this.chrBanks*2);return e===0?(this.chrBank0&30)%i*4096+t:t<4096?this.chrBank0%i*4096+t:this.chrBank1%i*4096+(t&4095)}return null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}}class _{prgBanks;_chrBanks;selectedBank=0;constructor(t,e){this.prgBanks=t,this._chrBanks=e}reset(){this.selectedBank=0}cpuMapRead(t){return t>=32768&&t<49152?this.selectedBank*16384+(t&16383):t>=49152?(this.prgBanks-1)*16384+(t&16383):null}cpuMapWrite(t,e){return t>=32768&&(this.selectedBank=e&15),null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}}class U{prgBanks;_chrBanks;selectedChrBank=0;constructor(t,e){this.prgBanks=t,this._chrBanks=e}reset(){this.selectedChrBank=0}cpuMapRead(t){if(t>=32768){const e=this.prgBanks>1?32767:16383;return t&e}return null}cpuMapWrite(t,e){return t>=32768&&(this.selectedChrBank=e&3),null}ppuMapRead(t){return t<8192?this.selectedChrBank*8192+t:null}ppuMapWrite(t){return null}}class W{prgBanks;chrBanks;registers=new Array(8).fill(0);bankSelect=0;prgRomBankMode=!1;chrA12Inversion=!1;mirrorMode=a.Vertical;irqCounter=0;irqLatch=0;irqEnabled=!1;irqReload=!1;irqPending=!1;_prgRamEnabled=!0;_prgRamWriteProtect=!1;constructor(t,e){this.prgBanks=t,this.chrBanks=e,this.reset()}reset(){this.registers=new Array(8).fill(0),this.bankSelect=0,this.prgRomBankMode=!1,this.chrA12Inversion=!1,this.mirrorMode=a.Vertical,this.irqCounter=0,this.irqLatch=0,this.irqEnabled=!1,this.irqReload=!1,this.irqPending=!1,this._prgRamEnabled=!0,this._prgRamWriteProtect=!1}cpuMapRead(t){return t>=32768?this.getPrgBank(t)*8192+(t&8191):null}cpuMapWrite(t,e){if(t>=32768){const i=(t&1)===0;switch(t>>13&3){case 0:i?(this.bankSelect=e&7,this.prgRomBankMode=(e&64)!==0,this.chrA12Inversion=(e&128)!==0):this.registers[this.bankSelect]=e;break;case 1:if(i)return this.mirrorMode=e&1?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorMode};this._prgRamWriteProtect=(e&64)!==0,this._prgRamEnabled=(e&128)!==0;break;case 2:i?this.irqLatch=e:this.irqReload=!0;break;case 3:i?(this.irqEnabled=!1,this.irqPending=!1):this.irqEnabled=!0;break}}return null}getPrgBank(t){const e=this.prgBanks*2-1,i=this.prgBanks*2-2;return t<40960?this.prgRomBankMode?i:this.registers[6]&63:t<49152?this.registers[7]&63:t<57344?this.prgRomBankMode?this.registers[6]&63:i:e}ppuMapRead(t){return t<8192?this.getChrBank(t)*1024+(t&1023):null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}getChrBank(t){const e=t>>10;if(this.chrA12Inversion)switch(e){case 0:return this.registers[2];case 1:return this.registers[3];case 2:return this.registers[4];case 3:return this.registers[5];case 4:return this.registers[0]&254;case 5:return this.registers[0]&254|1;case 6:return this.registers[1]&254;case 7:return this.registers[1]&254|1}else switch(e){case 0:return this.registers[0]&254;case 1:return this.registers[0]&254|1;case 2:return this.registers[1]&254;case 3:return this.registers[1]&254|1;case 4:return this.registers[2];case 5:return this.registers[3];case 6:return this.registers[4];case 7:return this.registers[5]}return 0}scanline(){this.irqCounter===0||this.irqReload?(this.irqCounter=this.irqLatch,this.irqReload=!1):this.irqCounter--,this.irqCounter===0&&this.irqEnabled&&(this.irqPending=!0)}getIrqPending(){const t=this.irqPending;return this.irqPending=!1,t}}class ${prgBanks;selectedBank=0;singleScreen=0;mirrorModeValue=a.SingleScreenLow;constructor(t,e){this.prgBanks=t}reset(){this.selectedBank=0,this.singleScreen=0,this.mirrorModeValue=a.SingleScreenLow}cpuMapRead(t){return t>=32768?this.selectedBank*32768+(t&32767):null}cpuMapWrite(t,e){return t>=32768?(this.selectedBank=e&7,this.singleScreen=e>>4&1,this.mirrorModeValue=this.singleScreen?a.SingleScreenHigh:a.SingleScreenLow,{mirrorMode:this.mirrorModeValue}):null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}}class z{prgBanks;chrBanks;prgBank=0;chrBank=0;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.chrBank=0}cpuMapRead(t){return t>=32768?this.prgBank%this.prgBanks*32768+(t&32767):null}cpuMapWrite(t,e){return t>=32768&&(this.prgBank=e&3,this.chrBank=e>>4&15),null}ppuMapRead(t){return t<8192?this.chrBank%Math.max(1,this.chrBanks)*8192+t:null}ppuMapWrite(t){return null}}class Z{prgBanks;chrBanks;chrBankRegs=[0,0,0,0,0,0,0,0];prgBank=0;irqCounter=0;irqLatch=0;irqEnabled=!1;irqPending=!1;mirrorModeValue=a.Vertical;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.chrBankRegs.fill(0),this.prgBank=0,this.irqCounter=0,this.irqLatch=0,this.irqEnabled=!1,this.irqPending=!1}cpuMapRead(t){return t>=32768&&t<49152?this.prgBank%this.prgBanks*16384+(t&16383):t>=49152?(this.prgBanks-1)*16384+(t&16383):null}cpuMapWrite(t,e){let i;if(t>=24576&&t<32768)i=t&15;else if(t>=32768)i=t&15;else return null;if(i<8)this.chrBankRegs[i]=e;else if(i===8)this.prgBank=e&15;else if(i===9){switch(e&3){case 0:this.mirrorModeValue=a.Vertical;break;case 1:this.mirrorModeValue=a.Horizontal;break;case 2:this.mirrorModeValue=a.SingleScreenLow;break;case 3:this.mirrorModeValue=a.SingleScreenHigh;break}return{mirrorMode:this.mirrorModeValue}}else i===10?(this.irqEnabled=(e&1)!==0,this.irqCounter=this.irqLatch,this.irqPending=!1):i===11?this.irqLatch=this.irqLatch&65280|e:i===12&&(this.irqLatch=this.irqLatch&255|e<<8);return null}ppuMapRead(t){if(t<8192){const e=t>>10,i=Math.max(1,this.chrBanks*8);return this.chrBankRegs[e]%i*1024+(t&1023)}return null}ppuMapWrite(t){return null}cpuClock(){this.irqEnabled&&(this.irqCounter===0?this.irqPending=!0:this.irqCounter--)}getIrqPending(){const t=this.irqPending;return this.irqPending=!1,t}}class K{prgBanks;chrBanks;prgBank0=0;prgBank1=0;chrBankRegs=[0,0,0,0,0,0,0,0];prgSwapMode=0;mirrorModeValue=a.Vertical;irqLatch=0;irqControl=0;irqCounter=0;irqPrescaler=0;irqEnabled=!1;irqPending=!1;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank0=0,this.prgBank1=0,this.chrBankRegs.fill(0),this.prgSwapMode=0,this.irqLatch=0,this.irqControl=0,this.irqCounter=0,this.irqPrescaler=0,this.irqEnabled=!1,this.irqPending=!1}cpuMapRead(t){return t>=32768&&t<40960?(this.prgSwapMode?this.prgBanks*2-2:this.prgBank0)%(this.prgBanks*2)*8192+(t&8191):t>=40960&&t<49152?this.prgBank1%(this.prgBanks*2)*8192+(t&8191):t>=49152&&t<57344?(this.prgSwapMode?this.prgBank0:this.prgBanks*2-2)%(this.prgBanks*2)*8192+(t&8191):t>=57344?(this.prgBanks*2-1)*8192+(t&8191):null}cpuMapWrite(t,e){const i=t&1,r=(t&2)>>1;switch(t&61440|r<<1|i){case 32768:case 32769:case 32770:case 32771:this.prgBank0=e&31;break;case 36864:case 36865:switch(e&3){case 0:this.mirrorModeValue=a.Vertical;break;case 1:this.mirrorModeValue=a.Horizontal;break;case 2:this.mirrorModeValue=a.SingleScreenLow;break;case 3:this.mirrorModeValue=a.SingleScreenHigh;break}return{mirrorMode:this.mirrorModeValue};case 36866:case 36867:this.prgSwapMode=e>>1&1;break;case 40960:case 40961:case 40962:case 40963:this.prgBank1=e&31;break;case 45056:this.chrBankRegs[0]=this.chrBankRegs[0]&240|e&15;break;case 45057:this.chrBankRegs[0]=this.chrBankRegs[0]&15|(e&15)<<4;break;case 45058:this.chrBankRegs[1]=this.chrBankRegs[1]&240|e&15;break;case 45059:this.chrBankRegs[1]=this.chrBankRegs[1]&15|(e&15)<<4;break;case 49152:this.chrBankRegs[2]=this.chrBankRegs[2]&240|e&15;break;case 49153:this.chrBankRegs[2]=this.chrBankRegs[2]&15|(e&15)<<4;break;case 49154:this.chrBankRegs[3]=this.chrBankRegs[3]&240|e&15;break;case 49155:this.chrBankRegs[3]=this.chrBankRegs[3]&15|(e&15)<<4;break;case 53248:this.chrBankRegs[4]=this.chrBankRegs[4]&240|e&15;break;case 53249:this.chrBankRegs[4]=this.chrBankRegs[4]&15|(e&15)<<4;break;case 53250:this.chrBankRegs[5]=this.chrBankRegs[5]&240|e&15;break;case 53251:this.chrBankRegs[5]=this.chrBankRegs[5]&15|(e&15)<<4;break;case 57344:this.chrBankRegs[6]=this.chrBankRegs[6]&240|e&15;break;case 57345:this.chrBankRegs[6]=this.chrBankRegs[6]&15|(e&15)<<4;break;case 57346:this.chrBankRegs[7]=this.chrBankRegs[7]&240|e&15;break;case 57347:this.chrBankRegs[7]=this.chrBankRegs[7]&15|(e&15)<<4;break;case 61440:this.irqLatch=this.irqLatch&240|e&15;break;case 61441:this.irqLatch=this.irqLatch&15|(e&15)<<4;break;case 61442:this.irqControl=e,this.irqEnabled=(e&2)!==0,e&2&&(this.irqCounter=this.irqLatch,this.irqPrescaler=341),this.irqPending=!1;break;case 61443:this.irqEnabled=(this.irqControl&1)!==0,this.irqPending=!1;break}return null}ppuMapRead(t){if(t<8192){const e=t>>10,i=this.chrBankRegs[e],r=this.chrBanks*8;return i%r*1024+(t&1023)}return null}ppuMapWrite(t){return null}scanline(){this.irqEnabled&&(this.irqPrescaler-=3,this.irqPrescaler<=0&&(this.irqPrescaler+=341,this.irqCounter===255?(this.irqCounter=this.irqLatch,this.irqPending=!0):this.irqCounter++))}getIrqPending(){const t=this.irqPending;return this.irqPending=!1,t}}class J{prgBanks;chrBanks;prgBank=0;chrBank=0;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.chrBank=0}cpuMapRead(t){return t>=32768?this.prgBank%this.prgBanks*32768+(t&32767):null}cpuMapWrite(t,e){return t>=32768&&(this.chrBank=e&3,this.prgBank=e>>4&3),null}ppuMapRead(t){return t<8192?this.chrBank%Math.max(1,this.chrBanks)*8192+t:null}ppuMapWrite(t){return null}}class Q{prgBanks;selectedBank=0;mirrorModeValue=a.Horizontal;constructor(t,e){this.prgBanks=t}reset(){this.selectedBank=0}cpuMapRead(t){return t>=32768&&t<49152?this.selectedBank*16384+(t&16383):t>=49152?(this.prgBanks-1)*16384+(t&16383):null}cpuMapWrite(t,e){return t>=36864&&t<40960?(this.mirrorModeValue=e&16?a.SingleScreenHigh:a.SingleScreenLow,{mirrorMode:this.mirrorModeValue}):(t>=49152&&(this.selectedBank=e&15),null)}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}}class G{prgBanks;prgBank=0;prgMode=0;mirrorModeValue=a.Vertical;constructor(t,e){this.prgBanks=t}reset(){this.prgBank=0,this.prgMode=0}cpuMapRead(t){if(t>=32768){const e=this.prgBank*2,i=this.prgBanks*2;switch(this.prgMode){case 0:return(e&-4)%i*8192+(t&32767);case 1:return t<49152?e%i*8192+(t&16383):(e|1)%i*8192+(t&16383);case 2:return e%i*8192+(t&8191);case 3:default:return t<49152?e%i*8192+(t&16383):(e|1)%i*8192+(t&16383)}}return null}cpuMapWrite(t,e){return t>=32768?(this.prgMode=t&3,this.prgBank=e&63|(e&128)>>1,this.mirrorModeValue=e&64?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorModeValue}):null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}}class j{prgBanks;chrBanks;prgBank=0;chrBank=0;mirrorModeValue=a.Vertical;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.chrBank=0}cpuMapRead(t){return t>=32768?this.prgBank%this.prgBanks*32768+(t&32767):null}cpuMapWrite(t,e){return t>=16640&&t<24576?(this.prgBank=e>>3&7,this.chrBank=e&7|e>>3&8,this.mirrorModeValue=e&128?a.Vertical:a.Horizontal,{mirrorMode:this.mirrorModeValue}):null}ppuMapRead(t){if(t<8192){const e=Math.max(1,this.chrBanks);return this.chrBank%e*8192+t}return null}ppuMapWrite(t){return null}}class tt{prgBanks;chrBanks;prgBank=0;chrBank=0;prgMode=0;mirrorMode=a.Vertical;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.chrBank=0,this.prgMode=0,this.mirrorMode=a.Vertical}cpuMapRead(t){if(t>=32768){const e=this.prgBanks*16384;if(this.prgMode===0){const i=t&16383;return(this.prgBank*16384+i)%e}else{const i=this.prgBank>>1,r=t&32767;return(i*32768+r)%e}}return null}cpuMapWrite(t,e){if(t>=32768){const i=t>>1&7;return this.prgBank=i,this.chrBank=i,this.prgMode=t&1^t>>3&1,this.mirrorMode=t&1?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorMode}}return null}ppuMapRead(t){if(t<8192){if(this.chrBanks===0)return t;const e=this.chrBanks*8192;return(this.chrBank*8192+(t&8191))%e}return null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}}class et{prgBanks;chrBanks;bankRegs=[0,0,0,0,0,0,0,0];bankSelect=0;mirrorModeValue=a.Vertical;irqCounter=0;irqLatch=0;irqEnabled=!1;irqReload=!1;irqPending=!1;prgHighBit=0;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.bankRegs.fill(0),this.bankSelect=0,this.irqCounter=0,this.irqLatch=0,this.irqEnabled=!1,this.irqReload=!1,this.irqPending=!1,this.prgHighBit=0}cpuMapRead(t){const e=this.prgBanks*2;return t>=32768&&t<40960?(this.bankSelect&64?e-2:(this.bankRegs[6]|this.prgHighBit)%e)*8192+(t&8191):t>=40960&&t<49152?(this.bankRegs[7]|this.prgHighBit)%e*8192+(t&8191):t>=49152&&t<57344?(this.bankSelect&64?(this.bankRegs[6]|this.prgHighBit)%e:e-2)*8192+(t&8191):t>=57344?(e-1)*8192+(t&8191):null}cpuMapWrite(t,e){if(t>=32768&&t<40960)if(t&1){const i=this.bankSelect&7;this.bankRegs[i]=e,i===0&&(this.prgHighBit=e&2?64:0)}else this.bankSelect=e;else if(t>=40960&&t<49152){if(!(t&1))return this.mirrorModeValue=e&1?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorModeValue}}else t>=49152&&t<57344?t&1?this.irqReload=!0:this.irqLatch=e:t>=57344&&(t&1?this.irqEnabled=!0:(this.irqEnabled=!1,this.irqPending=!1));return null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}scanline(){this.irqReload||this.irqCounter===0?(this.irqCounter=this.irqLatch,this.irqReload=!1):this.irqCounter--,this.irqCounter===0&&this.irqEnabled&&(this.irqPending=!0)}getIrqPending(){const t=this.irqPending;return this.irqPending=!1,t}}class it{prgBanks;chrBanks;prgBank0=0;prgBank1=0;chrBankRegs=[0,0,0,0,0,0,0,0];chrBankHigh=[0,0,0,0,0,0,0,0];mirrorModeValue=a.Vertical;irqLatch=0;irqControl=0;irqCounter=0;irqEnabled=!1;irqPending=!1;irqPrescaler=0;vramEnable=!1;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank0=0,this.prgBank1=0,this.chrBankRegs.fill(0),this.chrBankHigh.fill(0),this.irqLatch=0,this.irqControl=0,this.irqCounter=0,this.irqEnabled=!1,this.irqPending=!1,this.irqPrescaler=0,this.vramEnable=!1}cpuMapRead(t){const e=this.prgBanks*2;return t>=32768&&t<40960?this.prgBank0%e*8192+(t&8191):t>=40960&&t<49152?this.prgBank1%e*8192+(t&8191):t>=49152&&t<57344?(e-2)*8192+(t&8191):t>=57344?(e-1)*8192+(t&8191):null}cpuMapWrite(t,e){switch(t&61452){case 32768:case 32772:case 32776:case 32780:this.prgBank0=e;break;case 36864:return this.mirrorModeValue=e&1?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorModeValue};case 40960:case 40964:case 40968:case 40972:this.prgBank1=e;break;case 45056:this.chrBankRegs[0]=this.chrBankRegs[0]&240|e&15;break;case 45060:this.chrBankRegs[0]=this.chrBankRegs[0]&15|(e&15)<<4,this.chrBankHigh[0]=e&16;break;case 45064:this.chrBankRegs[1]=this.chrBankRegs[1]&240|e&15;break;case 45068:this.chrBankRegs[1]=this.chrBankRegs[1]&15|(e&15)<<4,this.chrBankHigh[1]=e&16;break;case 49152:this.chrBankRegs[2]=this.chrBankRegs[2]&240|e&15;break;case 49156:this.chrBankRegs[2]=this.chrBankRegs[2]&15|(e&15)<<4,this.chrBankHigh[2]=e&16;break;case 49160:this.chrBankRegs[3]=this.chrBankRegs[3]&240|e&15;break;case 49164:this.chrBankRegs[3]=this.chrBankRegs[3]&15|(e&15)<<4,this.chrBankHigh[3]=e&16;break;case 53248:this.chrBankRegs[4]=this.chrBankRegs[4]&240|e&15;break;case 53252:this.chrBankRegs[4]=this.chrBankRegs[4]&15|(e&15)<<4,this.chrBankHigh[4]=e&16;break;case 53256:this.chrBankRegs[5]=this.chrBankRegs[5]&240|e&15;break;case 53260:this.chrBankRegs[5]=this.chrBankRegs[5]&15|(e&15)<<4,this.chrBankHigh[5]=e&16;break;case 57344:this.chrBankRegs[6]=this.chrBankRegs[6]&240|e&15;break;case 57348:this.chrBankRegs[6]=this.chrBankRegs[6]&15|(e&15)<<4,this.chrBankHigh[6]=e&16;break;case 57352:this.chrBankRegs[7]=this.chrBankRegs[7]&240|e&15;break;case 57356:this.chrBankRegs[7]=this.chrBankRegs[7]&15|(e&15)<<4,this.chrBankHigh[7]=e&16;break;case 61440:this.irqLatch=this.irqLatch&240|e&15;break;case 61444:this.irqLatch=this.irqLatch&15|(e&15)<<4;break;case 61448:this.irqControl=e,this.irqEnabled=(e&2)!==0,e&2&&(this.irqCounter=this.irqLatch,this.irqPrescaler=341),this.irqPending=!1;break;case 61452:this.irqEnabled=(this.irqControl&1)!==0,this.irqPending=!1;break}return null}ppuMapRead(t){if(t<8192){const e=t>>10,i=this.chrBankRegs[e]|(this.chrBankHigh[e]?256:0);if(this.chrBanks===0)return t;const r=this.chrBanks*8;return i%r*1024+(t&1023)}return null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}scanline(){this.irqEnabled&&(this.irqPrescaler-=3,this.irqPrescaler<=0&&(this.irqPrescaler+=341,this.irqCounter===255?(this.irqCounter=this.irqLatch,this.irqPending=!0):this.irqCounter++))}getIrqPending(){const t=this.irqPending;return this.irqPending=!1,t}}class st{prgBanks;chrBanks;prgBank=0;chrBank=0;prgMode=0;mirrorMode=a.Vertical;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.chrBank=0,this.prgMode=0,this.mirrorMode=a.Vertical}cpuMapRead(t){if(t>=32768){const e=this.prgBanks*16384;if(this.prgMode===0){const i=this.prgBank>>1,r=t&32767;return(i*32768+r)%e}else{const i=t&16383;return(this.prgBank*16384+i)%e}}return null}cpuMapWrite(t,e){return t>=32768?(this.prgBank=t&63|t>>8&64,this.prgMode=t>>6&1,this.chrBank=t>>8&63,this.mirrorMode=t&128?a.Horizontal:a.Vertical,{mirrorMode:this.mirrorMode}):null}ppuMapRead(t){if(t<8192){if(this.chrBanks===0)return t;const e=this.chrBanks*8192;return(this.chrBank*8192+(t&8191))%e}return null}ppuMapWrite(t){return t<8192&&this.chrBanks===0?t:null}}class rt{prgBanks;chrBanks;prgBank=0;prgMode=0;lastBank=!1;mirrorMode=a.Vertical;constructor(t,e){this.prgBanks=t,this.chrBanks=e}reset(){this.prgBank=0,this.prgMode=0,this.lastBank=!1,this.mirrorMode=a.Vertical}cpuMapRead(t){if(t>=32768){const e=this.prgBanks*16384;if(this.prgMode===0){const i=t&32767;return((this.prgBank>>1)*32768+i)%e}else{const i=t&16383;return t>=49152?this.lastBank?e-16384+i:(this.prgBank*16384+i)%e:(this.prgBank*16384+i)%e}}return null}cpuMapWrite(t,e){return t>=32768?(this.prgMode=t&1,this.mirrorMode=t&2?a.Horizontal:a.Vertical,this.prgBank=t>>2&31|t>>3&96,this.lastBank=(t&128)!==0,{mirrorMode:this.mirrorMode}):null}ppuMapRead(t){return t<8192?t:null}ppuMapWrite(t){return t<8192?t:null}}function ht(s,t,e){switch(s){case 0:return new X(t,e);case 1:return new Y(t,e);case 2:return new _(t,e);case 3:return new U(t,e);case 4:return new W(t,e);case 7:return new $(t,e);case 11:return new z(t,e);case 15:return new G(t,e);case 16:return new Z(t,e);case 23:return new K(t,e);case 66:return new J(t,e);case 71:return new Q(t,e);case 113:return new j(t,e);case 202:return new tt(t,e);case 225:return new st(t,e);case 227:return new rt(t,e);case 245:return new et(t,e);case 253:return new it(t,e);default:return console.warn(` Mapper: ${s}`),null}}var a=(s=>(s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.SingleScreenLow=2]="SingleScreenLow",s[s.SingleScreenHigh=3]="SingleScreenHigh",s[s.FourScreen=4]="FourScreen",s))(a||{});class at{prgRom=new Uint8Array(0);chrRom=new Uint8Array(0);prgRam=new Uint8Array(8192);chrRam=new Uint8Array(8192);usesChrRam=!1;header=null;mapper=null;mirrorMode=0;constructor(){this.prgRam.fill(0),this.chrRam.fill(0)}loadRom(t){const e=new Uint8Array(t);if(e[0]!==78||e[1]!==69||e[2]!==83||e[3]!==26)return console.error(" iNES "),!1;const i=e[4],r=e[5],h=e[6],c=e[7];this.header={prgRomSize:i*16384,chrRomSize:r*8192,mapperNumber:h>>4&15|c&240,mirrorMode:h&1?1:0,hasBattery:(h&2)!==0,hasTrainer:(h&4)!==0,isNes2:(c&12)===8},h&8&&(this.header.mirrorMode=4),this.mirrorMode=this.header.mirrorMode;let l=16;return this.header.hasTrainer&&(l+=512),this.prgRom=new Uint8Array(this.header.prgRomSize),this.prgRom.set(e.slice(l,l+this.header.prgRomSize)),l+=this.header.prgRomSize,this.header.chrRomSize>0?(this.chrRom=new Uint8Array(this.header.chrRomSize),this.chrRom.set(e.slice(l,l+this.header.chrRomSize)),this.usesChrRam=!1):(this.chrRam=new Uint8Array(8192),this.chrRam.fill(0),this.usesChrRam=!0),this.mapper=ht(this.header.mapperNumber,i,r),this.mapper?(console.log("ROM :"),console.log(`  PRG ROM: ${this.header.prgRomSize/1024}KB`),console.log(`  CHR ROM: ${this.header.chrRomSize/1024}KB`),console.log(`  Mapper: ${this.header.mapperNumber}`),console.log(`  : ${a[this.header.mirrorMode]}`),!0):(console.error(` Mapper: ${this.header.mapperNumber}`),!1)}cpuRead(t){if(t>=24576&&t<32768)return this.prgRam[t&8191];if(t>=32768&&this.mapper){const e=this.mapper.cpuMapRead(t);if(e!==null)return this.prgRom[e%this.prgRom.length]}return 0}cpuWrite(t,e){if(t>=24576&&t<32768){this.prgRam[t&8191]=e;return}if(t>=32768&&this.mapper){const i=this.mapper.cpuMapWrite(t,e);i?.mirrorMode!==void 0&&(this.mirrorMode=i.mirrorMode)}}ppuRead(t){if(t<8192){if(this.mapper){const e=this.mapper.ppuMapRead(t);if(e!==null)return this.usesChrRam?this.chrRam[e%this.chrRam.length]:this.chrRom[e%this.chrRom.length]}return this.usesChrRam?this.chrRam[t]:this.chrRom[t%this.chrRom.length]}return 0}ppuWrite(t,e){if(t<8192){if(this.mapper){const i=this.mapper.ppuMapWrite(t);if(i!==null&&this.usesChrRam){this.chrRam[i%this.chrRam.length]=e;return}}this.usesChrRam&&(this.chrRam[t]=e)}}getMirrorMode(){return this.mirrorMode}getHeader(){return this.header}reset(){this.mapper?.reset?.()}scanline(){this.mapper?.scanline?.()}cpuClock(){this.mapper?.cpuClock?.()}checkIrq(){return this.mapper&&"getIrqPending"in this.mapper?this.mapper.getIrqPending():!1}saveState(){return{prgRam:Array.from(this.prgRam),chrRam:this.usesChrRam?Array.from(this.chrRam):[],mirrorMode:this.mirrorMode}}loadState(t){this.prgRam.set(t.prgRam),this.usesChrRam&&t.chrRam.length>0&&this.chrRam.set(t.chrRam),this.mirrorMode=t.mirrorMode}}var nt=(s=>(s[s.A=0]="A",s[s.B=1]="B",s[s.Select=2]="Select",s[s.Start=3]="Start",s[s.Up=4]="Up",s[s.Down=5]="Down",s[s.Left=6]="Left",s[s.Right=7]="Right",s))(nt||{});const B={0:128,1:64,2:32,3:16,4:8,5:4,6:2,7:1};class P{buttonState=0;constructor(){this.buttonState=0}setButton(t,e){const i=B[t];e?this.buttonState|=i:this.buttonState&=~i}isButtonPressed(t){return(this.buttonState&B[t])!==0}getState(){return this.buttonState}reset(){this.buttonState=0}}const lt={KeyZ:0,KeyX:1,ShiftRight:2,Enter:3,ArrowUp:4,ArrowDown:5,ArrowLeft:6,ArrowRight:7};class ct{controller;keyMap;constructor(t,e){this.controller=t,this.keyMap=e}handleKeyDown(t){const e=this.keyMap[t.code];e!==void 0&&(this.controller.setButton(e,!0),t.preventDefault())}handleKeyUp(t){const e=this.keyMap[t.code];e!==void 0&&(this.controller.setButton(e,!1),t.preventDefault())}bind(){window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}unbind(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class k{cpu;ppu;apu;bus;cartridge;controller1;controller2;systemClockCounter=0;static SAVE_STATE_VERSION=1;constructor(){this.bus=new H,this.cpu=new M(this.bus),this.ppu=new q,this.apu=new O,this.cartridge=new at,this.controller1=new P,this.controller2=new P,this.bus.connectPpu(this.ppu),this.bus.connectApu(this.apu),this.bus.connectCartridge(this.cartridge),this.bus.connectController(1,this.controller1),this.bus.connectController(2,this.controller2),this.ppu.connectCartridge(this.cartridge),this.apu.setMemoryReader(t=>this.bus.cpuRead(t)),this.apu.setIrqCallback(()=>this.cpu.irq())}loadRom(t){const e=this.cartridge.loadRom(t);return e&&this.reset(),e}reset(){this.cartridge.reset(),this.cpu.reset(),this.ppu.reset(),this.apu.reset(),this.systemClockCounter=0}clock(){this.ppu.clock(),this.systemClockCounter%3===0&&(this.bus.isDmaTransferring()?this.bus.doCycle(this.systemClockCounter%2===1):this.cpu.clock(),this.apu.clock(),this.cartridge.cpuClock()),this.ppu.checkNmi()&&this.cpu.nmi(),this.ppu.checkScanlineIrq()&&this.cartridge.scanline(),this.cartridge.checkIrq()&&this.cpu.irq(),this.systemClockCounter++}frame(){for(this.ppu.frameComplete=!1;!this.ppu.frameComplete;)this.clock()}step(){do this.clock();while(this.cpu.cycles>0)}getFrameBuffer(){return this.ppu.frameBuffer}getState(){return{cpu:{pc:this.cpu.pc,a:this.cpu.a,x:this.cpu.x,y:this.cpu.y,sp:this.cpu.sp,status:this.cpu.status,totalCycles:this.cpu.totalCycles},systemClockCounter:this.systemClockCounter}}saveState(){return{version:k.SAVE_STATE_VERSION,timestamp:Date.now(),cpu:this.cpu.saveState(),ppu:this.ppu.saveState(),apu:this.apu.saveState(),bus:this.bus.saveState(),cartridge:this.cartridge.saveState()}}loadState(t){if(t.version!==k.SAVE_STATE_VERSION)return console.error(`: ${t.version} !== ${k.SAVE_STATE_VERSION}`),!1;try{return this.cpu.loadState(t.cpu),this.ppu.loadState(t.ppu),this.apu.loadState(t.apu),this.bus.loadState(t.bus),this.cartridge.loadState(t.cartridge),!0}catch(e){return console.error(":",e),!1}}exportSaveState(){const t=this.saveState();return JSON.stringify(t)}importSaveState(t){try{const e=JSON.parse(t);return this.loadState(e)}catch(e){return console.error(":",e),!1}}readAudioSamples(t){return this.apu.readSamples(t)}getAvailableAudioSamples(){return this.apu.getAvailableSamples()}setAudioSampleRate(t){this.apu.setSampleRate(t)}}export{nt as C,lt as D,ct as K,k as N};
//# sourceMappingURL=nes-core-CrIEL_gQ.js.map
