import{N as F,K as A,D as O,C as c}from"./nes-core-CQWCNBCb.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();let r=null,u=null,w=null,f=null,m=null,i=null,E=!1,p=null,y=null,h=null;const k=4096;function M(){if(p=document.getElementById("rom-selector"),y=document.getElementById("gameboy-shell"),h=document.getElementById("power-led"),w=document.getElementById("screen"),!w){console.error("æ‰¾ä¸åˆ°ç•«å¸ƒå…ƒç´ ");return}if(f=w.getContext("2d"),!f){console.error("ç„¡æ³•å–å¾— Canvas 2D ä¸Šä¸‹æ–‡");return}m=f.createImageData(256,240),r=new F,new A(r.controller1,O).bind(),x(r.controller1),P(),C(),j(),console.log("H5-NES æ¨¡æ“¬å™¨å·²åˆå§‹åŒ–")}function C(){U(),document.getElementById("rom-file-input")?.addEventListener("change",async t=>{const o=t.target.files?.[0];o&&await I(o)})}async function U(){const e=document.getElementById("rom-list");if(e)try{const o=await fetch("./roms.json");if(!o.ok)throw new Error("ç„¡æ³•è¼‰å…¥ ROM åˆ—è¡¨");const s=await o.json();$(s.roms)}catch(t){console.error("è¼‰å…¥ ROM åˆ—è¡¨å¤±æ•—:",t),e.innerHTML=`
      <div class="rom-error">
        <p>âš ï¸ ç„¡æ³•è¼‰å…¥éŠæˆ²åˆ—è¡¨</p>
        <p>è«‹ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•é¸æ“‡ ROM æª”æ¡ˆ</p>
      </div>
    `}}function $(e){const t=document.getElementById("rom-list");if(!t)return;if(e.length===0){t.innerHTML='<div class="rom-empty">æ²’æœ‰å¯ç”¨çš„éŠæˆ²</div>';return}t.innerHTML=e.map((s,n)=>`
    <button class="rom-item" data-index="${n}" data-file="${encodeURIComponent(s.file)}">
      <span class="rom-icon">ğŸ®</span>
      <span class="rom-name">${s.name}</span>
      <span class="rom-arrow">â–¶</span>
    </button>
  `).join(""),t.querySelectorAll(".rom-item").forEach(s=>{s.addEventListener("click",async()=>{const n=decodeURIComponent(s.dataset.file||"");n&&await T(n)})})}async function T(e){try{const o=await fetch(`./roms/${encodeURIComponent(e)}`);if(!o.ok)throw new Error(`ç„¡æ³•è¼‰å…¥ ROM: ${e}`);const s=await o.arrayBuffer();D(s)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}async function I(e){try{const t=await e.arrayBuffer();D(t)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}function D(e){r&&(r.loadRom(e)?(console.log("ROM è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åŸ·è¡Œ"),_(),i&&(r.setAudioSampleRate(i.sampleRate),v()),h?.classList.add("on"),S()):(console.error("ROM è¼‰å…¥å¤±æ•—"),alert("ç„¡æ³•è¼‰å…¥æ­¤ ROM æª”æ¡ˆ")))}function _(){p&&(p.style.display="none"),y&&(y.style.display="flex")}function R(){b(),h?.classList.remove("on"),p&&(p.style.display="flex"),y&&(y.style.display="none")}function x(e){document.querySelectorAll("[data-btn]").forEach(s=>{const n=s,a=n.dataset.btn;n.addEventListener("touchstart",l=>{l.preventDefault(),d(e,a,!0),n.classList.add("pressed")},{passive:!1}),n.addEventListener("touchend",l=>{l.preventDefault(),d(e,a,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("touchcancel",l=>{l.preventDefault(),d(e,a,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("mousedown",l=>{l.preventDefault(),d(e,a,!0),n.classList.add("pressed")}),n.addEventListener("mouseup",l=>{l.preventDefault(),d(e,a,!1),n.classList.remove("pressed")}),n.addEventListener("mouseleave",()=>{d(e,a,!1),n.classList.remove("pressed")})}),document.getElementById("virtual-controller")?.addEventListener("touchmove",s=>{s.preventDefault()},{passive:!1})}function d(e,t,o){const n={up:c.Up,down:c.Down,left:c.Left,right:c.Right,a:c.A,b:c.B,start:c.Start,select:c.Select}[t];n!==void 0&&e.setButton(n,o)}function P(){document.getElementById("btn-pause")?.addEventListener("click",b),document.getElementById("btn-resume")?.addEventListener("click",S),document.getElementById("btn-reset")?.addEventListener("click",()=>r?.reset()),document.getElementById("btn-select-game")?.addEventListener("click",R)}function j(){document.getElementById("rom-input")?.addEventListener("change",async t=>{const s=t.target.files?.[0];s&&await I(s)})}function S(){u!==null&&cancelAnimationFrame(u),E=!0;const e=1e3/60.0988;let t=performance.now(),o=0;const s=n=>{if(!r||!f||!m||!E)return;const a=n-t;for(t=n,o+=a,o>e*3&&(o=e);o>=e;)r.frame(),o-=e;H(),u=requestAnimationFrame(s)};u=requestAnimationFrame(s)}function b(){E=!1,u!==null&&(cancelAnimationFrame(u),u=null)}function H(){if(!r||!f||!m)return;const e=r.getFrameBuffer(),t=m.data;for(let o=0;o<256*240;o++){const s=e[o],n=o*4;t[n+0]=s>>16&255,t[n+1]=s>>8&255,t[n+2]=s&255,t[n+3]=255}f.putImageData(m,0,0)}async function K(){try{i=new AudioContext({sampleRate:44100}),r&&r.setAudioSampleRate(i.sampleRate);const e=i.createScriptProcessor(k,0,1);e.onaudioprocess=t=>{const o=t.outputBuffer.getChannelData(0);r&&E?r.readAudioSamples(o)===0&&o.fill(0):o.fill(0)},e.connect(i.destination),console.log("éŸ³é »ç³»çµ±å·²åˆå§‹åŒ–ï¼Œå–æ¨£ç‡:",i.sampleRate)}catch(e){console.error("éŸ³é »åˆå§‹åŒ–å¤±æ•—:",e)}}function v(){i&&i.state==="suspended"&&i.resume()}const B="nes_savestate_";function L(e=0){if(!r)return!1;try{const t=r.exportSaveState(),o=`${B}${e}`;return localStorage.setItem(o,t),console.log(`å­˜æª”æˆåŠŸ (Slot ${e})`),!0}catch(t){return console.error("å­˜æª”å¤±æ•—:",t),!1}}function g(e=0){if(!r)return!1;try{const t=`${B}${e}`,o=localStorage.getItem(t);if(!o)return console.log(`Slot ${e} æ²’æœ‰å­˜æª”`),!1;const s=r.importSaveState(o);return s&&console.log(`è®€å–å­˜æª”æˆåŠŸ (Slot ${e})`),s}catch(t){return console.error("è®€å–å­˜æª”å¤±æ•—:",t),!1}}function N(){if(!r)return;const e=r.exportSaveState(),t=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=`nes_savestate_${Date.now()}.json`,s.click(),URL.revokeObjectURL(o)}function q(){document.addEventListener("keydown",e=>{if(e.key==="F5"&&(e.preventDefault(),L(0)),e.key==="F7"&&(e.preventDefault(),g(0)),e.key>="F1"&&e.key<="F4"&&e.shiftKey){e.preventDefault();const t=parseInt(e.key[1]);L(t)}if(e.key>="1"&&e.key<="4"&&e.ctrlKey){e.preventDefault();const t=parseInt(e.key);g(t)}e.key==="Escape"&&R()})}window.nes=null;window.startEmulation=S;window.stopEmulation=b;window.saveState=L;window.loadState=g;window.exportSaveToFile=N;window.showRomSelector=R;document.addEventListener("DOMContentLoaded",async()=>{M(),await K(),q(),window.nes=r,document.addEventListener("click",v,{once:!0}),document.addEventListener("keydown",v,{once:!0}),document.addEventListener("touchstart",v,{once:!0})});
//# sourceMappingURL=index-CYBXAMFt.js.map
