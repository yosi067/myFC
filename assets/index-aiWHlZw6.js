import{N as F,K as x,D as A,C as c}from"./nes-core-DBoBc6L7.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();let a=null,u=null,h=null,m=null,p=null,i=null,L=!1,y=null,v=null,b=null;const O=4096;function C(){if(y=document.getElementById("rom-selector"),v=document.getElementById("gameboy-shell"),b=document.getElementById("power-led"),h=document.getElementById("screen"),!h){console.error("æ‰¾ä¸åˆ°ç•«å¸ƒå…ƒç´ ");return}if(m=h.getContext("2d"),!m){console.error("ç„¡æ³•å–å¾— Canvas 2D ä¸Šä¸‹æ–‡");return}p=m.createImageData(256,240),a=new F,new x(a.controller1,A).bind(),P(a.controller1),j(),M(),q(),console.log("H5-NES æ¨¡æ“¬å™¨å·²åˆå§‹åŒ–")}function M(){T(),document.getElementById("rom-file-input")?.addEventListener("change",async t=>{const o=t.target.files?.[0];o&&await B(o)})}async function T(){const e=document.getElementById("rom-list");if(e)try{const o=await fetch("./roms.json");if(!o.ok)throw new Error("ç„¡æ³•è¼‰å…¥ ROM åˆ—è¡¨");const s=await o.json();U(s.roms)}catch(t){console.error("è¼‰å…¥ ROM åˆ—è¡¨å¤±æ•—:",t),e.innerHTML=`
      <div class="rom-error">
        <p>âš ï¸ ç„¡æ³•è¼‰å…¥éŠæˆ²åˆ—è¡¨</p>
        <p>è«‹ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•é¸æ“‡ ROM æª”æ¡ˆ</p>
      </div>
    `}}function U(e){const t=document.getElementById("rom-list");if(!t)return;if(e.length===0){t.innerHTML='<div class="rom-empty">æ²’æœ‰å¯ç”¨çš„éŠæˆ²</div>';return}t.innerHTML=e.map((s,n)=>`
    <button class="rom-item" data-index="${n}" data-file="${encodeURIComponent(s.file)}">
      <span class="rom-icon">ğŸ®</span>
      <span class="rom-name">${s.name}</span>
      <span class="rom-arrow">â–¶</span>
    </button>
  `).join(""),t.querySelectorAll(".rom-item").forEach(s=>{s.addEventListener("click",async()=>{const n=decodeURIComponent(s.dataset.file||"");n&&await $(n)})})}async function $(e){try{const o=await fetch(`./roms/${encodeURIComponent(e)}`);if(!o.ok)throw new Error(`ç„¡æ³•è¼‰å…¥ ROM: ${e}`);const s=await o.arrayBuffer();D(s)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}async function B(e){try{const t=await e.arrayBuffer();D(t)}catch(t){console.error("è¼‰å…¥ ROM å¤±æ•—:",t),alert("è¼‰å…¥éŠæˆ²å¤±æ•—ï¼Œè«‹é‡è©¦")}}function D(e){a&&(a.loadRom(e)?(console.log("ROM è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åŸ·è¡Œ"),_(),i&&(a.setAudioSampleRate(i.sampleRate),w()),b?.classList.add("on"),S()):(console.error("ROM è¼‰å…¥å¤±æ•—"),alert("ç„¡æ³•è¼‰å…¥æ­¤ ROM æª”æ¡ˆ")))}function _(){y&&(y.style.display="none"),v&&(v.style.display="flex")}function R(){I(),b?.classList.remove("on"),y&&(y.style.display="flex"),v&&(v.style.display="none")}function P(e){document.querySelectorAll("[data-btn]").forEach(s=>{const n=s,r=n.dataset.btn;n.addEventListener("touchstart",l=>{l.preventDefault(),f(e,r,!0),n.classList.add("pressed")},{passive:!1}),n.addEventListener("touchend",l=>{l.preventDefault(),f(e,r,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("touchcancel",l=>{l.preventDefault(),f(e,r,!1),n.classList.remove("pressed")},{passive:!1}),n.addEventListener("mousedown",l=>{l.preventDefault(),f(e,r,!0),n.classList.add("pressed")}),n.addEventListener("mouseup",l=>{l.preventDefault(),f(e,r,!1),n.classList.remove("pressed")}),n.addEventListener("mouseleave",()=>{f(e,r,!1),n.classList.remove("pressed")})}),document.getElementById("virtual-controller")?.addEventListener("touchmove",s=>{s.preventDefault()},{passive:!1})}function f(e,t,o){const n={up:c.Up,down:c.Down,left:c.Left,right:c.Right,a:c.A,b:c.B,start:c.Start,select:c.Select}[t];n!==void 0&&e.setButton(n,o)}function j(){document.getElementById("btn-pause")?.addEventListener("click",I),document.getElementById("btn-resume")?.addEventListener("click",S),document.getElementById("btn-reset")?.addEventListener("click",()=>a?.reset()),document.getElementById("btn-select-game")?.addEventListener("click",R),document.getElementById("btn-save-state")?.addEventListener("click",()=>{E(0)?d("âœ… å­˜æª”æˆåŠŸ"):d("âŒ å­˜æª”å¤±æ•—")}),document.getElementById("btn-load-state")?.addEventListener("click",()=>{g(0)?d("âœ… è®€å–æˆåŠŸ"):d("âŒ æ²’æœ‰å­˜æª”")}),document.getElementById("mobile-save-state")?.addEventListener("click",()=>{E(0)?d("âœ… å­˜æª”æˆåŠŸ"):d("âŒ å­˜æª”å¤±æ•—")}),document.getElementById("mobile-load-state")?.addEventListener("click",()=>{g(0)?d("âœ… è®€å–æˆåŠŸ"):d("âŒ æ²’æœ‰å­˜æª”")})}function q(){document.getElementById("rom-input")?.addEventListener("change",async t=>{const s=t.target.files?.[0];s&&await B(s)})}function S(){u!==null&&cancelAnimationFrame(u),L=!0;const e=1e3/60.0988;let t=performance.now(),o=0;const s=n=>{if(!a||!m||!p||!L)return;const r=n-t;for(t=n,o+=r,o>e*3&&(o=e);o>=e;)a.frame(),o-=e;H(),u=requestAnimationFrame(s)};u=requestAnimationFrame(s)}function I(){L=!1,u!==null&&(cancelAnimationFrame(u),u=null)}function H(){if(!a||!m||!p)return;const e=a.getFrameBuffer(),t=p.data;for(let o=0;o<256*240;o++){const s=e[o],n=o*4;t[n+0]=s>>16&255,t[n+1]=s>>8&255,t[n+2]=s&255,t[n+3]=255}m.putImageData(p,0,0)}async function K(){try{i=new AudioContext({sampleRate:44100}),a&&a.setAudioSampleRate(i.sampleRate);const e=i.createScriptProcessor(O,0,1);e.onaudioprocess=t=>{const o=t.outputBuffer.getChannelData(0);a&&L?a.readAudioSamples(o)===0&&o.fill(0):o.fill(0)},e.connect(i.destination),console.log("éŸ³é »ç³»çµ±å·²åˆå§‹åŒ–ï¼Œå–æ¨£ç‡:",i.sampleRate)}catch(e){console.error("éŸ³é »åˆå§‹åŒ–å¤±æ•—:",e)}}function w(){i&&i.state==="suspended"&&i.resume()}const k="nes_savestate_";function d(e){const t=document.querySelector(".toast-message");t&&t.remove();const o=document.createElement("div");if(o.className="toast-message",o.textContent=e,o.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    animation: toastFade 1.5s ease-out forwards;
  `,!document.querySelector("#toast-style")){const s=document.createElement("style");s.id="toast-style",s.textContent=`
      @keyframes toastFade {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      }
    `,document.head.appendChild(s)}document.body.appendChild(o),setTimeout(()=>o.remove(),1500)}function E(e=0){if(!a)return!1;try{const t=a.exportSaveState(),o=`${k}${e}`;return localStorage.setItem(o,t),console.log(`å­˜æª”æˆåŠŸ (Slot ${e})`),!0}catch(t){return console.error("å­˜æª”å¤±æ•—:",t),!1}}function g(e=0){if(!a)return!1;try{const t=`${k}${e}`,o=localStorage.getItem(t);if(!o)return console.log(`Slot ${e} æ²’æœ‰å­˜æª”`),!1;const s=a.importSaveState(o);return s&&console.log(`è®€å–å­˜æª”æˆåŠŸ (Slot ${e})`),s}catch(t){return console.error("è®€å–å­˜æª”å¤±æ•—:",t),!1}}function N(){if(!a)return;const e=a.exportSaveState(),t=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=`nes_savestate_${Date.now()}.json`,s.click(),URL.revokeObjectURL(o)}function z(){document.addEventListener("keydown",e=>{if(e.key==="F5"&&(e.preventDefault(),E(0)),e.key==="F7"&&(e.preventDefault(),g(0)),e.key>="F1"&&e.key<="F4"&&e.shiftKey){e.preventDefault();const t=parseInt(e.key[1]);E(t)}if(e.key>="1"&&e.key<="4"&&e.ctrlKey){e.preventDefault();const t=parseInt(e.key);g(t)}e.key==="Escape"&&R()})}window.nes=null;window.startEmulation=S;window.stopEmulation=I;window.saveState=E;window.loadState=g;window.exportSaveToFile=N;window.showRomSelector=R;document.addEventListener("DOMContentLoaded",async()=>{C(),await K(),z(),window.nes=a,document.addEventListener("click",w,{once:!0}),document.addEventListener("keydown",w,{once:!0}),document.addEventListener("touchstart",w,{once:!0})});
//# sourceMappingURL=index-aiWHlZw6.js.map
